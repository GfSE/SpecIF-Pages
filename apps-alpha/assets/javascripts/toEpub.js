/*!	Create and save an ePub document using SpecIF data.

	(C)copyright enso managers gmbh(http://enso-managers.de)
	Author: se@enso-managers.de, Berlin
	License: Apache 2.0 (http://www.apache.org/licenses/)
	Dependencies:
	- jszip ( https://github.com/Stuk/jszip ),
	- fileSaver ( https://github.com/eligrey/FileSaver.js ),
	
	ePub Tutorials:
	- https://www.ibm.com/developerworks/xml/tutorials/x-epubtut/index.html
	- http://www.jedisaber.com/eBooks/formatsource.shtml
    
	We appreciate any correction, comment or contribution as Github issue(https://github.com/enso-managers/SpecIF-Tools/issues)

	Limitations:
	- Accepts data-sets according to SpecIF v1.1.
	- All values must be strings, the language must be selected before calling this function, i.e.languageValues as permitted by the schema are not supported!
	- There must only be one revision per class, resource or statement

	ToDo:
	- Embed font with sufficient UTF-8 coverage: http://www.dpc-consulting.org/epub-praxis-fonts-einbinden-und-verwenden/
	- Control pagination: http://www.dpc-consulting.org/epub-praxis-seitenumbruche-steuern-und-elemente-zusammenhalten/
	- move image transformation to export filter
*/
function toEpub(e,t){"use strict";let i=Object.assign({metaFontSize:"90%",metaFontColor:"#0071B9",linkFontColor:"#0071B9",linkNotUnderlined:!1,preferPng:!0,imgPath:"Images/",placeholder:"%h0kusPokus%",txtPath:"sect%h0kusPokus%.xhtml",titlePage:!0},t);return e.files&&e.files.forEach((function(e,t,n){if(e.blob){if(!["image/png","image/jpg","image/jpeg","image/gif"].includes(e.type)){if(["image/svg+xml"].includes(e.type)){if(!i.preferPng)return;if(function(e,t,i){if(e&&t&&i)for(var n=e.length-1;n>-1;n--)if(e[n][t]==i)return e[n]}(n,"title",(o=e.title).substring(0,o.lastIndexOf("."))+".png"))return void console.info("File '"+e.title+"' has a sibling of type PNG")}var o;console.warn("Format of file '"+e.title+"' is not supported by ePub.")}}else console.warn("File '"+e.title+"' content is missing.")})),void function(){let t=makeXhtml(e,Object.assign({},i,{imgPath:"../"+i.imgPath}));return t.fileName=i.fileName||e.title[0].text,t.mimetype="application/epub+zip",t.styles="body { margin-top:2%; margin-right:2%; margin-bottom:2%; margin-left:2%; font-family:Arial,sans-serif; font-size:100%; font-weight: normal; } \ndiv, p { text-align: justify; margin: 0.6em 0em 0em 0em; } \ndiv.title { text-align: center; font-size:200%; margin-top:3.6em } \n.inline-label { font-size: 90%; font-style: italic; margin-top:0.9em; } \np.metaTitle { color: "+i.metaFontColor+"; font-size: "+1.2*i.metaFontSize+"; margin-top:0.9em; } \na { color: "+i.linkFontColor+"; "+(i.linkNotUnderlined?"text-decoration: none; ":"")+"} \ntable.propertyTable, table.statementTable { color: "+i.metaFontColor+"; width:100%; border-top: 1px solid #DDDDDD; border-collapse:collapse; margin: 0.6em 0em 0em 0em; padding: 0;} \ntable.propertyTable td, table.statementTable td { font-size: "+i.metaFontSize+"; border-bottom:  1px solid #DDDDDD; border-collapse:collapse; margin: 0; padding: 0em 0.2em 0em 0.2em; } \ntd.propertyTitle, td.statementTitle { font-style: italic; } \ntable.stdInlineWithBorder, table.doors-table { width:100%; border: 1px solid #DDDDDD; border-collapse:collapse; vertical-align:top; margin: 0; padding: 0; } \ntable.stdInlineWithBorder th, table.stdInlineWithBorder td, table.doors-table th, table.doors-table td { border: 1px solid  #DDDDDD; margin: 0; padding: 0 0.1em 0 0.1em; font-size: 90% } \nh4 { font-family:Arial,sans-serif; font-size:120%; font-weight: normal; margin: 0.9em 0em 0em 0em; page-break-after: avoid; } \nh3 { font-family:Arial,sans-serif; font-size:140%; font-weight: normal; margin: 1.2em 0em 0em 0em; page-break-after: avoid; } \nh2 { font-family:Arial,sans-serif; font-size:160%; font-weight: normal; margin: 1.8em 0em 0em 0em; page-break-after: avoid; } \nh1 { font-family:Arial,sans-serif; font-size:180%; font-weight: normal; margin: 2.4em 0em 0em 0em; page-break-after: avoid; } \n",t.container='<?xml version="1.0" encoding="UTF-8"?><container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container"><rootfiles><rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/></rootfiles></container>',t.content='<?xml version="1.0" encoding="UTF-8"?><package xmlns="http://www.idpf.org/2007/opf" unique-identifier="'+e.id+'" version="2.0" ><metadata xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:opf="http://www.idpf.org/2007/opf"><dc:identifier id="'+e.id+'" opf:scheme="UUID">SpecIF-'+e.id+"</dc:identifier><dc:title>"+e.title[0].text+'</dc:title><dc:creator opf:role="aut">'+("object"==typeof e.createdBy&&"string"==typeof e.createdBy.familyName&&e.createdBy.familyName.length>0?e.createdBy.familyName+", ":"")+("object"==typeof e.createdBy&&"string"==typeof e.createdBy.givenName?e.createdBy.givenName:"")+"</dc:creator><dc:publisher>"+("object"==typeof e.createdBy&&"object"==typeof e.createdBy.org?e.createdBy.org.organizationName:"")+"</dc:publisher><dc:language>en-US</dc:language><dc:rights>"+e.rights.title+'</dc:rights></metadata><manifest><item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml" /><item id="styles" href="Styles/styles.css" media-type="text/css" />',t.sections.forEach((function(e,i){t.content+='<item id="sect'+i+'" href="Text/sect'+i+'.xhtml" media-type="application/xhtml+xml" />'})),t.images.forEach((function(e,n){t.content+='<item id="img'+n+'" href="'+i.imgPath+e.id+'" media-type="'+e.type+'"/>'})),t.content+='</manifest><spine toc="ncx">',t.sections.forEach((function(e,i){t.content+='<itemref idref="sect'+i+'" />'})),t.content+="</spine></package>",t.toc='<?xml version="1.0" encoding="UTF-8"?><ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1"><head><meta name="dtb:uid" content="SpecIF-'+e.id+'"/><meta name="dtb:depth" content="1"/><meta name="dtb:totalPageCount" content="0"/><meta name="dtb:maxPageNumber" content="0"/></head><docTitle><text>'+e.title[0].text+"</text></docTitle><navMap>",t.headings.forEach(((e,i)=>{t.toc+='<navPoint id="tocHd'+i+'" playOrder="'+(i+1)+'"><navLabel><text>'+e.title+'</text></navLabel><content src="Text/sect'+e.section+".xhtml#"+e.id+'"/></navPoint>'})),t.toc+="</navMap></ncx>",void n(t);function n(e){let t=new JSZip;t.file("mimetype",e.mimetype),t.file("META-INF/container.xml",e.container),t.file("OEBPS/content.opf",e.content),t.file("OEBPS/toc.ncx",e.toc),e.styles&&t.file("OEBPS/Styles/styles.css",e.styles),e.sections.forEach((function(e,n){var o;e.styles="../Styles/styles.css",t.file("OEBPS/Text/"+i.txtPath.replace(i.placeholder,n),'<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="'+(o=e).styles+'" /><title>'+o.title+"</title></head><body>"+o.body+"</body></html>")})),e.images.forEach((function(e){t.file("OEBPS/"+i.imgPath+e.id,e.blob)})),t.generateAsync({type:"blob",mimeType:e.mimetype}).then((function(t){saveAs(t,e.fileName),"function"==typeof i.done&&i.done()}),(function(t){"function"==typeof i.fail&&i.fail({status:299,statusText:"Cannot store "+e.fileName})}))}}()}