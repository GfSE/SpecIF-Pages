/*! 
    ReqIF to SpecIF Transformation
    (C)copyright adesso SE, enso managers gmbh (http://enso-managers.de)
    Author: jasmin.droescher@adesso.de, se@enso-managers.de, Berlin
    License and terms of use: Apache 2.0 (http://www.apache.org/licenses/LICENSE-2.0)
    We appreciate any correction, comment or contribution as Github issue (https://github.com/enso-managers/SpecIF-Tools/issues)
*/
function reqif2Specif(e,t){const r=/\sxmlns:(.*?)=\".*?\"/;"object"!=typeof t&&(t={}),t.propType||(t.propType="ReqIF.Category"),t.prefixN||(t.prefixN="N-");const n=(s=e,(new DOMParser).parseFromString(s,"text/xml"));var s,i,a,T,E,l;if(!((a=n).getElementsByTagName("REQ-IF-HEADER").length>0&&a.getElementsByTagName("REQ-IF-CONTENT").length>0))return t.errInvalidReqif||{status:899,statusText:"ReqIF data is invalid"};if((i={status:0,statusText:"ReqIF data is valid",responseType:"object"}).response=function(e){let t=e[0].getAttribute("IDENTIFIER");return{id:t,title:e[0].getElementsByTagName("TITLE")[0]&&e[0].getElementsByTagName("TITLE")[0].innerHTML||t,description:e[0].getElementsByTagName("COMMENT")[0]&&e[0].getElementsByTagName("COMMENT")[0].innerHTML||"",generator:"reqif2specif",$schema:"https://specif.de/v1.0/schema.json",createdAt:e[0].getElementsByTagName("CREATION-TIME")[0].innerHTML}}(n.getElementsByTagName("REQ-IF-HEADER")),i.response.dataTypes=(T=n.getElementsByTagName("DATATYPES")).length<1?[]:Array.from(T[0].children,(function(e){let t={id:e.getAttribute("IDENTIFIER"),type:n(e),title:e.getAttribute("LONG-NAME")||"",description:e.getAttribute("DESC")||"",changedAt:e.getAttribute("LAST-CHANGE")||""};return r("MIN","minInclusive"),r("MAX","maxInclusive"),r("MAX-LENGTH","maxLength"),r("ACCURACY","fractionDigits"),e.childElementCount>0&&(t.values=s(e.children)),t;function r(r,n){let s=e.getAttribute(r);s&&(t[n]=Number(s))}function n(e){return{"DATATYPE-DEFINITION-BOOLEAN":"xs:boolean","DATATYPE-DEFINITION-DATE":"xs:dateTime","DATATYPE-DEFINITION-INTEGER":"xs:integer","DATATYPE-DEFINITION-REAL":"xs:double","DATATYPE-DEFINITION-STRING":"xs:string","DATATYPE-DEFINITION-XHTML":"xhtml","DATATYPE-DEFINITION-ENUMERATION":"xs:enumeration"}[e.nodeName]}function s(e){return Array.from(e[0].children,t);function t(e){return{id:e.getAttribute("IDENTIFIER"),value:e.getAttribute("LONG-NAME")||"&#x00ab;undefined&#x00bb;"}}}})),i.response.propertyClasses=function(e){let r=(n=function(e){return Object.assign({},t(e,"ATTRIBUTE-DEFINITION-STRING"),t(e,"ATTRIBUTE-DEFINITION-XHTML"),t(e,"ATTRIBUTE-DEFINITION-ENUMERATION"),t(e,"ATTRIBUTE-DEFINITION-DATE"),t(e,"ATTRIBUTE-DEFINITION-BOOLEAN"),t(e,"ATTRIBUTE-DEFINITION-INTEGER"),t(e,"ATTRIBUTE-DEFINITION-REAL"));function t(e,t){let r=e.getElementsByTagName(t),n={};return Array.from(r).forEach((e=>{if(n[e.getAttribute("IDENTIFIER")]={title:e.getAttribute("LONG-NAME"),dataType:e.children[0].children[0].innerHTML,changedAt:e.getAttribute("LAST-CHANGE")},"ATTRIBUTE-DEFINITION-ENUMERATION"==t){let t=e.getAttribute("MULTI-VALUED");t&&"true"==t.toLowerCase()&&(n[e.getAttribute("IDENTIFIER")].multiple=!0)}})),n}}(e[0]),Object.entries(n).map((e=>{let t={id:e[0],title:e[1].title,dataType:e[1].dataType,changedAt:e[1].changedAt};return e[1].multiple&&(t.multiple=!0),t})));var n;o(r).length<1&&(i.response.dataTypes.push({id:"DT-ShortString-"+i.response.id,type:"xs:string",title:"String[256]",description:"String with length <=256",maxLength:256,changedAt:(new Date).toISOString()}),r.push({id:"PC-Type-"+i.response.id,dataType:"DT-ShortString-"+i.response.id,title:t.propType,description:"The nature or genre of the resource.",changedAt:(new Date).toISOString()}));return r}(n.getElementsByTagName("SPEC-TYPES")),i.response.resourceClasses=g(n.getElementsByTagName("SPEC-TYPES"),["SPECIFICATION-TYPE","SPEC-OBJECT-TYPE"]),i.response.statementClasses=g(n.getElementsByTagName("SPEC-TYPES"),["SPEC-RELATION-TYPE"]),i.response.resources=u("SPEC-OBJECTS").concat(u("SPECIFICATIONS")),i.response.statements=(E=n.getElementsByTagName("SPEC-RELATIONS")).length<1?[]:Array.from(E[0].children,(function(e){let t={id:e.getAttribute("IDENTIFIER"),subject:e.getElementsByTagName("SOURCE")[0].children[0].innerHTML,object:e.getElementsByTagName("TARGET")[0].children[0].innerHTML,changedAt:e.getAttribute("LAST-CHANGE")};t.class=e.getElementsByTagName("TYPE")[0].children[0].innerHTML;let r=e.getElementsByTagName("VALUES");return t.properties=I(r),t})),i.response.hierarchies=(l=n.getElementsByTagName("SPECIFICATIONS")).length<1?[]:Array.from(l[0].getElementsByTagName("SPECIFICATION"),(function(e){let r=e.getAttribute("IDENTIFIER");return{id:t.prefixN+r,resource:r,changedAt:e.getAttribute("LAST-CHANGE"),nodes:n(e)};function n(e){let t=[];const r=s(e,"CHILDREN")[0];return null!=r&&(t=Array.from(r.children,i)),t;function s(e,t){return Array.from(e.children).filter((e=>e.nodeName==t))}function i(e){let t={id:e.getAttribute("IDENTIFIER"),resource:e.getElementsByTagName("OBJECT")[0].firstElementChild.innerHTML,changedAt:e.getAttribute("LAST-CHANGE")},r=n(e);return r.length>0&&(t.nodes=r),t}}})),!i.response.title){let e,t="";i.response.nodes.forEach((r=>{e=A(i.response.resources,r.resource),t+=(t.length>0?", ":"")+e.title})),i.response.title=t,console.info("Project title assembled from ReqIF SPECIFICATION roots")}return i;function o(e){return e.filter((e=>e.title==t.propType)).map((e=>e.id))}function g(e,t){if(e.length<1)return[];const r=[];return Array.from(e[0].children,(e=>{if(t.includes(e.nodeName)){let t=function(e){const t={id:e.getAttribute("IDENTIFIER"),title:e.getAttribute("LONG-NAME")||e.getAttribute("IDENTIFIER"),changedAt:e.getAttribute("LAST-CHANGE")};e.getAttribute("DESC")&&(t.description=e.getAttribute("DESC"));e.getElementsByTagName("SPEC-ATTRIBUTES")[0]&&(t.propertyClasses=r(e.getElementsByTagName("SPEC-ATTRIBUTES")));return t;function r(e){return Array.from(e[0].children,(e=>e.getAttribute("IDENTIFIER")))}}(e);if("SPECIFICATION-TYPE"==e.nodeName){let e=o(i.response.propertyClasses);e.length>0?Array.isArray(t.propertyClasses)?function(e,t){for(pC of e)if(t.includes(pC.id))return;e.push(t[0])}(t.propertyClasses,e):t.propertyClasses=[e[0]]:console.error("There is no propertyClass ")}r.push(t)}})),r}function u(e){let t=n.getElementsByTagName(e);return t.length<1?[]:Array.from(t[0].children,(function(t){let r={id:t.getAttribute("IDENTIFIER"),title:t.getAttribute("LONG-NAME")||"",changedAt:t.getAttribute("LAST-CHANGE")};r.class=t.getElementsByTagName("TYPE")[0].children[0].innerHTML;let n=t.getElementsByTagName("VALUES");r.properties=I(n),!r.title&&r.properties.length<1&&(r.title=r.id);if("SPECIFICATIONS"==e){let e=o(i.response.propertyClasses),t={class:e[0],value:"ReqIF:HierarchyRoot"},n=function(e){for(var t of r.properties)if(e.includes(t.class))return t}(e);n?n.value=t.value:r.properties.push(t)}return r}))}function I(e){if(e.length<1)return[];let t=[];return Array.from(e[0].children,(e=>{let n=function(e){let t,n,s={};s.class=e.getElementsByTagName("DEFINITION")[0].children[0].innerHTML,e.getAttribute("THE-VALUE")?(s.value=e.getAttribute("THE-VALUE"),t=A(i.response.propertyClasses,s.class),n=A(i.response.dataTypes,t.dataType),"number"==typeof n.maxLength&&n.maxLength<s.value.length&&(console.warn("Truncated ReqIF Attribute with value '"+s.value+"' to the specified maxLength of "+n.maxLength+" characters"),s.value=s.value.substring(0,n.maxLength))):e.getElementsByTagName("THE-VALUE")[0]?s.value=function(e){let t=i(r,e),n=e.replace(r,"");const s=new RegExp(t,"g");return n=n.replace(s,""),n;function i(e,t){let r="";return t=t.replace(e,(function(e,t){return r=t+":",""})),r}}(e.getElementsByTagName("THE-VALUE")[0].innerHTML):e.getElementsByTagName("VALUES")[0]&&(s.value="",Array.from(e.getElementsByTagName("VALUES")[0].children,(e=>{s.value+=(s.value.length>0?",":"")+e.innerHTML})));return s}(e);n.value&&t.push(n)})),t}function A(e,t){if(e&&t){t=t.trim();for(var r=e.length-1;r>-1;r--)if(e[r].id==t)return e[r]}}}