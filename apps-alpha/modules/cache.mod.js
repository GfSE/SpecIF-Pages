"use strict";
/*!	Cache Library for SpecIF data.
    Dependencies: jQuery
    (C)copyright enso managers gmbh (http://enso-managers.de)
    Author: se@enso-managers.de, Berlin
    License and terms of use: Apache 2.0 (http://www.apache.org/licenses/LICENSE-2.0)
    We appreciate any correction, comment or contribution as Github issue (https://github.com/enso-managers/SpecIF-Tools/issues)
*/class CCache{constructor(e){this.dataTypes=[],this.propertyClasses=[],this.resourceClasses=[],this.statementClasses=[],this.resources=[],this.statements=[],this.nodes=[],this.files=[],this.cacheInstances=e.cacheInstances}length(e){return this[app.standards.listName.get(e)].length}has(e,t){let s=this[app.standards.listName.get(e)];for(var r=t.length-1;r>-1;r--)if(LIB.indexByKey(s,t[r])<0)return!1;return!0}put(e,t){if(!Array.isArray(t))throw Error("Programming Error: "+JSON.stringify(t)+" is not a list.");if(t.length<1)return[];function s(e,t){let s=[];for(var r of t)s.push(a(e,r));return s;function a(e,t){if("object"!=typeof t||!t.id)throw Error("Cache 'put' operation with old reference (string instead of object with id)");let s=LIB.indexById(e,t.id);return!!(s<0||e[s].changedAt&&t.changedAt&&new Date(e[s].changedAt)<new Date(t.changedAt))&&(LIB.cacheE(e,t),!0)}}switch(e){case"hierarchy":case"dataType":case"propertyClass":case"resourceClass":case"statementClass":return s(this[app.standards.listName.get(e)],t);case"resource":case"statement":case"file":return this.cacheInstances?s(this[app.standards.listName.get(e)],t):t.map((e=>!1));case"node":let r=[];return t.forEach((e=>{r.push(this.putNode(e))})),r;default:throw Error("Invalid category '"+e+"'.")}}get(e,t){if(t){let r=this[app.standards.listName.get(e)];if(Array.isArray(t)){let a,i=[];for(var s of t)a=LIB.indexByKey(r,s),a>-1?i.push(r[a]):console.error("Cache: Requested element with id '"+s.id+"' of category '"+e+"' not found");return simpleClone(i)}if("function"==typeof t)return simpleClone(r.filter(t));if("all"===t)return["resource","statement","file"].includes(e)&&console.warn("Cache 'get' operation called for 'all' items of category '"+e+"'."),simpleClone(r)}return[]}delete(e,t){switch(e){case"hierarchy":case"dataType":case"propertyClass":case"resourceClass":case"statementClass":return LIB.uncacheL(this[app.standards.listName.get(e)],t);case"resource":case"statement":case"file":return!this.cacheInstances||LIB.uncacheL(this[app.standards.listName.get(e)],t);case"node":return t.forEach((e=>{s(this.nodes,e)})),!0;default:throw Error("Invalid category '"+e+"'.")}function s(e,t){if(Array.isArray(e))for(var r=e.length-1;r>-1;r--){if(e[r].id==t.id||e[r].resource==t.resource){e.splice(r,1);break}s(e[r].nodes,t)}}}putNode(e){return e.predecessor||e.parent||!LIB.iterateSpecifNodes(this.nodes,(t=>t.id!=e.id),(t=>{let s=LIB.indexById(t,e.id);s>-1&&t.splice(s,1,e)}))?(this.delete("node",[LIB.keyOf(e)]),e.predecessor&&LIB.iterateSpecifNodes(this.nodes,(t=>t.id!=e.predecessor),(t=>{let s=LIB.indexById(t,e.predecessor);s>-1&&(delete e.predecessor,t.splice(s+1,0,e))}))?LIB.indexByKey(this.nodes,e)>-1:(!e.parent||!LIB.iterateSpecifNodes(this.nodes,(t=>t.id!=e.parent||(delete e.parent,Array.isArray(t.nodes)?t.nodes.unshift(e):t.nodes=[e],!1))))&&(this.nodes.unshift(e),!0)):LIB.indexByKey(this.nodes,e)>-1}instanceTitleOf(e,t){var s=this;return function(e,t){if("object"!=typeof e)throw Error("First input parameter is invalid");if(!e.properties&&!e.class)return"";let r="";if(e.subject)r=LIB.titleFromProperties(e.properties,s.propertyClasses,t)||LIB.classTitleOf(e.class,s.statementClasses,t);else{let a=LIB.itemByKey(s.resourceClasses,e.class);r=LIB.titleFromProperties(e.properties,s.propertyClasses,{lookupValues:t.lookupValues&&a&&a.isHeading,targetLanguage:t.targetLanguage}),r?t&&t.addIcon&&CONFIG.addIconToInstance&&(r=LIB.addIcon(r,a.icon)):r=(LIB.valueByTitle(e,CONFIG.propClassDesc,s)||"").substring(0,CONFIG.maxTitleLengthTree)}return r.stripHTML()}(e,t)||(t.neverEmpty?e.id:"")}resourcesByTitle(e,t){return e?this.resources.filter((s=>{if("any"==t.targetLanguage){let t=LIB.valuesByTitle(s,CONFIG.titleProperties,this);if(t.length>1&&console.warn("Resource "+s.id+" has more than one title property"),t.length>0)for(var r of t[0])if(r.text==e)return!0;return!1}return this.instanceTitleOf(s,t)==e})):[]}clear(e){if(e)this[app.standards.listName.get(e)].length=0;else for(var t of app.standards.listName.keys())this[app.standards.listName.get(t)].length=0}}class CItem{constructor(e,t,s,r){this.category=e,this.listName=app.standards.listName.get(e),this.isEqual=t,this.isCompatible=s,this.substitute=r}}const noPermission={C:!1,E:!1,R:!1,U:!1,D:!1};class CPermission{constructor(e,t){this.item=e,this.permissionVector={C:t.includes("C"),E:t.includes("E"),R:t.includes("R"),U:t.includes("U"),D:t.includes("D")}}}class CProjectRole{constructor(e){this.permissions=[],this.id=e.toJsId(),this.title=e}setPermissions(e,t){if(e){let s=LIB.indexBy(this.permissions,"item",e);s>-1?this.permissions[s]=new CPermission(e,t):this.permissions.push(new CPermission(e,t))}return this}}class CRoleAssignment{constructor(e,t){this.project="",this.role="",this.project=e,this.role=t}}class CStateImport{constructor(){this.cacheLoaded=!1,this.allValid=!1}}class CProject{constructor(e){this.roles=[],this.myPermissions=[],this.dataTypes=[],this.propertyClasses=[],this.resourceClasses=[],this.statementClasses=[],this.nodes=[],this.sourceFileName="",this.cache=e,this.exporting=!1,this.abortFlag=!1,this.types=[new CItem("dataType",LIB.equalDT,this.compatibleDT.bind(this),this.substituteDT.bind(this)),new CItem("propertyClass",LIB.equalPC,this.compatiblePC.bind(this),this.substitutePC.bind(this)),new CItem("resourceClass",LIB.equalRC,this.compatibleRC.bind(this),this.substituteRC.bind(this)),new CItem("statementClass",LIB.equalSC,this.compatibleSC.bind(this),this.substituteSC.bind(this))]}isLoaded(){return"string"==typeof this.id&&this.id.length>0}setMeta(e){let t={id:e.id,$schema:e.$schema,title:e.title,description:e.description,language:e.language||browser.language,generator:e.generator,generatorVersion:e.generatorVersion,createdAt:e.createdAt,createdBy:e.createdBy};["nodes","resourceClasses","statementClasses","propertyClasses","dataTypes"].forEach((s=>{t[s]=e[s].map((e=>({id:e.id})))}));const s=LIB.languageTextOf(t.title,{targetLanguage:t.language});function r(t){for(var s of e.propertyClasses)if(t==app.ontology.normalize("propertyClass",s.title))return s.id}if(this.exportParams={projectName:s,fileName:s},e.roles)this.roles=e.roles;else{this.roles.push(new CProjectRole("SpecIF:Reader").setPermissions(e.id,"R")),this.roles.push(new CProjectRole("SpecIF:Editor").setPermissions(e.id,"CRUD"));let t=r("ReqIF-WF.SupplierStatus"),s=r("ReqIF-WF.SupplierComment");(t||s)&&(this.roles.push(new CProjectRole("ReqIF-WF.Supplier").setPermissions(e.id,"R").setPermissions(t,"RU").setPermissions(s,"RU")),this.roles.push(new CProjectRole("ReqIF-WF.Customer").setPermissions(e.id,"CRUD").setPermissions(t,"R").setPermissions(s,"R")))}let a=LIB.itemById(this.roles,app.me.myRole(e.id).toJsId());return a&&(this.myPermissions=a.permissions),new Promise(((e,s)=>{app.server?app.server.get("project",t).then((e=>app.server.put("project",Object.assign({},t,{revision:e.response.revision}))),(e=>app.server.put("project",t))).then((s=>{Object.assign(this,t),e(s)})).catch((e=>{console.error(e),s(e)})):(Object.assign(this,t),e({status:0,statusText:"ok"}))}))}getMeta(e){var t=new CSpecIF;return t.id=this.id,t.title=this.title,t.description=function(t){if(t)return e&&e.targetLanguage&&"string"==typeof(t=LIB.languageTextOf(t,e))?(t=t.makeHTML(e),LIB.makeMultiLanguageValue(t)):t}(this.description),t.generator=this.generator,t.generatorVersion=this.generatorVersion,t.createdAt=this.createdAt,t.createdBy=this.createdBy,t}create(e,t){var s=$.Deferred(),r=this,a=0;return this.abortFlag=!1,this.sourceFileName=t.sourceFileName,(new CSpecIF).set(e,t).then((e=>(s.notify(i18n.MsgLoadingTypes,30),this.setMeta(e).then((()=>{a=app.standards.iterateLists(((t,r)=>{this.createItems(t,e[r]).then(i,s.reject)}))}),s.reject))),s.reject),s;function i(){--a<1&&(s.notify(i18n.MsgLoadingFiles,100),r.replacePropertiesWithStatements(t).then((()=>(r.deduplicate(t),r.createFolderWithGlossary(t)))).then((()=>r.createFolderWithUnreferencedResources(t))).then(s.resolve).catch(s.reject))}}read(e){var t=this.getMeta(e);return new Promise(((s,r)=>{this.readItems("hierarchy",this.nodes.filter((e=>!e.id.includes("FolderUnreferencedResources-"))),e).then((s=>(t.nodes=s,this.readItems("resource",LIB.referencedResources(this.cache.resources,s),e)))).then((s=>(t.resources=s,this.readItems("statement",(function(e){return LIB.indexByKey(s,e.subject)>-1&&LIB.indexByKey(s,e.object)>-1}),e)))).then((s=>(t.statements=s,this.readItems("statement",(function(e){let r=t.resources.concat(s);return LIB.indexByKey(r,e.subject)>-1&&LIB.indexByKey(s,e.object)>-1||LIB.indexByKey(s,e.subject)>-1&&LIB.indexByKey(r,e.object)>-1}),e)))).then((s=>{t.statements=t.statements.concat(s);let r=[].concat(this.resourceClasses),a=this.resourceClasses.length;for(var i of t.resources)LIB.cacheE(r,i.class),a<r.length&&(console.warn("Project with id "+this.id+" references a resource with id "+i.id+", which has a resourceClass not memorized in the project."),a=r.length);return this.readItems("resourceClass",r,e)})).then((s=>{t.resourceClasses=s;let r=[].concat(this.statementClasses),a=this.statementClasses.length;for(var i of t.statements)LIB.cacheE(r,i.class),a<r.length&&(console.warn("Project with id "+this.id+" references a statement with id "+i.id+", which has a statementClass not memorized in the project."),a=r.length);return this.readItems("statementClass",r,e)})).then((s=>{t.statementClasses=s;let r=[].concat(this.propertyClasses);for(var a of t.resourceClasses.concat(t.statementClasses))for(var i of a.propertyClasses)LIB.cacheE(r,i);return this.readItems("propertyClass",r,e)})).then((s=>{t.propertyClasses=s;let r=[].concat(this.dataTypes);for(var a of t.propertyClasses)LIB.cacheE(r,a.dataType);return this.readItems("dataType",r,e)})).then((s=>{t.dataTypes=s;let r,a,i=[];for(var o of t.resources)for(var l of o.properties)if(r=LIB.itemByKey(this.cache.propertyClasses,l.class),a=LIB.itemByKey(this.cache.dataTypes,r.dataType),r&&a){if(!a.enumeration&&a.type==XsDataType.String)for(var n of l.values)for(var c of n){let e,t=/data="([^"]+)"/g;for(;null!==(e=t.exec(c.text));)LIB.cacheE(i,e[1])}}else console.error("A property of item '"+o.id+"' references non-existing propertyClass or dataType.");return this.readItems("file",(e=>i.includes(e.title)),e)})).then((s=>(t.files=s,t.get(e)))).then(s).catch(r)}))}typesAreCompatible(e){let t,s;for(var r of this.types){let i=this.cache.get(r.category,this[r.listName]);for(var a of e[r.listName])if(t=LIB.indexById(i,a.id),!(t<0)){if(s=simpleClone(i[t]),a=simpleClone(a),["resourceClass","statementClass"].includes(r.category)&&(a=LIB.getExtendedClasses(e[r.listName],[LIB.keyOf(a)])[0],s=LIB.getExtendedClasses(i,[LIB.keyOf(s)])[0]),a.changedAt==s.changedAt){if(r.isEqual(s,a))continue;return console.warn("Items with same change date are not equal: "+s.id+" and "+a.id+"."),!1}if(a.changedAt>s.changedAt){if(r.isCompatible(a,s,{mode:"include"}))continue;return!1}if(!r.isCompatible(s,a,{mode:"include"}))return!1}}return!0}update(e,t){var s=$.Deferred(),r=this,a=0;return(new CSpecIF).set(e,t).then((e=>{this.typesAreCompatible(e)?(console.info("Update - classes are compatible"),a=app.standards.iterateLists(((t,r)=>{this.updateItems(t,e[r]).then(i,s.reject)}))):s.reject("Automatic update is not possible, because types are incompatible")})).catch(s.reject),s;function i(){--a<1&&(s.notify(i18n.MsgLoadingFiles,100),r.replacePropertiesWithStatements(t).then((()=>(r.deduplicate(t),r.createFolderWithGlossary(t)))).then((()=>r.createFolderWithUnreferencedResources(t))).then(s.resolve).catch(s.reject))}}adopt(e,t){var s=$.Deferred(),r=this,a=this.cache,i=0;return(new CSpecIF).set(e,t).then((e=>{for(var l of r.types)if(Array.isArray(e[l.listName])){let t=[];for(var n of e[l.listName]){let s=LIB.indexById(a[l.listName],n.id);if(s<0)t.push(n);else{let r=!!n.extends,i=r?LIB.getExtendedClasses(a.get(l.category,"all"),[{id:n.id}])[0]:a[l.listName][s],o=r?LIB.getExtendedClasses(e[l.listName],[{id:n.id}])[0]:n;if(!l.isCompatible(i,o,{mode:"include"})){let s=LIB.keyOf(n);n.id+="-"+simpleHash((new Date).toISOString()),l.substitute(e,n,s),t.push(n),console.info("When adopting a project with id "+e.id+", a class with same id and incompatible content has been encountered: "+s.id+"; it has been saved with a new identifier "+n.id+".")}}}console.info(e[l.listName].length-t.length+" "+l.listName+" adopted and "+t.length+" added."),i++,r.createItems(l.category,t).then(o,s.reject)}if(Array.isArray(e.resources)){let l=[];e.resources.forEach((s=>{let i=LIB.itemByKey(a.resources,s);if(i&&r.equalR(i,s))return;let o=Object.assign({},t,{targetLanguage:r.language||e.language});if(LIB.hasResClass(s,app.ontology.modelElementClasses.concat(CONFIG.diagramClasses),e)&&!LIB.hasType(s,CONFIG.excludedFromDeduplication,e,t)&&(i=r.cache.resourcesByTitle(LIB.titleFromProperties(s.properties,e.propertyClasses,o),o)[0],i&&!LIB.hasType(i,CONFIG.excludedFromDeduplication,a,t)&&LIB.classTitleOf(s.class,e.resourceClasses)==LIB.classTitleOf(i.class,a.resourceClasses)))return r.substituteR(e,i,s),Array.isArray(i.alternativeIds)||(i.alternativeIds=[]),void LIB.cacheE(i.alternativeIds,{id:s.id,revision:s.revision,project:e.id});if(LIB.duplicateId(a,s.id)){let t=LIB.genID(CONFIG.prefixR);r.substituteR(e,{id:t},s),s.id=t}l.push(s)})),console.info(e.resources.length-l.length+" resources adopted and "+l.length+" added."),i++,r.createItems("resource",l).then(o,s.reject)}if(Array.isArray(e.statements)){let t=[];e.statements.forEach((e=>{let s=LIB.itemByKey(a.statements,e);s&&r.equalS(s,e)||t.push(e)})),console.info(e.statements.length-t.length+" statements adopted and "+t.length+" added."),i++,r.createItems("statement",t).then(o,s.reject)}if(i++,r.createItems("hierarchy",e.nodes).then(o,s.reject),Array.isArray(e.files)){let t=[];e.files.forEach((e=>{let s=LIB.itemByKey(a.files,e);s&&r.equalF(s,e)||t.push(e)})),console.info(e.files.length-t.length+" files adopted and "+t.length+" added."),i++,r.createItems("file",t).then(o,s.reject)}}),s.reject),s;function o(){--i<1&&r.replacePropertiesWithStatements(t).then((()=>(r.deduplicate(t),r.createFolderWithResourcesByType(t)))).then((()=>r.createFolderWithGlossary(t))).then((()=>r.createFolderWithUnreferencedResources(t))).then(s.resolve).catch(s.reject)}}memorizeScope(e,t){switch(e){case"dataType":case"propertyClass":case"resourceClass":case"statementClass":LIB.cacheE(this[app.standards.listName.get(e)],LIB.makeKey(t.id));break;case"hierarchy":case"node":LIB.cacheE(this.nodes,t.predecessor?{id:t.id,predecessor:LIB.makeKey(t.predecessor)}:LIB.makeKey(t.id))}}createItems(e,t){let s=this;return new Promise((r=>{s.cache.put(e,t).forEach(((r,a)=>{r&&s.memorizeScope(e,t[a])})),r()}))}readItems(e,t,s){s||(s={reload:!1,timelag:10});let r=this;return new Promise((a=>{if("all"==t&&["resource","statement","file","node"].includes(e))throw Error("Don't request 'all' model element instances, since the result list can be very long!");setTimeout((()=>{let i=[],o="all"==t?this[app.standards.listName.get(e)]:t;s.extendClasses&&["resourceClass","statementClass"].includes(e)?i=LIB.getExtendedClasses(r.cache.get(e,"all"),o):(i=this.cache.get(e,o),s.showEmptyProperties&&["resource","statement"].includes(e)&&i.forEach((e=>{e.properties=function(e){if(e.properties){let t,s=[];e.properties.forEach((r=>{t=r.class.id,s.includes(t)?console.warn("The property class "+t+" of element "+e.id+" is occurring more than once."):s.push(t)}))}let t,s=[],a=e.subject?r.cache.get("statementClass","all"):r.cache.get("resourceClass","all"),i=LIB.getExtendedClasses(a,[e.class]);return t=r.cache.get("propertyClass",i[0].propertyClasses),t.forEach((t=>{if(CONFIG.hiddenProperties.includes(t.title))return;let r=o(e.properties,t);s.push(r??{class:LIB.makeKey(t.id),values:[]})})),s;function o(e,t){if(e&&t)for(var s of e)if(LIB.references(s.class,t))return s}}(e)}))),a(i)}),s.timelag)}))}updateItems(e,t){let s=this;return new Promise((r=>{switch(s.cache.put(e,t).forEach(((r,a)=>{r&&s.memorizeScope(e,t[a])})),e){case"hierarchy":case"node":s.nodes=s.cache.get("hierarchy","all").map((e=>LIB.makeKey(e.id)))}r()}))}deleteItems(e,t){return new Promise(((s,r)=>{switch(e){case"dataType":case"propertyClass":case"resourceClass":case"statementClass":case"hierarchy":case"node":let s=app.standards.listName.get("node"==e?"hierarchy":e);for(var a of t)LIB.uncacheE(this[s],{id:a.id});default:if(this.cache.delete(e,t))break;return void r(new resultMsg({status:999,statusText:"One or more items of "+e+" not found and thus not deleted."}))}s()}))}makeEmptyResource(e){return new Promise(((t,s)=>{var r;this.readItems("resourceClass",[LIB.keyOf(e)],{extendClasses:!0,reload:!0}).then((e=>(r={id:LIB.genID(CONFIG.prefixR),class:LIB.makeKey(e[0].id),properties:[],changedAt:(new Date).toISOString()},this.readItems("propertyClass",e[0].propertyClasses,{reload:!0})))).then((e=>{r.properties=LIB.forAll(e,LIB.createProp),t(r)})).catch(s)}))}aDiagramWithoutShowsStatementsForEdges(){let e,t,s=!0;return LIB.iterateSpecifNodes(this.cache.get("hierarchy",this.nodes),(r=>(e=this.cache.get("resource",[r.resource])[0],t=!CONFIG.diagramClasses.includes(LIB.classTitleOf(e.class,this.cache.resourceClasses)),s=s&&t,t||LIB.hasType(e,CONFIG.diagramTypesHavingShowsStatementsForEdges,this.cache))))??s}updateWithOntology(e,t){if(t&&t.noUpdateWithOntology)return;let s=[];const r={ctg:"enumeratedValue",oCtg:"propertyValue",list:e.dataTypes,fn:this.substituteEnum.bind(this)};r.list.forEach((t=>{t.type=t.type.replace(/^xs:/,"xsd:"),t.enumeration?.forEach((a=>{let i=LIB.displayValueOf(a.value),o=app.ontology.getTermResource(r.oCtg,i,{lifeCycles:["SpecIF:LifecycleStatusReleased","SpecIF:LifecycleStatusEquivalent"]});if(o){if(s.includes(i))return void console.warn("The ontology term "+i+" has already been used to update another identifier; "+t.id+" is not replaced to avoid duplicates.");console.info("Replacing "+r.ctg+" id "+a.id+" with ontology term "+i),s.push(i),r.fn(e,LIB.makeKey(i),a),a.id=i,a.value=app.ontology.getLocalTerms(o)}}))})),[{ctg:"dataType",oCtg:"propertyClass",list:e.dataTypes,postfix:"-Value",fn:this.substituteDT.bind(this)},{ctg:"propertyClass",oCtg:"propertyClass",list:e.propertyClasses,postfix:"",fn:this.substitutePC.bind(this)},{ctg:"resourceClass",oCtg:"resourceClass",list:e.resourceClasses,postfix:"",fn:this.substituteRC.bind(this)},{ctg:"statementClass",oCtg:"statementClass",list:e.statementClasses,postfix:"",fn:this.substituteSC.bind(this)}].forEach((t=>{t.list.forEach((r=>{let a=r.title,i=app.ontology.getTermResource(t.oCtg,a,{lifeCycles:["SpecIF:LifecycleStatusReleased","SpecIF:LifecycleStatusEquivalent"]});if(i){if(a+=t.postfix,s.includes(a))return void console.warn("The ontology term "+a+" has already been used to update another identifier; "+r.id+" is not replaced to avoid duplicates.");console.info("Replacing "+t.ctg+" "+r.id+" with ontology term "+a),s.push(a),t.fn(e,LIB.makeKey(a),LIB.keyOf(r)),r.id=a,r.title=app.ontology.getLocalTerms(i),r.description=app.ontology.getDescriptions(i)}}))}))}replacePropertiesWithStatements(e){let t=this,s=this.cache;return new Promise(((r,a)=>{if("object"!=typeof e||!Array.isArray(e.replacePropertiesWithStatements))return void r();const i=app.ontology.getTerms("statementClass",{lifeCycles:["SpecIF:LifecycleStatusReleased","SpecIF:LifecycleStatusEquivalent"]});let o=LIB.referencedResources(s.resources,s.nodes),l=[],n=[];if(o.forEach((t=>{for(let r=t.properties.length-1;r>-1;r--){let a=LIB.classTitleOf(t.properties[r].class,s.propertyClasses),c=LIB.indexBy(i,"title",a);if(c>-1){let d=LIB.displayValueOf(t.properties[r].values[0],{targetLanguage:"default"}),p=d.split(",");p.length<2&&(p=d.split(";")),p=p.map((e=>{let t=RE.contentInQuotes.exec(e);return t&&t.length>2?t[1]||t[2]:e.trim()})),o.filter((r=>{let a=LIB.valuesByTitle(r,e.replacePropertiesWithStatements,s);return function(){for(let e of a)if(p.includes(LIB.displayValueOf(e,{targetLanguage:"default"}))&&r.id!=t.id)return!0;return!1}()})).forEach((e=>{LIB.cacheE(l,a),LIB.cacheE(n,{id:CONFIG.prefixS+simpleHash(t.id+i[c].title+e.id),class:LIB.makeKey(i[c].id),subject:LIB.makeKey(t.id),object:LIB.makeKey(e.id),changedAt:(new Date).toISOString()})}))}}})),n.length<1)return void r();let c=app.ontology.generateSpecifClasses({terms:l,lifeCycles:["SpecIF:LifecycleStatusEquivalent"],referencesWithoutRevision:!0});c.statements=n.filter((e=>LIB.indexBy(c.statementClasses,"id",e.class.id)>-1)),t.adopt(c,{noCheck:!0,deduplicate:!0}).done(r).fail(a)}))}deduplicate(e){if(!e||!e.deduplicate)return;let t,s=this,r=this.cache,a=r.get("resourceClass","all").concat(r.get("statementClass","all"));function i(e,t){for(var s of a)if(LIB.indexById(s.propertyClasses,e.id)>-1&&LIB.indexById(s.propertyClasses,t.id)>-1)return!1;return!0}function o(e,t,a,i){t(r,a,i),console.info(e+" with id="+i.id+" has been removed because it is a duplicate of id="+a.id),s.deleteItems(e,[LIB.keyOf(i)])}this.types.forEach((e=>{t=r.get(e.category,"all");for(let s=t.length-1;s>0;s--)for(let r=0;r<s;r++)if(e.isEqual(t[r],t[s])&&("propertyClass"!=e.category||i(t[r],t[s]))){o(e.category,e.substitute,t[r],t[s]);break}})),t=r.get("resource","all");for(let s=t.length-1;s>0;s--)for(let a=0;a<s;a++)if(app.ontology.modelElementClasses.concat(CONFIG.diagramClasses).includes(LIB.classTitleOf(t[a].class,r.resourceClasses))&&this.equalR(t[a],t[s])&&!LIB.hasType(t[a],CONFIG.excludedFromDeduplication,r,e)&&!LIB.hasType(t[s],CONFIG.excludedFromDeduplication,r,e)){o("resource",this.substituteR.bind(this),t[a],t[s]);break}t=r.get("statement","all");for(let e=t.length-1;e>0;e--)for(let s=0;s<e;s++)if(this.equalS(t[s],t[e])){o("statement",(()=>{}),t[s],t[e]);break}}createFolderWithResourcesByType(e){let t=this,s=this.cache;const r=[{type:CONFIG.resClassProcess,flag:"collectProcesses",folder:CONFIG.resClassProcesses,folderNamePrefix:"FolderProcesses-"}];return new Promise(((a,i)=>{if("object"!=typeof e)return void a();let o=simpleHash(t.id),l=(new Date).toISOString();return void r.forEach((r=>{if(!e[r.flag])return void a();let d=[],p=[];LIB.iterateSpecifNodes(s.get("hierarchy",t.nodes),(e=>{let t=s.get("resource",[e.resource])[0],a=LIB.valuesByTitle(t,[CONFIG.propClassType],s);if(a.length>0){let s=LIB.languageTextOf(a[0],{targetLanguage:"default"});s==r.folder&&d.push(e),s==r.type&&function(e,t){for(var s=e.length-1;s>-1;s--)if(e[s].r.id==t.id)return!1;return!0}(p,t)&&p.push({n:e,r:t})}return!0})),p.length>0?t.deleteItems("node",d.slice(1)).then((()=>{if(LIB.sortBy(p,(e=>LIB.titleFromProperties(e.r.properties,s.propertyClasses,{targetLanguage:t.language}))),d.length>0){let e=d[0];e.nodes=n(p),t.updateItems("node",[e]).then(a,i)}else{let s=Object.assign(app.ontology.generateSpecifClasses({terms:[CONFIG.resClassFolder],referencesWithoutRevision:!0}),{resources:(e=r.folderNamePrefix+o,u=CONFIG.resClassProcesses,[{id:e,class:LIB.makeKey("RC-Folder"),properties:[{class:LIB.makeKey("PC-Name"),values:[LIB.makeMultiLanguageValue(u)]},{class:LIB.makeKey("PC-Type"),values:[LIB.makeMultiLanguageValue(h||u)]}],changedAt:l}]),nodes:c(r,p)});t.adopt(s,{noCheck:!0,deduplicate:!0}).done(a).fail(i)}var e,u,h})):t.deleteItems("node",d).then(a,i)}));function n(e){return e.map((e=>e.n))}function c(e,t){return[{id:CONFIG.prefixH+e.folderNamePrefix+o,resource:{id:e.folderNamePrefix+o},nodes:n(t),changedAt:l}]}}))}createFolderWithUnreferencedResources(e){let t=this,s=this.cache;return new Promise(((r,a)=>{if("object"!=typeof e||!e.addUnreferencedResources)return void r();let i=[],o=s.get("resource","all"),l=simpleHash(t.id),n=(new Date).toISOString(),c=s.get("hierarchy",t.nodes).filter((t=>{let r=LIB.indexByKey(o,t.resource);if(r>-1)return!LIB.hasType(o[r],[CONFIG.resClassUnreferencedResources],s,e)||(i.push(t),o.splice(r,1),!1);throw Error("Node "+t.id+" references a resource "+t.resource.id+" which is not found.")}));if(LIB.iterateSpecifNodes(c,(e=>{let t=LIB.indexByKey(o,e.resource);return t>-1&&o.splice(t,1),!0})),o=o.filter((e=>!e.id.includes("FolderUnreferencedResources-"))),o.length>0)if(i.length>0)t.deleteItems("node",i).then((()=>t.createItems("node",d(o)))).then(r).catch(a);else{let e=Object.assign(app.ontology.generateSpecifClasses({terms:[CONFIG.resClassFolder],referencesWithoutRevision:!0}),{resources:[{id:"FolderUnreferencedResources-"+l,class:LIB.makeKey("RC-Folder"),properties:[{class:LIB.makeKey("PC-Name"),values:[LIB.makeMultiLanguageValue(CONFIG.resClassUnreferencedResources)]},{class:LIB.makeKey("PC-Type"),values:[LIB.makeMultiLanguageValue(CONFIG.resClassUnreferencedResources)]}],changedAt:n}],nodes:d(o)});t.adopt(e,{noCheck:!0,deduplicate:!0}).done(r).fail(a)}else i.length>0?t.deleteItems("node",i).then(r,a):r();return;function d(e){return LIB.sortBy(e,(e=>LIB.titleFromProperties(e.properties,s.propertyClasses,{targetLanguage:t.language}))),[{id:"H-FolderUnreferencedResources-"+l,predecessor:c.length>0?c[c.length-1].id:void 0,resource:LIB.makeKey("FolderUnreferencedResources-"+l),nodes:e.map((e=>({id:CONFIG.prefixN+e.id,resource:LIB.keyOf(e),changedAt:n}))),changedAt:n}]}}))}createFolderWithGlossary(e){let t=this,s=this.cache;return new Promise(((r,a)=>{if("object"!=typeof e||!e.addGlossary)return void r();let i,o=[],l=[],n=[],c=simpleHash(t.id),d=(new Date).toISOString(),p=s.get("hierarchy",t.nodes).filter((t=>{let r=s.get("resource",[t.resource])[0];return r&&!LIB.hasType(r,[CONFIG.resClassGlossary,CONFIG.resClassUnreferencedResources],s,e)&&(i=t),r&&!LIB.hasType(r,[CONFIG.resClassUnreferencedResources],s,e)}));return LIB.iterateSpecifNodes(p,(t=>{let r=s.get("resource",[t.resource])[0];var a;return LIB.hasType(r,[CONFIG.resClassGlossary],s,e)&&(o.push(t),l.push(t.resource)),a=r,(LIB.hasResClass(a,CONFIG.diagramClasses,s)||LIB.hasType(a,CONFIG.diagramClasses,s,e)||s.get("statement",(e=>LIB.classTitleOf(e.class,s.statementClasses)==CONFIG.staClassShows&&LIB.references(e.subject,a))).length>0)&&n.push(r),!0})),void(n.length>0?t.deleteItems("node",o).then((()=>t.deleteItems("resource",l))).then((()=>{let e=Object.assign(app.ontology.generateSpecifClasses({terms:[CONFIG.resClassFolder],referencesWithoutRevision:!0}),{resources:u(),nodes:h(i)});t.adopt(e,{noCheck:!0,deduplicate:!0}).done(r).fail(a)})).catch(a):t.deleteItems("node",o).then((()=>t.deleteItems("resource",l))).then(r).catch(a));function u(){let e=app.ontology.getTermResource("resourceClass",CONFIG.resClassGlossary,{eligibleOnly:!0});if(e){return[{id:"FolderGlossary-"+c,class:LIB.makeKey("RC-Folder"),properties:[{class:LIB.makeKey("PC-Name"),values:LIB.valuesByTitle(e,["SpecIF:LocalTerm"],app.ontology.data)},{class:LIB.makeKey("PC-Type"),values:[LIB.makeMultiLanguageValue(CONFIG.resClassGlossary)]}],changedAt:d}]}return console.warn("Ontology has no term '"+CONFIG.resClassGlossary+"'"),[]}function h(e){return function(e){let r=s.get("statement",(e=>LIB.classTitleOf(e.class,s.statementClasses)==CONFIG.staClassShows&&LIB.indexByKey(n,e.subject)>-1)),a=s.get("resource",(e=>LIB.referenceIndexBy(r,"object",e)>-1));return LIB.sortBy(a,(e=>LIB.titleFromProperties(e.properties,s.propertyClasses,{targetLanguage:t.language}))),a.forEach((t=>{e.nodes.push({id:CONFIG.prefixN+simpleHash(t.id+"-gen"),resource:LIB.keyOf(t),changedAt:d})})),[e]}({id:CONFIG.prefixN+"FolderGlossary-"+c,predecessor:e?e.id:void 0,resource:LIB.makeKey("FolderGlossary-"+c),nodes:[],changedAt:d})}}))}readStatementsOf(e,t){"object"!=typeof t&&(t={asSubject:!0,asObject:!0});let s,r,a=this.cache;return new Promise(((i,o)=>{this.readItems("statementClass",this.statementClasses).then((e=>(s=e,this.readItems("statement",(e=>LIB.classTitleOf(e.class,a.statementClasses)==CONFIG.staClassShows&&LIB.isReferencedByHierarchy(e.subject)))))).then((s=>(r=s,this.readItems("statement",(s=>t.asSubject&&e.id==s.subject.id||t.asObject&&e.id==s.object.id))))).then((a=>{i(a.filter((a=>{let i=LIB.itemByKey(s,a.class),o=LIB.titleOf(i);return o?(t.dontCheckStatementVisibility||!Array.isArray(i.instantiation)||i.instantiation.includes(SpecifInstantiation.User)||CONFIG.staClassShows==o||LIB.referenceIndexBy(r,"object",a)>-1)&&(t.showComments?CONFIG.staClassCommentRefersTo==o&&LIB.isReferencedByHierarchy(a.object):CONFIG.staClassCommentRefersTo!=o&&!CONFIG.hiddenStatements.includes(o)&&LIB.isReferencedByHierarchy(a.subject)&&LIB.isReferencedByHierarchy(a.object)):(console.error("When searching for statements of resource '"+e.id+"' no title was found for statement '"+a.id+"'."),!1)})))})).catch(o)}))}renderExportOptions(e){var t="<div>"+(["specif","html"].includes(e)?"":makeTextField("&#x200b;"+i18n.LblProjectName,"specifClasses"==e?"SpecIF Classes":this.exportParams.projectName,{typ:"line"}))+makeTextField("&#x200b;"+i18n.LblFileName,"specifClasses"==e?"SpecIF-Classes":this.exportParams.fileName,{typ:"line"});switch(e){case"epub":case"xhtml":case"oxml":t+=makeCheckboxField(i18n.LblOptions,[{title:i18n.elementsWithIcons,id:"elementsWithIcons",checked:!0},{title:i18n.withStatements,id:"withStatements",checked:!1},{title:i18n.withOtherProperties,id:"withOtherProperties",checked:!1},{title:i18n.showEmptyProperties,id:"showEmptyProperties",checked:CONFIG.showEmptyProperties}]);break;case"html":app.title==i18n.LblEditor&&(t+=makeRadioField(app.ontology.localize("SpecIF:Permissions",{targetLanguage:browser.language}),this.roles.map(((e,t)=>({title:i18n.lookup("MsgForRole")+" '"+app.ontology.localize(e.title,{targetLanguage:browser.language})+"'",id:e.title,checked:t<1})))));break;case"specifClasses":let e=LIB.enumeratedValuesOf(LIB.makeKey("DT-Domain"));e.length>0&&(t+=makeCheckboxField(i18n.LblOptions,e.map((e=>({title:app.ontology.localize(e,{targetLanguage:browser.language}),id:e.toJsId(),checked:!1})))))}return t+="</div>"}hasOntology(){let e=this.cache.get("hierarchy",this.nodes);for(var t of e){let e=this.cache.get("resource",[t.resource]);if(e.length>0&&LIB.hasType(e[0],[CONFIG.resClassOntology],this.cache))return!0}return!1}chooseFormatThenExport(){if(this.exporting)return;$("#exportFormat").remove();const e=app.title==i18n.LblEditor?[{title:"SpecIF v"+CONFIG.specifVersion,id:"specif",checked:!0},{title:"HTML with embedded SpecIF v"+CONFIG.specifVersion,id:"html"},{title:"PIG (JSON-LD) <em>(experimental)</em>",id:"pig-jsonld"},{title:"RDF (Turtle) <em>(experimental)</em>",id:"rdf-ttl"},{title:"ReqIF v1.0",id:"reqif"},{title:"MS Excel® <em>(experimental)</em>",id:"xlsx"},{title:"Plain HTML",id:"xhtml"},{title:"ePub v2",id:"epub"},{title:"MS Word® (Open XML)",id:"oxml"}]:"DDP Schema to SpecIF"==app.title?[{title:"SpecIF v"+CONFIG.specifVersion,id:"specif",checked:!0},{title:"PIG (JSON-LD) <em>(experimental)</em>",id:"pig-jsonld"},{title:"RDF (Turtle) <em>(experimental)</em>",id:"rdf-ttl"}]:[{title:"HTML with embedded SpecIF v"+CONFIG.specifVersion,id:"html",checked:!0}];moduleManager.isReady("ioOntology")&&this.hasOntology()&&e.splice(2,0,{title:"SpecIF Class Definitions",id:"specifClasses"});let t=$('<div class="modal fade" id="exportFormat" tabindex="-1" ><div class="modal-dialog modal-lg" ><div class="modal-content" ><div class="modal-header bg-success text-white" ><h5 class="modal-title" >'+i18n.LblExport+'</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" > </button></div><div class="modal-body" >'+makeRadioField(i18n.LblFormat,e,{handle:"app.projects.selected.exportFormatClicked()"})+'<div id="expOptions" class="mt-1">'+this.renderExportOptions(app.title==i18n.LblEditor?"specif":"html")+'</div></div><div class="modal-footer" ><button type="button" class="btn btn-secondary" data-bs-dismiss="modal" >'+i18n.BtnCancel+'</button><button type="button" class="btn btn-success" onclick="app.projects.selected.getFormatAndOptionsThenExport()">'+i18n.BtnExport+"</button></div></div></div></div>");this.modalExport=new bootstrap.Modal(t),this.modalExport.show()}exportFormatClicked(){document.getElementById("expOptions").innerHTML=this.renderExportOptions(radioValue(i18n.LblFormat))}getFormatAndOptionsThenExport(){let e=this;app.busy.set(),message.show(i18n.MsgBrowserSaving,{severity:"success",duration:CONFIG.messageDisplayTimeShort});let t=textValue("&#x200b;"+i18n.LblProjectName);this.exportParams.fileName=textValue("&#x200b;"+i18n.LblFileName)||t||this.id,t&&(this.exportParams.projectName=t);let s={sourceFileName:this.sourceFileName,projectName:this.exportParams.projectName,fileName:this.exportParams.fileName,format:radioValue(i18n.LblFormat),role:"",domains:[]};switch(s.format){case"html":app.title==i18n.LblEditor?s.role=radioValue(app.ontology.localize("SpecIF:Permissions",{targetLanguage:browser.language})):s.role=window.role||"SpecIF:Supplier";break;case"specifClasses":let e=checkboxValues(i18n.LblOptions);s.domains=LIB.enumeratedValuesOf(LIB.makeKey("DT-Domain")).filter((t=>e.includes(t.toJsId())));break;default:checkboxValues(i18n.LblOptions).forEach((e=>{s[e]=!0}))}this.exportAs(s).then((()=>{app.busy.reset()}),(t=>{e.exporting=!1,app.busy.reset(),message.show(t)})),this.modalExport.hide()}exportAs(e){var t=this;return e||(e={}),e.format||(e.format="specif"),new Promise(((s,r)=>{if(t.exporting)r(new resultMsg({status:999,statusText:"Export in process, please wait a little while."}));else switch(t.exporting=!0,e.format){case"rdf-ttl":case"reqif":case"specif":case"rdf-jsonld":case"pig-jsonld":case"html":case"specifClasses":!function(e){switch(e.allDiagramsAsImage=["html","rdf-ttl","rdf-jsonld","pig-jsonld","reqif"].includes(e.format),e.preferPng=["reqif"].includes(e.format),e.format){case"specif":case"html":e.lookupTitles=!1,e.lookupValues=!1;break;case"pig-jsonld":e.lookupTitles=!0,e.lookupValues=!1,e.targetNamespaces=["pig:"],e.makeHTML=!0,e.linkifyURLs=!0,e.createHierarchyRootIfMissing=!0,e.revisionDate=(new Date).toISOString();break;case"rdf-jsonld":case"rdf-ttl":e.lookupTitles=!0,e.lookupValues=!1,e.targetNamespaces=["pig:","rdf:","rdfs:"],e.makeHTML=!0,e.linkifyURLs=!0,e.createHierarchyRootIfMissing=!0,e.revisionDate=(new Date).toISOString();break;case"reqif":e.lookupTitles=!0,e.targetLanguage=e.targetLanguage||t.language,e.targetNamespaces=["ReqIF."],e.makeHTML=!0,e.linkifyURLs=!0,e.createHierarchyRootIfMissing=!0,e.revisionDate=(new Date).toISOString();break;case"specifClasses":break;default:throw new Error("Programming error: Invalid format selector on export.")}t.read(e).then((a=>{let i=e.fileName;if(["html","reqif","rdf-ttl"].includes(e.format)&&(a.title=LIB.makeMultiLanguageValue(e.projectName)),e.targetLanguage&&(a.language=e.targetLanguage),"html"==e.format)return e.cdn=window.cdn||window.location.href.substring(0,window.location.href.lastIndexOf("/")+1),void app.specif2html(a,e).then((r=>{let a=new Blob([r],{type:"text/html; charset=utf-8"});saveAs(a,i+("SpecIF:Reader"==e.role?"":"."+app.ontology.localize(e.role,{targetLanguage:browser.language}))+".specif.html"),t.exporting=!1,s()}),(e=>{t.exporting=!1,r(e)}));let o,l,n=new JSZip,c="application/zip";if(a.files)for(var d of a.files)n.file(d.title,d.blob),delete d.blob;switch(e.format){case"specif":i+=".specif",l=i+".zip",o=JSON.stringify(a);break;case"specifClasses":if(i+=".specif",l=i+".zip",!Array.isArray(e.domains)||e.domains.length<1)return void r(new resultMsg({status:999,statusText:"No domain selected, so no classes will be generated."}));o=JSON.stringify(new COntology(a).generateSpecifClasses(e));break;case"pig-jsonld":e.baseURI="https://product-information-graph.org/examples/",i+=".pig.jsonld",l=i+".zip",t.updateWithOntology(a,e),o=app.ioPigJsonld.fromSpecif(a,e);break;case"rdf-jsonld":e.baseURI="https://product-information-graph.org/examples/",i+=".rdf.jsonld",l=i+".zip",t.updateWithOntology(a,e),o=app.ioRdfJsonld.fromSpecif(a,e);break;case"rdf-ttl":e.baseURI="https://product-information-graph.org/examples/",i+=".ttl",l=i+".zip",t.updateWithOntology(a,e),o=app.specif2turtle(a,e);break;case"reqif":i+=".reqif",l=i+"z",c="application/reqif+zip",o=app.ioReqif.fromSpecif(a)}a=null,n.file(i,new Blob([o],{type:"text/plain; charset=utf-8"})),n.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:7},mimeType:c}).then((e=>{saveAs(e,l),t.exporting=!1,s()}),(e=>{console.error("Cannot create ZIP of '"+i+"'."),t.exporting=!1,r(e)}))}),r)}(e);break;case"xlsx":case"epub":case"xhtml":case"oxml":!function(e){e.skipProperties=[{title:CONFIG.propClassType,value:CONFIG.resClassFolder},{title:CONFIG.propClassType,value:CONFIG.resClassOutline}],e.targetLanguage||(e.targetLanguage=t.language);e.lookupTitles=e.lookupValues=e.allDiagramsAsImage=!0,e.makeHTML=e.linkifyURLs=["epub","xhtml","oxml"].includes(e.format),e.preferPng=["epub","oxml","xlsx"].includes(e.format),e.revisionDate=(new Date).toISOString();let a=Object.assign({},e,{plural:!0});t.read(e).then((i=>{let o={titleProperties:CONFIG.titleProperties.map((t=>app.ontology.localize(t,e))),descriptionProperties:CONFIG.descProperties.map((t=>app.ontology.localize(t,e))),typeProperty:app.ontology.localize(CONFIG.propClassType,e),showEmptyProperties:e.showEmptyProperties,imgExtensions:CONFIG.imgExtensions,applExtensions:CONFIG.applExtensions,addIcon:e.elementsWithIcons,addOrder:e.elementsWithOrdernumbers,propertiesLabel:e.withOtherProperties?app.ontology.localize("SpecIF:Property",a):void 0,statementsLabel:e.withStatements?app.ontology.localize(CONFIG.resClassStatement,a):void 0,fileName:t.exportParams.fileName,colorAccent1:"0071B9",done:()=>{app.projects.selected.exporting=!1,s()},fail:e=>{app.projects.selected.exporting=!1,r(e)}};switch(i.title=LIB.makeMultiLanguageValue(e.projectName),e.format){case"xhtml":o.fileName=LIB.addFileExtIfMissing(o.fileName,".xhtml.zip"),specif2xhtml(i,o);break;case"epub":o.fileName=LIB.addFileExtIfMissing(o.fileName,".epub"),toEpub(i,o);break;case"oxml":o.fileName=LIB.addFileExtIfMissing(o.fileName,".doc"),toOxml(i,o);break;case"xlsx":app.ioXls.fromSpecif(i,o)}}),r)}(e);break;default:throw Error("Programming error: Invalid format specified on export.")}return}))}equalR(e,t){let s={targetLanguage:this.language};return LIB.equalKey(e.class,t.class)&&this.cache.instanceTitleOf(e,s)==this.cache.instanceTitleOf(t,s)&&LIB.valueByTitle(e,CONFIG.propClassType,this.cache)==LIB.valueByTitle(t,CONFIG.propClassType,this.cache)}equalS(e,t){return LIB.equalKey(e.class,t.class)&&LIB.equalKey(e.subject,t.subject)&&LIB.equalKey(e.object,t.object)&&LIB.valueByTitle(e,CONFIG.propClassType,this.cache)==LIB.valueByTitle(t,CONFIG.propClassType,this.cache)}equalF(e,t){return LIB.equalKey(e,t)&&e.title==t.title&&e.type==t.type}compatibleDT(e,t){if(e.type==t.type){switch(t.type){case XsDataType.Boolean:return!0;case XsDataType.Double:if(e.fractionDigits<t.fractionDigits)return new resultMsg({status:952,statusText:"new dataType '"+t.id+"' of type '"+t.type+"' is incompatible"}).log(),!1;case XsDataType.Integer:if(e.maxInclusive<t.maxInclusive||e.minInclusive>t.minInclusive)return new resultMsg({status:953,statusText:"new dataType '"+t.id+"' of type '"+t.type+"' is incompatible"}).log(),!1;break;case XsDataType.String:if(e.maxLength&&(null==t.maxLength||e.maxLength<t.maxLength))return new resultMsg({status:951,statusText:"new dataType '"+t.id+"' of type '"+t.type+"' is incompatible"}).log(),!1;break;case XsDataType.DateTime:case XsDataType.Duration:case XsDataType.AnyURI:break;default:throw Error("Invalid data type.")}return function(e,t){if(!e.enumeration&&!t.enumeration)return!0;if(!e.enumeration==!!t.enumeration)return!1;for(var s=t.enumeration.length-1;s>-1;s--)if(LIB.indexById(e.enumeration,t.enumeration[s].id)<0)return new resultMsg({status:954,statusText:"new dataType '"+t.id+"' of type '"+t.type+"' is incompatible"}).log(),!1;return console.debug("new dataType '"+t.id+"' of type '"+t.type+"' is compatible with '"+e.id+"' of type '"+e.type+"'",e,t),!0}(e,t)}return!1}compatiblePC(e,t){return!!LIB.equalPC(e,t)||(new resultMsg({status:956,statusText:"new propertyClass '"+t.id+"' is incompatible"}).log(),!1)}compatiblePCReferences(e,t,s){return s&&s.mode||(s={mode:"match"}),Array.isArray(e)&&Array.isArray(t)?"include"===s.mode?e.length>=t.length&&LIB.containsAllKeys(e,t):e.length==t.length&&LIB.containsAllKeys(e,t):"include"===s.mode?!Array.isArray(t)||t.length<1:!Array.isArray(e)&&!Array.isArray(t)}compatibleECReferences(e,t,s){if(s&&s.mode||(s={mode:"match"}),Array.isArray(e)){if(Array.isArray(t)){if("include"===s.mode)return e.length>=t.length&&LIB.containsAllKeys(e,t);return e.length==t.length&&LIB.containsAllKeys(e,t)}return!1}return"match"!=s.mode||!Array.isArray(t)}compatibleRC(e,t,s){return!!this.compatiblePCReferences(e.propertyClasses,t.propertyClasses,s)||(new resultMsg({status:963,statusText:"new resourceClass '"+t.id+"' is incompatible; propertyClasses don't match"}).log(),!1)}compatibleSC(e,t,s){return e.title!=t.title?(new resultMsg({status:961,statusText:"new statementClass '"+t.id+"' is incompatible; titles don't match"}).log(),!1):this.compatibleECReferences(e.subjectClasses,t.subjectClasses)?this.compatibleECReferences(e.objectClasses,t.objectClasses)?!!this.compatiblePCReferences(e.propertyClasses,t.propertyClasses,s)||(new resultMsg({status:963,statusText:"new statementClass '"+t.id+"' is incompatible; propertyClasses don't match"}).log(),!1):(new resultMsg({status:962,statusText:"new statementClass '"+t.id+"' is incompatible; objectClasses don't match"}).log(),!1):(new resultMsg({status:962,statusText:"new statementClass '"+t.id+"' is incompatible; subjectClasses don't match"}).log(),!1)}substituteProp(e,t,s,r){if(Array.isArray(e))for(var a of e)LIB.references(a[t],r)&&(a[t]=s)}substituteLe(e,t,s,r){let a;Array.isArray(e)&&e.forEach((e=>{Array.isArray(e[t])&&(a=LIB.referenceIndex(e[t],r),a>-1&&(LIB.referenceIndex(e[t],s)<0?e[t].splice(a,1,s):e[t].splice(a,1)))}))}substituteRef(e,t,s){LIB.iterateSpecifNodes(e,(e=>(LIB.references(e.resource,s)&&(e.resource=t),!0)),(e=>{for(var t=e.length-1;t>0;t--)LIB.referenceIndexBy(e.slice(0,t),"resource",e[t].resource)>-1&&e.splice(t,1)}))}substituteEnum(e,t,s){e.resources.concat(e.statements).forEach((e=>{e.properties?.forEach((e=>{e.values.map((r=>(r.id==s.id&&(r.id=t.id),e)))}))})),s.id=t.id}substituteDT(e,t,s){this.substituteProp(e.propertyClasses,"dataType",LIB.makeKey(t.id),LIB.keyOf(s))}substitutePC(e,t,s){this.substituteLe(e.resourceClasses,"propertyClasses",LIB.makeKey(t.id),LIB.keyOf(s)),e.resources.forEach((e=>{this.substituteProp(e.properties,"class",LIB.makeKey(t.id),LIB.keyOf(s))})),this.substituteLe(e.statementClasses,"propertyClasses",LIB.makeKey(t.id),LIB.keyOf(s)),Array.isArray(e.statements)&&e.statements.forEach((e=>{this.substituteProp(e.properties,"class",LIB.makeKey(t.id),LIB.keyOf(s))}))}substituteRC(e,t,s){this.substituteProp(e.resourceClasses,"extends",LIB.makeKey(t.id),LIB.keyOf(s)),this.substituteLe(e.statementClasses,"subjectClasses",LIB.makeKey(t.id),LIB.keyOf(s)),this.substituteLe(e.statementClasses,"objectClasses",LIB.makeKey(t.id),LIB.keyOf(s)),this.substituteProp(e.resources,"class",LIB.makeKey(t.id),LIB.keyOf(s))}substituteSC(e,t,s){this.substituteProp(e.statementClasses,"extends",LIB.makeKey(t.id),LIB.keyOf(s)),this.substituteProp(e.statements,"class",LIB.makeKey(t.id),LIB.keyOf(s))}substituteR(e,t,s){LIB.equalKey(t,s)||(e.statements.forEach((e=>{LIB.references(e.subject,s)&&(e.subject=LIB.makeKey(t.id)),LIB.references(e.object,s)&&(e.object=LIB.makeKey(t.id))})),this.substituteRef(e.nodes,LIB.makeKey(t.id),LIB.keyOf(s)),t.class&&s.class&&!LIB.equalKey(t.class,s.class)&&e.statementClasses.forEach((e=>{let r=LIB.referenceIndexBy(e.subjectClasses,s.class);r>-1&&(e.subjectClasses.splice(r,1),LIB.cacheE(e.subjectClasses,t.class)),r=LIB.referenceIndexBy(e.objectClasses,s.class),r>-1&&(e.objectClasses.splice(r,1),LIB.cacheE(e.objectClasses,t.class))})))}abort(){console.info("abort project"),this.abortFlag=!0}}moduleManager.construct({name:"projects"},(e=>(e.init=()=>(app.standards=new CStandards,e.cache=new CCache({cacheInstances:!0}),app.server&&app.server.open("SpecIF"),e.clear(),!0),e.clear=()=>{e.list=[],e.selected=void 0},e.create=(t,s)=>(e.list.length=0,e.cache.clear(),e.selected=new CProject(e.cache),e.list.push(e.selected),e.selected.create(t,s)),e)));