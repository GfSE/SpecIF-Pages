"use strict";
/*!	ReqIF import and export
    Dependencies: -
    (C)copyright enso managers gmbh (http://enso-managers.de)
    Author: se@enso-managers.de, Berlin
    License and terms of use: Apache 2.0 (http://www.apache.org/licenses/LICENSE-2.0)
    We appreciate any correction, comment or contribution as Github issue (https://github.com/enso-managers/SpecIF-Tools/issues)

    Limitations:
    - It is assumed that all text values within the provided SpecIF data set have only a single language,
      so a "SpecifMultiLanguageText" array has a single entry only.
    - SpecIF v1.1 supports multiple values per property, but ReqIF does not.
      For the time being, only the first value is picked for transformation.
    
    ToDo:
    - escapeXML the content. See toXHTML.ts.
    - transform dataType anyURI to xhtml
    - if a referenced file is not PNG, an alternative PNG and text must be supplied according to the ReqIF schematron.
    - test whether the ReqIF import and export support a roundtrip; neither loss nor growth is acceptable.
*/moduleManager.construct({name:"ioReqif"},(e=>{let E,T,I,t=new resultMsg({status:896,statusText:"No options or no mediaTypes defined."}),s=new resultMsg({status:897,statusText:"No ReqIF file found in the reqifz container."}),a=new resultMsg({status:898,statusText:"ReqIF data is not valid XML."});return e.init=e=>(E=void 0,I=e,!0),e.abortFlag=!1,e.verify=e=>{var I;return I=e.name,E=I.endsWith(".reqifz")||I.endsWith(".reqif.zip")?(T=!0,"application/zip"):I.endsWith(".reqif")?(T=!1,"application/xml"):void 0,!!E||(message.show(i18n.lookup("ErrInvalidFileReqif",e.name)),!1)},e.toSpecif=e=>{let E=$.Deferred(),r=[],i=[],N=0;if(T)(new JSZip).loadAsync(e).then((e=>{if(r=e.filter(((e,E)=>E.name.endsWith(".reqif"))),r.length<1)E.reject(s);else{N=r.length;for(var T=r.length-1;T>-1;T--)e.file(r[T].name).async("string").then((T=>{if(!LIB.validXML(T))return void E.reject(a);let s=reqif2Specif(T);0==s.status?(i.unshift(s.response),--N<1&&(I&&"function"==typeof I.mediaTypeOf?(r=e.filter(((e,E)=>!E.name.endsWith(".reqif"))),r.length>0?(i[0].files=[],N=r.length,r.forEach((T=>{if(T.dir)return N--,!1;let t=I.mediaTypeOf(T.name);if(!t)return N--,!1;e.file(T.name).async("blob").then((e=>{i[0].files.push({blob:e,id:"F-"+simpleHash(T.name),title:T.name,type:t,changedAt:T.date.toISOString()}),--N<1&&E.resolve(i)}))})),N<1&&E.resolve(i)):E.resolve(i)):(console.error(t.statusText),E.resolve(i)))):E.reject(s)}))}}));else{let T=LIB.ab2str(e);if(LIB.validXML(T)){var A=reqif2Specif(T);0==A.status?E.resolve(A.response):E.reject(A)}else E.reject(a)}return E},e.fromSpecif=(e,E)=>{"object"!=typeof E&&(E={}),Array.isArray(E.hierarchyRoots)||(E.hierarchyRoots=["SpecIF:Outline","SpecIF:HierarchyRoot","SpecIF:Hierarchy","SpecIF:BillOfMaterials"]);const T=/^<([a-z]{1,6}:)?div>.+<\/([a-z]{1,6}:)?div>$/,I=/ class=\"[^\"]+\"/g,t=/(<object[^>]*) name=\"[^\"]+\"/g,s=/(<object[^>]*) id=\"[^\"]+\"/g,a=/(<a[^>]*) target=\"[^\"]+\"/g,r=(new Date).toISOString(),i="xhtml",N={id:"DT-FormattedText",title:"XHTML formatted text",description:[{text:"This dataType is beyond SpecIF; it has been added by ioReqif specifically for the SpecIF to ReqIF transformation."}],type:"xhtml",changedAt:"2020-11-06T08:59:00+02:00"};function A(E,T){if(T.propertyClasses){let I,t,s="statementClass"==E?e.statements.filter((e=>LIB.references(e.class,T))):e.resources.filter((e=>LIB.references(e.class,T)));T.propertyClasses.forEach((E=>{I=LIB.itemByKey(e.propertyClasses,E),t=LIB.itemByKey(e.dataTypes,I.dataType),!t.enumeration&&t.type==XsDataType.String&&function(e,E){for(var T of e)if(T.properties)for(var I of T.properties)if(LIB.equalKey(I.class,E)&&LIB.isHTML(I.values[0][0].text))return!0;return!1}(s,E)&&(console.info("Specializing data type to formatted text for propertyClass with id '"+I.id+" and title '"+I.title+"'"),I.dataType=LIB.makeKey(N.id),I.format="xhtml",LIB.cacheE(e.dataTypes,N))}))}}e.resourceClasses.forEach((e=>{A("resourceClass",e)})),e.statementClasses.forEach((e=>{A("statementClass",e)}));var n='<?xml version="1.0" encoding="UTF-8"?><REQ-IF xmlns="http://www.omg.org/spec/ReqIF/20110401/reqif.xsd" xmlns:xhtml="http://www.w3.org/1999/xhtml"><THE-HEADER><REQ-IF-HEADER IDENTIFIER="'+e.id+'"><COMMENT></COMMENT><CREATION-TIME>'+r+"</CREATION-TIME><REQ-IF-TOOL-ID></REQ-IF-TOOL-ID><REQ-IF-VERSION>1.0</REQ-IF-VERSION><SOURCE-TOOL-ID>"+(e.generator||"")+"</SOURCE-TOOL-ID><TITLE>"+e.title[0].text+"</TITLE></REQ-IF-HEADER></THE-HEADER><CORE-CONTENT><REQ-IF-CONTENT><DATATYPES>";e.dataTypes&&e.dataTypes.forEach((e=>{if(e.enumeration)return n+="<DATATYPE-DEFINITION-ENUMERATION "+O(e)+"><SPECIFIED-VALUES>",e.enumeration.forEach(((E,T)=>{n+='<ENUM-VALUE IDENTIFIER="'+E.id+'" LONG-NAME="'+(Array.isArray(E.value)?E.value[0].text:E.value)+'" LAST-CHANGE="'+l(e)+'" ><PROPERTIES><EMBEDDED-VALUE KEY="'+T+'" OTHER-CONTENT="" /></PROPERTIES></ENUM-VALUE>'})),void(n+="</SPECIFIED-VALUES></DATATYPE-DEFINITION-ENUMERATION>");switch(e.type){case XsDataType.Boolean:n+="<DATATYPE-DEFINITION-BOOLEAN "+O(e)+"/>";break;case XsDataType.Integer:n+="<DATATYPE-DEFINITION-INTEGER "+O(e)+' MAX="'+("number"==typeof e.maxInclusive?e.maxInclusive:CONFIG.maxInteger)+'" MIN="'+("number"==typeof e.minInclusive?e.minInclusive:CONFIG.minInteger)+'" />';break;case XsDataType.Double:n+="<DATATYPE-DEFINITION-REAL "+O(e)+' MAX="'+("number"==typeof e.maxInclusive?e.maxInclusive:CONFIG.maxReal)+'" MIN="'+("number"==typeof e.minInclusive?e.minInclusive:CONFIG.minReal)+'" ACCURACY="'+("number"==typeof e.fractionDigits?e.fractionDigits:CONFIG.maxAccuracy)+'" />';break;case XsDataType.DateTime:n+="<DATATYPE-DEFINITION-DATE "+O(e)+"/>";break;case XsDataType.AnyURI:case XsDataType.Duration:let E=JSON.stringify({SpecIF_DataType:e.type});LIB.isMultiLanguageValue(e.description)&&e.description.length>0?e.description[0].text+="\n"+E:e.description=LIB.makeMultiLanguageValue(E);case XsDataType.String:n+="<DATATYPE-DEFINITION-STRING "+O(e)+' MAX-LENGTH="'+(e.maxLength||CONFIG.maxStringLength)+'" />';break;case"xhtml":n+="<DATATYPE-DEFINITION-XHTML "+O(e)+"/>";break;default:console.error("Error: unknown dataType: "+e.type)}})),n+="</DATATYPES><SPEC-TYPES>";let o=new class{constructor(){this.objTypes=[],this.spcTypes=[],this.objects=[]}};function R(E){let T=LIB.itemByKey(e.resources,E.resource),I=LIB.itemByKey(e.resourceClasses,T.class);if(LIB.indexById(o.objTypes,I.id)<0){if(I.extends){let E=LIB.itemByKey(e.resourceClasses,I.extends);Array.isArray(E.propertyClasses)&&(Array.isArray(I.propertyClasses)?I.propertyClasses=E.propertyClasses.concat(I.propertyClasses):I.propertyClasses=E.propertyClasses)}o.objTypes.push(I)}LIB.indexById(o.objects,T.id)<0&&o.objects.push(T)}return e.nodes.forEach((e=>{e.nodes&&e.nodes.forEach((e=>{D(e,R)}))})),e.nodes.forEach((E=>{let T=LIB.itemByKey(e.resources,E.resource),I=LIB.itemByKey(e.resourceClasses,T.class);LIB.referenceIndexBy(o.objects,"class",I)>-1&&(I=simpleClone(I),I.id=LIB.replacePrefix(CONFIG.prefixHC,I.id)),LIB.indexById(o.spcTypes,I.id)<0&&o.spcTypes.push(I),E.id=T.id,E.class=LIB.keyOf(I),T.properties&&(E.properties=T.properties)})),o.objTypes.forEach((e=>{n+="<SPEC-OBJECT-TYPE "+O(e)+">"+c(e)+"</SPEC-OBJECT-TYPE>"})),e.statementClasses&&e.statementClasses.forEach((e=>{n+="<SPEC-RELATION-TYPE "+O(e)+">"+c(e)+"</SPEC-RELATION-TYPE>"})),o.spcTypes.forEach((e=>{n+="<SPECIFICATION-TYPE "+O(e)+">"+c(e)+"</SPECIFICATION-TYPE>"})),n+="</SPEC-TYPES><SPEC-OBJECTS>",o.objects.forEach((e=>{n+="<SPEC-OBJECT "+O(e)+"><TYPE><SPEC-OBJECT-TYPE-REF>"+e.class.id+"</SPEC-OBJECT-TYPE-REF></TYPE>"+p(e)+"</SPEC-OBJECT>"})),n+="</SPEC-OBJECTS><SPEC-RELATIONS>",e.statements.forEach((E=>{LIB.indexByKey(e.resources,E.object)>-1&&LIB.indexByKey(e.resources,E.subject)>-1&&(E.title=LIB.itemByKey(e.statementClasses,E.class).title,n+="<SPEC-RELATION "+O(E)+"><TYPE><SPEC-RELATION-TYPE-REF>"+E.class.id+"</SPEC-RELATION-TYPE-REF></TYPE>"+p(E)+"<SOURCE><SPEC-OBJECT-REF>"+E.subject.id+"</SPEC-OBJECT-REF></SOURCE><TARGET><SPEC-OBJECT-REF>"+E.object.id+"</SPEC-OBJECT-REF></TARGET></SPEC-RELATION>")})),n+="</SPEC-RELATIONS><SPECIFICATIONS>",e.nodes.forEach((e=>{n+="<SPECIFICATION "+O(e)+"><TYPE><SPECIFICATION-TYPE-REF>"+e.class.id+"</SPECIFICATION-TYPE-REF></TYPE>"+p(e)+F(e)+"</SPECIFICATION>"})),n+="</SPECIFICATIONS><SPEC-RELATION-GROUPS></SPEC-RELATION-GROUPS></REQ-IF-CONTENT></CORE-CONTENT><TOOL-EXTENSIONS></TOOL-EXTENSIONS></REQ-IF>";function l(E){return E.changedAt||e.createdAt||r}function O(e){return'IDENTIFIER="'+e.id+(e.title?'" LONG-NAME="'+e.title.stripHTML().escapeXML():"")+(e.description&&e.description[0]&&e.description[0].text?'" DESC="'+e.description[0].text.stripHTML().escapeXML():"")+'" LAST-CHANGE="'+l(e)+'"'}function c(E){if(!E.propertyClasses||E.propertyClasses.length<1)return"<SPEC-ATTRIBUTES></SPEC-ATTRIBUTES>";var T="<SPEC-ATTRIBUTES>";return E.propertyClasses.forEach((I=>{let t=LIB.itemByKey(e.propertyClasses,I),s=LIB.itemByKey(e.dataTypes,t.dataType),a=simpleHash(E.id+t.id);if(s.enumeration)T+='<ATTRIBUTE-DEFINITION-ENUMERATION IDENTIFIER="PC-'+a+'" LONG-NAME="'+t.title+'" MULTI-VALUED="'+function(e,E){return"boolean"==typeof e.multiple?e.multiple:!!LIB.itemByKey(E.dataTypes,e.dataType).multiple}(t,e)+'" LAST-CHANGE="'+l(t)+'"><TYPE><DATATYPE-DEFINITION-ENUMERATION-REF>'+s.id+"</DATATYPE-DEFINITION-ENUMERATION-REF></TYPE></ATTRIBUTE-DEFINITION-ENUMERATION>";else switch(s.type){case XsDataType.Boolean:T+='<ATTRIBUTE-DEFINITION-BOOLEAN IDENTIFIER="PC-'+a+'" LONG-NAME="'+t.title+'" LAST-CHANGE="'+l(t)+'"><TYPE><DATATYPE-DEFINITION-BOOLEAN-REF>'+s.id+"</DATATYPE-DEFINITION-BOOLEAN-REF></TYPE></ATTRIBUTE-DEFINITION-BOOLEAN>";break;case XsDataType.Integer:T+='<ATTRIBUTE-DEFINITION-INTEGER IDENTIFIER="PC-'+a+'" LONG-NAME="'+t.title+'" LAST-CHANGE="'+l(t)+'"><TYPE><DATATYPE-DEFINITION-INTEGER-REF>'+s.id+"</DATATYPE-DEFINITION-INTEGER-REF></TYPE></ATTRIBUTE-DEFINITION-INTEGER>";break;case XsDataType.Double:T+='<ATTRIBUTE-DEFINITION-REAL IDENTIFIER="PC-'+a+'" LONG-NAME="'+t.title+'" LAST-CHANGE="'+l(t)+'"><TYPE><DATATYPE-DEFINITION-REAL-REF>'+s.id+"</DATATYPE-DEFINITION-REAL-REF></TYPE></ATTRIBUTE-DEFINITION-REAL>";break;case XsDataType.String:T+='<ATTRIBUTE-DEFINITION-STRING IDENTIFIER="PC-'+a+'" LONG-NAME="'+t.title+'" LAST-CHANGE="'+l(t)+'"><TYPE><DATATYPE-DEFINITION-STRING-REF>'+s.id+"</DATATYPE-DEFINITION-STRING-REF></TYPE></ATTRIBUTE-DEFINITION-STRING>";break;case"xhtml":T+='<ATTRIBUTE-DEFINITION-XHTML IDENTIFIER="PC-'+a+'" LONG-NAME="'+t.title+'" LAST-CHANGE="'+l(t)+'"><TYPE><DATATYPE-DEFINITION-XHTML-REF>'+s.id+"</DATATYPE-DEFINITION-XHTML-REF></TYPE></ATTRIBUTE-DEFINITION-XHTML>";break;case XsDataType.DateTime:T+='<ATTRIBUTE-DEFINITION-DATE IDENTIFIER="PC-'+a+'" LONG-NAME="'+t.title+'" LAST-CHANGE="'+l(t)+'"><TYPE><DATATYPE-DEFINITION-DATE-REF>'+s.id+"</DATATYPE-DEFINITION-DATE-REF></TYPE></ATTRIBUTE-DEFINITION-DATE>"}})),T+"</SPEC-ATTRIBUTES>"}function p(E){if(!E||!E.properties||E.properties.length<1)return"<VALUES></VALUES>";var r="<VALUES>";return E.properties.forEach((N=>{let A=LIB.itemByKey(e.propertyClasses,N.class),n=LIB.itemByKey(e.dataTypes,A.dataType),o=simpleHash(E.class.id+N.class.id);if(n.enumeration)r+="<ATTRIBUTE-VALUE-ENUMERATION><DEFINITION><ATTRIBUTE-DEFINITION-ENUMERATION-REF>PC-"+o+"</ATTRIBUTE-DEFINITION-ENUMERATION-REF></DEFINITION><VALUES>",N.values.forEach((e=>{r+="<ENUM-VALUE-REF>"+e.id+"</ENUM-VALUE-REF>"})),r+="</VALUES></ATTRIBUTE-VALUE-ENUMERATION>";else switch(n.type){case XsDataType.Boolean:r+='<ATTRIBUTE-VALUE-BOOLEAN THE-VALUE="'+N.values[0]+'"><DEFINITION><ATTRIBUTE-DEFINITION-BOOLEAN-REF>PC-'+o+"</ATTRIBUTE-DEFINITION-BOOLEAN-REF></DEFINITION></ATTRIBUTE-VALUE-BOOLEAN>";break;case XsDataType.Integer:r+='<ATTRIBUTE-VALUE-INTEGER THE-VALUE="'+N.values[0]+'"><DEFINITION><ATTRIBUTE-DEFINITION-INTEGER-REF>PC-'+o+"</ATTRIBUTE-DEFINITION-INTEGER-REF></DEFINITION></ATTRIBUTE-VALUE-INTEGER>";break;case XsDataType.Double:r+='<ATTRIBUTE-VALUE-REAL THE-VALUE="'+N.values[0]+'"><DEFINITION><ATTRIBUTE-DEFINITION-REAL-REF>PC-'+o+"</ATTRIBUTE-DEFINITION-REAL-REF></DEFINITION></ATTRIBUTE-VALUE-REAL>";break;case XsDataType.String:r+='<ATTRIBUTE-VALUE-STRING THE-VALUE="'+N.values[0][0].text.stripHTML().escapeXML()+'"><DEFINITION><ATTRIBUTE-DEFINITION-STRING-REF>PC-'+o+"</ATTRIBUTE-DEFINITION-STRING-REF></DEFINITION></ATTRIBUTE-VALUE-STRING>";break;case"xhtml":let e=T.test(N.values[0][0].text),E=LIB.escapeInnerHtml(N.values[0][0].text).replace(I,(()=>"")).replace(a,((e,E)=>E)).replace(s,((e,E)=>E)).replace(t,((e,E)=>E)).replace(RE.tag,((e,E,T)=>E+i+":"+T));r+="<ATTRIBUTE-VALUE-XHTML><DEFINITION><ATTRIBUTE-DEFINITION-XHTML-REF>PC-"+o+"</ATTRIBUTE-DEFINITION-XHTML-REF></DEFINITION><THE-VALUE>"+(e?"":"<xhtml:div>")+E+(e?"":"</xhtml:div>")+"</THE-VALUE></ATTRIBUTE-VALUE-XHTML>";break;case XsDataType.DateTime:r+='<ATTRIBUTE-VALUE-DATE THE-VALUE="'+N.values[0]+'"><DEFINITION><ATTRIBUTE-DEFINITION-DATE-REF>PC-'+o+"</ATTRIBUTE-DEFINITION-DATE-REF></DEFINITION></ATTRIBUTE-VALUE-DATE>"}})),r+"</VALUES>"}function F(e){if(!e.nodes||e.nodes.length<1)return"";var E="<CHILDREN>";return e.nodes.forEach((T=>{E+='<SPEC-HIERARCHY IDENTIFIER="'+(T.id||CONFIG.prefixN+T.resource)+(T.title?'" LONG-NAME="'+T.title:"")+'" LAST-CHANGE="'+(T.changedAt||e.changedAt)+'"><OBJECT><SPEC-OBJECT-REF>'+T.resource.id+"</SPEC-OBJECT-REF></OBJECT>"+F(T)+"</SPEC-HIERARCHY>"})),E+"</CHILDREN>"}function D(e,E){E(e),e.nodes&&e.nodes.forEach((e=>{D(e,E)}))}},e.abort=()=>{e.abortFlag=!0},e}));