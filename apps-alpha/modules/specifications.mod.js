"use strict";
/*!	Show SpecIF data
    Dependencies: jQuery, jqTree, bootstrap
    (C)copyright enso managers gmbh (http://enso-managers.de)
    Author: se@enso-managers.de, Berlin
    License and terms of use: Apache 2.0 (http://www.apache.org/licenses/LICENSE-2.0)
    We appreciate any correction, comment or contribution as Github issue (https://github.com/enso-managers/SpecIF-Tools/issues)

    ToDo: This module is lousy coding with lots of historical burden --> redo!
*/RE.titleLink=new RegExp(CONFIG.titleLinkBegin+"(.+?)"+CONFIG.titleLinkEnd,"g");class CPropertyToShow{constructor(e,t){for(var s in e)this[s]=e[s];this.cData=app.projects.cache,this.selPrj=app.projects.selected,this.pC=this.cData.get("propertyClass",[this.class])[0],this.dT=this.cData.get("dataType",[this.pC.dataType])[0],this.title=LIB.titleOf(this.pC,{targetLanguage:"default"}),this.dT.enumeration&&(this.enumIdL=e.values.map((e=>e.id)),this.values=this.values.map((e=>LIB.itemById(this.dT.enumeration,e.id).value)));let i=LIB.itemBy(this.selPrj.myPermissions,"item",this.pC.id);i?this.pC.permissionVector=i.permissionVector:(i=LIB.itemBy(this.selPrj.myPermissions,"item",t.id),i?this.pC.permissionVector=i.permissionVector:(i=LIB.itemBy(this.selPrj.myPermissions,"item",this.selPrj.id),this.pC.permissionVector=i?i.permissionVector:noPermission))}allValues(e){var t="";if(this.dT.type==XsDataType.String){let s;if(e&&e.targetLanguage)return e.allValues?this.values.forEach(((i,r)=>{s=LIB.languageTextOf(i,e),t+=(r<1?"":", ")+(e.lookupValues?app.ontology.localize(s,e):s)})):(s=LIB.languageTextOf(this.values[0],e),t=e.lookupValues?app.ontology.localize(s,e):s),t.replace(/^\s+/,"");throw Error("When displaying a property value with dataType string, a target language must be specified.")}return this.values.forEach(((e,s)=>{t+=(s<1?"":", ")+e})),t}isVisible(e){return CONFIG.hiddenProperties.indexOf(this.title)<0&&(CONFIG.showEmptyProperties||LIB.hasContent(this.allValues(e)))}get(e){let t,s=Object.assign({titleLinking:!1,lookupValues:!1,allValues:!0,targetLanguage:this.selPrj.language,clickableElements:!1,linkifyURLs:!1,renderFiles:!1,unescapeHTMLTags:!1,makeHTML:!1},e);switch(this.dT.type){case XsDataType.String:t=this.allValues(s),s.unescapeHTMLTags&&(t=t.unescapeHTMLTags()),s.renderFiles&&(t=this.renderFile(t,s)),this.pC.format==SpecifTextFormat.Xhtml&&(t=t.makeHTML(s)),t=this.titleLinks(t,s);break;case XsDataType.DateTime:t=s.localDateTime?LIB.localDateTime(this.values[0]):this.values[0];break;default:t=this.allValues(s)}return t}titleLinks(e,t){if(t.keepTitleLinkingPatterns)return e;if(!CONFIG.titleLinking||!t.titleLinking)return e.replace(RE.titleLink,((e,t,s)=>t+s));let s=!1;do{s=!1,e=e.replace(RE.titleLink,((e,i,r)=>{if(s=!0,i.length<CONFIG.titleLinkMinLength)return i+r;let a,n,o,l=i.toLowerCase();return app.specs.tree.iterate((e=>(a=LIB.itemByKey(this.cData.resources,e.ref),n=this.cData.instanceTitleOf(a,t),!n||l!=n.toLowerCase()||(o=a,!1)))),o?'<a class="link-primary" onclick="app[CONFIG.objectList].relatedItemClicked(\''+o.id+"')\">"+i+"</a>"+r:'<span style="color:#D82020">'+i+"</span>"+r}))}while(s);return e}renderFile(e,t){"object"!=typeof t&&(t={}),null==t.imgClass&&(t.imgClass="forImage");let s={xhtmlAttrType:/(type="[^"]+")/,xhtmlAttrData:/data="([^"]+)"/};function i(e){let t=s.xhtmlAttrType.exec(e);return Array.isArray(t)&&t.length>0?" "+t[1]:""}function r(e){let t=s.xhtmlAttrData.exec(e);return Array.isArray(t)&&t.length>0?t[1]:""}function a(e,t){let s=new RegExp(e+'="([^"]+)"',"").exec(t);return Array.isArray(s)&&s.length>0?s[1]:""}function n(e,t){return t||e?' style="'+(t?"height:"+t+"; ":"")+(e?"width:"+e+"; ":"")+'"':""}var o=[];return e=(e=(e=(e=e.replace(RE.tagNestedObjects,((e,s,i,l,c)=>{let d=r(s),u=r(i),p=a("width",i),h=a("height",i),g=c||d;d||console.warn("No file reference found in "+e),u||console.warn("No image reference found in "+e);let m=new CFileWithContent(LIB.itemByTitle(this.cData.files,d)),b=new CFileWithContent(LIB.itemByTitle(this.cData.files,u));return m&&m.hasContent()?(b&&b.hasContent()?(o.push('<div id="'+tagId(d)+'"></div>'),m.renderDownloadLink('<div class="'+t.imgClass+" "+tagId(u)+'"'+n(p,h)+"></div>",t),b.renderImage(Object.assign({},t,{timelag:1.2*t.timelag}))):(o.push('<span class="'+tagId(d)+'"></span>'),m.renderDownloadLink(g,t)),"aBra§kadabra"+(o.length-1)+"§"):'<div class="notice-danger" >File missing: '+g+"</div>"}))).replace(RE.tagSingleObject,((e,s,l,c)=>{let d=r(s),u=i(s),p=a("width",s),h=a("height",s);d||console.warn("No image or link found in "+e);let g=d?d.fileExt():void 0;if(!g)return e;let m=c||d,b=!1;g=g.toLowerCase();let f=new CFileWithContent(LIB.itemByTitle(this.cData.files,d));if((!f||!f.hasContent())&&d&&CONFIG.applExtensions.includes(g))for(var C=0,I=CONFIG.imgExtensions.length;(!f||!f.hasContent())&&C<I;C++)d=d.fileName()+"."+CONFIG.imgExtensions[C],f=new CFileWithContent(LIB.itemByTitle(this.cData.files,d));return f&&f.hasContent()?f.canBeRenderedAsImage()?(b=!0,m='<div class="'+t.imgClass+" "+tagId(d)+'"'+n(p,h)+"></div>",f.renderImage(t)):f.canBeDownloaded()?(b=!0,app.embedded?f.renderDownloadLink(m,t):f.renderDownloadLink('<img src="'+CONFIG.imgURL+"/"+g+'-icon.png" type="image/png" alt="[ '+g+' ]" />',t),m='<div id="'+tagId(d)+'" '+CONFIG.fileIconStyle+"></div>"):m="<span>"+m+"</span>":m='<div class="notice-danger" >File missing: '+m+"</div>",b?o.push(m):o.push('<a href="'+d+'"'+u+" >"+m+"</a>"),"aBra§kadabra"+(o.length-1)+"§"}))).replace(RE.tagA,((e,t,s)=>{var r=a("href",t),n=r?r.fileExt():void 0;if(!n)return e;if(CONFIG.officeExtensions.indexOf(n.toLowerCase())<0)return e;var o=i(t);if(!s){var l=r.split("/");s=l[l.length-1]}return'<a href="'+r+'" '+o+' target="_blank" >'+(n='<img src="'+CONFIG.imgURL+"/"+n+'-icon.png" type="image/png" />')+"</a>"}))).replace(/aBra§kadabra(\d+)§/g,((e,t)=>o[t]))}}class CResourceToShow{constructor(e){this.hasPropertyWithUpdatePermission=!1,this.selPrj=app.projects.selected,this.cData=this.selPrj.cache,this.id=e.id,this.class=e.class,this.rC=LIB.getExtendedClasses(this.cData.get("resourceClass","all"),[e.class])[0],this.revision=e.revision,this.language=e.language||this.selPrj.language,this.order=e.order,this.revision=e.revision,this.replaces=e.replaces,this.changedAt=e.changedAt,this.changedBy=e.changedBy,this.other=LIB.forAll(e.properties,(e=>new CPropertyToShow(e,this.rC)));let t=LIB.titleIdx(this.other,this.cData.propertyClasses);for(t>-1&&(this.title=this.other.splice(t,1)[0]),this.descriptions=[],t=this.other.length-1;t>-1;t--)CONFIG.descProperties.includes(this.other[t].title)&&this.descriptions.unshift(this.other.splice(t,1)[0]);let s=LIB.itemBy(this.selPrj.myPermissions,"item",this.rC.id);for(var i of(s?this.rC.permissionVector=s.permissionVector:(s=LIB.itemBy(this.selPrj.myPermissions,"item",this.selPrj.id),this.rC.permissionVector=s?s.permissionVector:noPermission),this.cData.get("propertyClass",this.rC.propertyClasses))){let e=LIB.itemBy(this.selPrj.myPermissions,"item",i.id);if(e?i.permissionVector=e.permissionVector:(e=LIB.itemBy(this.selPrj.myPermissions,"item",this.rC.id),e?i.permissionVector=e.permissionVector:(e=LIB.itemBy(this.selPrj.myPermissions,"item",this.selPrj.id),i.permissionVector=e?e.permissionVector:noPermission)),i.permissionVector.U){this.hasPropertyWithUpdatePermission=!0;break}}}isEqual(e){return e&&this.id==e.id&&this.changedAt==e.changedAt}isUserInstantiated(){return!Array.isArray(this.rC.instantiation)||this.rC.instantiation.includes(SpecifInstantiation.User)}renderAttr(e,t,s){return'<div class="row '+(s&&s.condensed?"attribute-condensed":"attribute")+'">'+(e?'<div class="col-3 attribute-label" >'+e+'</div><div class="col-9 attribute-value" >':'<div class="col-12" >')+t+"</div></div>"}renderTitle(e){if(!this.title||!this.title.values)return"";let t=LIB.displayValueOf(this.title.values[0],Object.assign({},e,{lookupValues:this.rC.isHeading,stripHTML:!0}));return this.rC.isHeading?'<div class="chapterTitle" >'+(this.order?this.order+"&#160;":"")+t+"</div>":'<div class="objectTitle" >'+(CONFIG.addIconToInstance?LIB.addIcon(t,this.rC.icon):t)+"</div>"}listEntry(){if(!this.id)return'<div class="notice-default">'+i18n.MsgNoObject+"</div>";const e=[CONFIG.objectList,CONFIG.objectDetails].includes(app.specs.selectedView()),t={clickableElements:e,linkifyURLs:e,unescapeHTMLTags:!0,makeHTML:!0,renderFiles:!0,lookupTitles:!0,lookupValues:!0,targetLanguage:this.language,localDateTime:!0,rev:this.revision},s=Object.assign({titleLinking:e},t);var i='<div class="row listEntry"><div class="col-xl-8">';return[CONFIG.objectList,CONFIG.objectFilter].includes(app.specs.selectedView())?i+="<div onclick=\"app.specs.itemClicked('"+this.id+"')\">"+this.renderTitle(t)+"</div>":i+=this.renderTitle(t),this.descriptions.forEach((e=>{e.isVisible(t)&&(i+=this.renderAttr("",e.get(s)))})),i+='</div><div class="col-xl">',i+=this.renderAttr(app.ontology.localize(CONFIG.resClassResource,t),LIB.titleOf(this.rC,t),{condensed:!0}),this.other.forEach((e=>{e.isVisible(t)&&(i+=this.renderAttr(LIB.titleOf(e,t),e.get(t),{condensed:!0}))})),i+="</div></div>"}}class CResourcesToShow{constructor(){this.clear()}clear(){this.list=[]}push(e){return this.list.push(new CResourceToShow(e)),!0}append(e){return e.forEach((e=>{this.push(e)})),!0}set(e,t){return!this.list[e].isEqual(t)&&(this.list[e]=new CResourceToShow(t),!0)}update(e){if(e.length==this.list.length){for(var t=!1,s=e.length-1;s>-1;s--)t=this.set(s,e[s])||t;return t}return this.list.length=0,this.append(e),!0}updateSelected(e){return this.list.length>0?this.set(0,e):this.push(e)}selected(){return this.list[0]}exists(e){for(var t=this.list.length-1;t>-1;t--)if(this.list[t].id==e)return!0;return!1}render(){if(this.list.length<1)return'<div class="notice-default" >'+i18n.MsgNoMatchingObjects+"</div>";var e="";return this.list.forEach((t=>{e+=t?t.listEntry():""})),e}}class CFileWithContent{constructor(e){for(var t in e)this[t]=e[t]}hasBlob(){return!!this.blob&&this.blob.size>0}hasDataURL(){return!!this.dataURL&&this.dataURL.length>0}hasContent(){return this.title&&this.title.length>0&&(this.hasBlob()||this.hasDataURL())}canBeRenderedAsImage(){return CONFIG.imgExtensions.includes(this.title.fileExt().toLowerCase())}canBeDownloaded(){return CONFIG.officeExtensions.concat(CONFIG.applExtensions).includes(this.title.fileExt().toLowerCase())}renderDownloadLink(e,t){function s(t,s,i){document.getElementById(tagId(s)).innerHTML='<a href="'+t+'" type="'+i+'" download="'+s.baseName()+'" >'+e+"</a>"}if("object"!=typeof t&&(t={}),"number"!=typeof t.timelag&&(t.timelag=CONFIG.imageRenderingTimelag),this.hasBlob())LIB.blob2dataURL(this,s,t.timelag);else{if(!this.hasDataURL())throw Error("Neither Blob nor DataURL found when preparing a download link.");setTimeout((()=>{s(this.dataURL,this.title,this.type)}),t.timelag)}}renderImage(e){if("object"!=typeof e&&(e={}),"number"!=typeof e.timelag&&(e.timelag=CONFIG.imageRenderingTimelag),this.blob||this.dataURL)if(this.dataURL)setTimeout((()=>{Array.from(document.getElementsByClassName(tagId(this.title)),(e=>{let t=/data:([^;]+);/.exec(this.dataURL);e.innerHTML='<object data="'+this.dataURL+'" type="'+(t[1]||this.type)+'" >'+this.title+"</object>"}))}),e.timelag);else switch(this.type){case"image/png":case"image/x-png":case"image/jpeg":case"image/jpg":case"image/gif":this.showRaster(e);break;case"image/svg+xml":this.showSvg(e);break;default:console.warn("Cannot show diagram "+this.title+" of unknown type: ",this.type)}else setTimeout((()=>{Array.from(document.getElementsByClassName(tagId(this.title)),(e=>{e.innerHTML='<div class="notice-danger" >Image missing: '+this.title+"</div>"}))}),e.timelag)}showRaster(e){LIB.blob2dataURL(this,((e,t,s)=>{Array.from(document.getElementsByClassName(tagId(t)),(i=>{i.innerHTML='<img src="'+e+'" type="'+s+'" alt="'+t+'" />'}))}),e.timelag)}showSvg(e){return void LIB.blob2text(this,(function(i,r){let a,n,o={locs:document.getElementsByClassName(tagId(r)),img:i},l=[],c=/(<image .* xlink:href=\")(.+)(\".*\/>)/g,d=0;for(;null!=(n=c.exec(i));)n[2].startsWith("data:")||LIB.indexById(l,n[2])>-1||(a=s(app.projects.selected.cache.files,n[2]),a&&a.blob&&(d++,LIB.blob2dataURL(a,((e,s)=>{l.push({id:s,val:e}),--d<1&&(o.img=o.img.replace(c,((e,s,i,r)=>{let a=t(l,i);return a?s+a.val+r:""})),u(o))}))));d<1&&u(o);return;function u(s){Array.from(s.locs,(i=>{i.innerHTML=s.img,function(e){for(var t of e.childNodes)if(t&&t.outerHTML&&t.outerHTML.startsWith("<svg")){if(t.getAttribute("viewBox"))return;let e=t.getAttribute("width").replace(/px$/,""),s=t.getAttribute("height").replace(/px$/,"");return void t.setAttribute("viewBox","0 0 "+e+" "+s)}}(i),e&&e.clickableElements&&function(s){if(!CONFIG.clickableModelElements||CONFIG.clickElementClasses.length<1)return;return s.clkEls=[],CONFIG.clickElementClasses.forEach((e=>{s.clkEls=s.clkEls.concat(Array.from(s.getElementsByClassName(e)))})),s.clkEls.forEach((e=>{e.setAttribute("style","cursor:pointer;"),e.addEventListener("dblclick",(function(){let e=this.className.baseVal.split(" ")[1];e=i(e),$("#details").empty(),app.specs.showTree.set(),app.specs.tree.selectNodeByRef(LIB.makeKey(e),!0),document.getElementById(CONFIG.objectList).scrollTop=0})),e.addEventListener("mouseover",(function(){let e=this.className.baseVal.split(" ")[1],s=app.projects.selected,i=new CResourceToShow(t(s.cache.resources,e)),r=LIB.languageTextOf(i.title.values[0],{targetLanguage:s.language}),a="";i.descriptions.forEach((e=>{a+=e.get({unescapeHTMLTags:!0,makeHTML:e.pC.format==SpecifTextFormat.Xhtml,renderFiles:!0})})),a.stripCtrl().stripHTML()&&($("#details").html('<div style="font-size:120%;margin-bottom:0.3em">'+(CONFIG.addIconToInstance?LIB.addIcon(r,i.rC.icon):r)+"</div>"+a),app.specs.showTree.set(!1))})),e.addEventListener("mouseout",(function(){$("#details").empty(),app.specs.showTree.set()}))})),s;function i(s){if(CONFIG.selectCorrespondingDiagramFirst){let r,a=app.projects.selected.cache,n=a.instanceTitleOf(t(a.resources,s),e);for(var i=a.resources.length-1;i>-1;i--)if(r=LIB.itemByKey(a.resourceClasses,a.resources[i].class),CONFIG.diagramClasses.includes(r.title)&&a.instanceTitleOf(a.resources[i],e)==n)return app[CONFIG.objectList].resources.selected()&&app[CONFIG.objectList].resources.selected().id==a.resources[i].id?s:a.resources[i].id}return s}}(i)}))}}),e.timelag);function t(e,t){t=t.trim();for(var s=e.length-1;s>-1;s--)if(e[s].id.includes(t))return e[s]}function s(e,t){t=t.trim();for(var s=e.length-1;s>-1;s--)if(e[s].title.includes(t))return e[s]}}}moduleManager.construct({name:CONFIG.specifications},(e=>{const t="app."+e.loadAs;e.selectedView=()=>e.viewControl.selected.view.substring(1),e.emptyTab=e=>{app.busy.reset(),$(e).empty()},e.init=()=>{e.clear();let i='<div id="specContent" class="container-fluid"><div class="row"><div id="specLeft" class="col-lg-3 background-select" style="position:relative"><div id="navBtns" class="btn-group-vertical btn-group-sm" role="group" style="position:absolute;top:1em;right:1.2em;z-index:900"><button class="btn btn-light" onclick="'+t+'.tree.moveUp()" data-toggle="popover" title="'+i18n.LblPrevious+'" >'+i18n.IcoPrevious+'</button><button class="btn btn-light" onclick="'+t+'.tree.moveDown()" data-toggle="popover" title="'+i18n.LblNext+'" >'+i18n.IcoNext+'</button></div><div id="hierarchy" class="pane-tree" ></div><div id="details" class="pane-details" ></div></div></div></div>';return $(e.selector).after(i),$("#specLeft").after($("#"+CONFIG.objectList).addClass("col-lg"),$("#"+CONFIG.relations).addClass("col-lg")),e.showLeft=new State({showWhenSet:["#specLeft"],hideWhenSet:[]}),e.showTree=new State({showWhenSet:["#hierarchy","#navBtns"],hideWhenSet:["#details"]}),e.tree=new Tree({loc:"#hierarchy",dragAndDrop:app.title!=i18n.LblReader,eventHandlers:{select:t=>{e.tree.selectedNode=t.node,document.getElementById(CONFIG.objectList).scrollTop=0,e.refresh()},open:()=>{e.selectedView()==CONFIG.objectList&&e.refresh()},close:()=>{e.selectedView()==CONFIG.objectList&&e.refresh()},move:t=>{function s(t,s){let i=(new Date).toISOString(),r=function e(t){var s={id:t.id,resource:t.ref,changedAt:i},r=t.children.map(e);return r.length>0&&(s.nodes=r),s}(t);for(var a in s)r[a]=s[a].id;e.selPrj.createItems("node",[r]).then((()=>{e.tree.numberize(),e.reworkTree(),document.getElementById(CONFIG.objectList).scrollTop=0,e.refresh()}),LIB.stdError)}app.busy.set(),e.selPrj.deleteItems("node",[LIB.keyOf(t.move_info.moved_node)]).then((()=>{/after/.test(t.move_info.position)?s(t.move_info.moved_node,{predecessor:t.move_info.target_node}):/inside/.test(t.move_info.position)?s(t.move_info.moved_node,{parent:t.move_info.target_node}):s(t.move_info.moved_node,{parent:t.move_info.target_node.parent})}),LIB.stdError)}}}),s=0,!0},e.clear=()=>{e.tree&&e.tree.clear(),s=0,app.busy.reset()},e.hide=()=>{app.busy.reset()},e.updateTree=(t,s)=>{return s||(s=e.cData.nodes),e.tree.saveState(),e.tree.set(LIB.forAll(s,(function(t){let s=LIB.itemByKey(e.cData.resources,t.resource),r=LIB.valueByTitle(s,CONFIG.propClassType,e.cData);return[CONFIG.resClassHierarchyRoot,CONFIG.reqifHierarchyRoot].includes(r)?LIB.forAll(t.nodes,i):i(t)}))),e.tree.numberize(),void e.tree.restoreState();function i(s){let r=LIB.itemByKey(e.cData.resources,s.resource);return{id:s.id,name:e.cData.instanceTitleOf(r,Object.assign({},t,{neverEmpty:!0})),ref:s.resource,children:LIB.forAll(s.nodes,i)}}},e.show=t=>{e.selPrj=app.projects.selected,e.selPrj&&e.selPrj.isLoaded()||console.warn("No selected project on entry of spec.show()"),e.cData=e.selPrj.cache,$("#pageTitle").html(LIB.languageTextOf(e.selPrj.title,{targetLanguage:e.selPrj.language})),app.busy.set();let s=t.urlParams,i=e.tree.firstNode();t.targetLanguage=e.selPrj.language,t.lookupValues=!0,(!i||!e.cData.has("resource",[i.ref])||s&&s[CONFIG.keyProject]&&s[CONFIG.keyProject]!=e.selPrj.id)&&e.tree.clear(),e.cData.length("hierarchy")>0&&e.selPrj.readItems("hierarchy",e.selPrj.nodes,{reload:!0}).then((i=>{let r;e.updateTree(t,i),s&&s[CONFIG.keyNode]&&(r=e.tree.selectNodeById(s[CONFIG.keyNode])),!r&&s&&s[CONFIG.keyItem]&&(r=e.tree.selectNodeByRef(s[CONFIG.keyItem])),r||(r=e.tree.selectedNode),r||(r=e.tree.selectFirstNode()),r&&e.tree.openNode(r)}),LIB.stdError)};var s=0;return e.refresh=t=>{s++,setTimeout((()=>{--s<1&&e.doRefresh(t)}),CONFIG.noMultipleRefreshWithin)},e.doRefresh=t=>{e.viewControl.selected.show(t)},e.reworkTree=()=>{e.selPrj.createFolderWithGlossary({addGlossary:!0}).then((()=>e.selPrj.createFolderWithUnreferencedResources({addUnreferencedResources:!0}))).then((()=>{e.updateTree({lookupTitles:!0,targetLanguage:e.selPrj.language}),e.doRefresh({forced:!0})})).catch(LIB.stdError)},e.itemClicked=t=>{[CONFIG.objectRevisions,CONFIG.comments].includes(e.selectedView())||(e.tree.selectedNode.ref!=t&&(e.showTree.set(),e.tree.selectNodeByRef(LIB.makeKey(t)),document.getElementById(CONFIG.objectList).scrollTop=0,e.tree.openNode()),e.selectedView()!=CONFIG.objectList&&moduleManager.show({view:"#"+CONFIG.objectList}))},e})),moduleManager.construct({view:"#"+CONFIG.objectList},(e=>{const t="app."+e.loadAs;var s,i,r;return e.init=()=>(e.resCreClasses=[],e.resCre=!1,e.resources=new CResourcesToShow,!0),e.clear=()=>{e.resources.clear()},e.hide=()=>{$(e.view).empty()},e.show=r=>{var a;return e.parent.showLeft.set(),e.parent.showTree.set(),s=app.projects.selected,"object"!=typeof r&&(r={}),r.targetLanguage=s.language,r.lookupTitles=!0,app.busy.set(),e.parent.tree.selectedNode||e.parent.tree.selectFirstNode(),app.title!=i18n.LblReader&&(e.resCreClasses.length=0,s.cache.get("resourceClass",s.resourceClasses).forEach((t=>{let i=LIB.itemBy(s.myPermissions,"item",t.id);i?t.permissionVector=i.permissionVector:(i=LIB.itemBy(s.myPermissions,"item",s.id),t.permissionVector=i?i.permissionVector:noPermission),!t.permissionVector.C||t.instantiation&&!t.instantiation.includes(SpecifInstantiation.User)||e.resCreClasses.push(t.id)})),e.resCre=e.resCreClasses.length>0),void n().then(o,(t=>{744==t.status?(e.parent.tree.selectFirstNode(),n().then(o,l)):l(t)}));function n(){var t=e.parent.tree.selectedNode,i=[];a=[],t&&!r.urlParams&&setUrlParams({project:s.id,view:e.view,node:t.id});for(var n=CONFIG.objToGetCount-1;t&&n>-1;n--)i.push(t.ref),a.push(t),t=t.getNextVisibleNode();return s.readItems("resource",i)}function o(s){for(var n=s.length-1;n>-1;n--)s[n].order=a[n].order;(e.resources.update(s)||r&&r.forced)&&$(e.view).html(e.resources.render()),i=e.resources.selected(),$(e.view).prepend(function(){var s='<div class="btn-group" role="group" style="position:absolute;top:1em;right:1em;z-index:900">';!e.resCre||i&&!i.isUserInstantiated()?s+='<button disabled class="btn btn-light" >'+i18n.IcoAdd+"</button>":s+='<button class="btn btn-success" onclick="'+t+'.editResource(\'create\')" data-toggle="popover" title="'+i18n.LblAddObject+'" >'+i18n.IcoAdd+"</button>";if(!i)return s+"</div>";e.resCre&&i.isUserInstantiated()?s+='<button class="btn btn-success" onclick="'+t+'.editResource(\'clone\')" data-toggle="popover" title="'+i18n.LblCloneObject+'" >'+i18n.IcoClone+"</button>":s+='<button disabled class="btn btn-light" >'+i18n.IcoClone+"</button>";i.hasPropertyWithUpdatePermission?s+='<button class="btn btn-primary" onclick="'+t+'.editResource(\'update\')" data-toggle="popover" title="'+i18n.LblUpdateObject+'" >'+i18n.IcoEdit+"</button>":s+='<button disabled class="btn btn-primary" >'+i18n.IcoEdit+"</button>";s+='<button disabled class="btn btn-light" >'+i18n.IcoComment+"</button>",i.rC.permissionVector.D&&i.isUserInstantiated()?s+='<button class="btn btn-danger" onclick="'+t+'.confirmDeletion()" data-toggle="popover" title="'+i18n.LblDeleteObject+'" >'+i18n.IcoDelete+"</button>":s+='<button disabled class="btn btn-light" >'+i18n.IcoDelete+"</button>";return s+"</div>"}()),app.busy.reset()}function l(e){LIB.stdError(e),app.busy.reset()}},e.editResource=t=>{if(!app[CONFIG.resourceEdit])throw Error("'editResource' clicked, but module '"+CONFIG.resourceEdit+"' is not ready.");app[CONFIG.resourceEdit].show({eligibleResourceClasses:e.resCreClasses,mode:t})},e.confirmDeletion=()=>{const s="delNode";$("#"+s).remove(),$("body").append('<div class="modal fade" id="'+s+'" tabindex="-1" ><div class="modal-dialog" ><div class="modal-content"><div class="modal-header bg-danger text-white" ><h5 class="modal-title" >'+i18n.MsgConfirm+'</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" > </button></div><div class="modal-body" >'+i18n.lookup("MsgConfirmObjectDeletion",e.parent.tree.selectedNode.name)+'</div><div class="modal-footer" ><button type="button" class="btn btn-secondary" data-bs-dismiss="modal" >'+i18n.BtnCancel+'</button><button type="button" class="btn btn-danger" onclick="'+t+'.deleteSelectedNode()">'+i18n.BtnDeleteObjectRef+"</button></div></div></div></div>");const i=document.getElementById(s);(r=new bootstrap.Modal(i)).show()},e.deleteSelectedNode=()=>{const t=e.parent.tree.selectedNode;console.info("Deleting tree object '"+t.name+"'."),e.parent.tree.selectNode(t.getNextSibling()),app.projects.selected.deleteItems("node",[LIB.makeKey(t)]).then(e.parent.reworkTree,LIB.stdError),r.hide()},e.relatedItemClicked=t=>{e.parent.tree.selectNodeByRef(LIB.makeKey(t)),document.getElementById(CONFIG.objectList).scrollTop=0},e})),moduleManager.construct({view:"#"+CONFIG.relations},(e=>{const t=e.loadAs,s="app."+t;var i,r,a,n,o=!1;return e.staCreClasses={subjectClasses:[],objectClasses:[]},e.staCre=!1,e.staDelClasses=[],e.staDel=!1,e.init=()=>!0,e.clear=()=>{},e.hide=()=>{$(e.view).empty()},e.show=l=>{if(e.parent.showLeft.set(),e.parent.showTree.set(),i=app.projects.selected,r=i.cache,"object"!=typeof l&&(l={}),l.targetLanguage=i.language,l.lookupTitles=l.lookupValues=!0,e.parent.tree.selectedNode||e.parent.tree.selectFirstNode(),e.parent.tree.selectedNode){app.busy.set();var c=e.parent.tree.selectedNode;return c&&!l.urlParams&&setUrlParams({project:i.id,view:e.view,node:c.id}),void i.readStatementsOf(c.ref,{dontCheckStatementVisibility:i.aDiagramWithoutShowsStatementsForEdges(),asSubject:!0,asObject:!0}).then((e=>(n=new CGraph({resources:[c.ref]}),e.forEach(u),i.readItems("resource",n.resources)))).then((t=>{var s;return t.forEach((e=>{d(n,e)})),a=LIB.itemByKey(t,c.ref),s=a,app.title!=i18n.LblReader&&s&&(e.staCreClasses.subjectClasses.length=0,e.staCreClasses.objectClasses.length=0,i.cache.get("statementClass",i.statementClasses).forEach((t=>{let r=LIB.itemBy(i.myPermissions,"item",t.id);r?t.permissionVector=r.permissionVector:(r=LIB.itemBy(i.myPermissions,"item",i.id),t.permissionVector=r?r.permissionVector:noPermission),t.instantiation&&!t.instantiation.includes(SpecifInstantiation.User)||(t.permissionVector.C&&((!t.subjectClasses||LIB.indexByKey(t.subjectClasses,s.class)>-1)&&e.staCreClasses.subjectClasses.push(LIB.keyOf(t)),(!t.objectClasses||LIB.indexByKey(t.objectClasses,s.class)>-1)&&e.staCreClasses.objectClasses.push(LIB.keyOf(t))),t.permissionVector.D&&e.staDelClasses.push(t.id))})),e.staCre=e.staCreClasses.subjectClasses.length>0||e.staCreClasses.objectClasses.length>0,e.staDel=e.staDelClasses.length>0),function(t,s){return new Promise(((n,o)=>{CONFIG.findMentionedObjects&&t||n([]);let l,c=[],d=0,u=Object.assign({},s,{addIcon:!1}),p=r.instanceTitleOf(t,u),h=new RegExp(CONFIG.titleLinkBegin+p.escapeRE()+CONFIG.titleLinkEnd,"i");e.parent.tree.iterate((e=>(d++,i.readItems("resource",[e.ref]).then((e=>{let s,i=e[0],o=r.instanceTitleOf(i,u);o&&o.length>CONFIG.titleLinkMinLength-1&&i.id!=t.id&&(l=new RegExp(CONFIG.titleLinkBegin+o.escapeRE()+CONFIG.titleLinkEnd,"i"),t.properties.forEach((e=>{e.values.length>0&&(s=LIB.dataTypeOf(e.class,r),s&&s.type==XsDataType.String&&!s.enumeration&&l.test(LIB.languageTextOf(e.values[0],u))&&a(c,t,i)&&c.push({title:CONFIG.staClassMentions,subject:t,object:i}))})),i.properties.forEach((e=>{s=LIB.dataTypeOf(e.class,r),s&&s.type==XsDataType.String&&!s.enumeration&&h.test(LIB.languageTextOf(e.values[0],u))&&a(c,i,t)&&c.push({title:CONFIG.staClassMentions,subject:i,object:t})}))),--d<1&&n(c)}),o),!0)))}));function a(e,t,s){for(var i of e)if(i.subject.id==t.id&&i.object.id==s.id)return!1;return!0}}(a,l)})).then((i=>{o||i.forEach(u),function(s){if(s.statements.length<1)return $(e.view).html('<div class="notice-default">'+i18n.MsgNoRelatedObjects+"</div>"),void(o=!1);let i=new CGraphOptions({canvas:e.view.substring(1),titleProperties:CONFIG.titleProperties,onDoubleClick:e=>{"string"==typeof e.target.resource&&app[t].relatedItemClicked(e.target.resource,e.target.statement)},nodeColorFocus:"#3B71CA",nodeColor:o?"#f8d7da":"#bbd2f0"});s.show(i),$(e.view).prepend('<div style="position:absolute;left:1em;z-index:900">'+(o?'<span class="notice-danger" >'+i18n.MsgClickToDeleteRel:'<span class="notice-default" >'+i18n.MsgClickToNavigate)+"</span></div>")}(n),$(e.view).prepend(function(){if(!a)return"";var t='<div id="linkBtns" class="btn-group" role="group" style="position:absolute;top:1em;right:1em;z-index:900">';if(o)return t+'<button class="btn btn-light" onclick="'+s+'.toggleModeStaDel()" >'+i18n.BtnTerminate+"</button></div>";e.staCre?t+='<button class="btn btn-success" onclick="'+s+'.linkResource()" data-toggle="popover" title="'+i18n.LblAddRelation+'" >'+i18n.IcoAdd+"</button>":t+='<button disabled class="btn btn-light" >'+i18n.IcoAdd+"</button>";e.staDel&&n.statements.length>0?t+='<button class="btn btn-danger '+(o?"active":"")+'" onclick="'+s+'.toggleModeStaDel()" data-toggle="popover" title="'+i18n.LblDeleteRelation+'" >'+i18n.IcoDelete+"</button>":t+='<button disabled class="btn btn-light" >'+i18n.IcoDelete+"</button>";return t+"</div>"}()),app.busy.reset()})).catch((e=>{LIB.stdError(e),app.busy.reset()}))}function d(e,t){e.add({resources:[{id:t.id,title:r.instanceTitleOf(t,Object.assign({},l,{addIcon:!0,neverEmpty:!0}))}]})}function u(e){CONFIG.hiddenStatements.includes(e.title||LIB.classTitleOf(e.class,r.statementClasses,{}))||(!function(e,t){let s=LIB.titleOf(t,l)||LIB.valueByTitle(t,CONFIG.propClassType,r,l)||LIB.classTitleOf(t.class,r.statementClasses,l);e.add({statements:[{id:t.id,title:s,subject:t.subject.id,object:t.object.id}]})}(n,e),d(n,c.ref.id==e.subject.id?e.object:e.subject))}e.parent.emptyTab(e.view)},e.linkResource=()=>{if(!app[CONFIG.resourceLink])throw Error("'linkResource' clicked, but module '"+CONFIG.resourceLink+"' is not ready.");app[CONFIG.resourceLink].show({eligibleStatementClasses:e.staCreClasses})},e.toggleModeStaDel=()=>{o=!o,e.parent.doRefresh({forced:!0})},e.relatedItemClicked=(t,s)=>{o?i.deleteItems("statement",[LIB.makeKey(s)]).then((()=>{e.parent.doRefresh({forced:!0})}),LIB.stdError):(e.parent.tree.selectNodeByRef(LIB.makeKey(t)),document.getElementById(CONFIG.objectList).scrollTop=0)},e}));