"use strict";
/*!	Transformation Library for SpecIF data for import to and export from the internal data structure.
    Dependencies: jQuery 3.5+
    (C)copyright enso managers gmbh (http://enso-managers.de)
    Author: se@enso-managers.de, Berlin
    License and terms of use: Apache 2.0 (http://www.apache.org/licenses/LICENSE-2.0)
    We appreciate any correction, comment or contribution as Github issue (https://github.com/enso-managers/SpecIF-Tools/issues)
*/class CSpecifItemNames{constructor(e){switch(e){case"0.10.2":case"0.10.3":this.rClasses="resourceTypes",this.sClasses="statementTypes",this.hClasses="hierarchyTypes",this.pClasses="propertyTypes",this.sbjClasses="subjectTypes",this.objClasses="objectTypes",this.rClass="resourceType",this.sClass="statementType",this.hClass="hierarchyType",this.pClass="propertyType",this.rs="resources",this.sts="statements",this.r="resource";break;case"0.10.4":case"0.10.5":case"0.10.6":case"0.11.2":this.hClasses="hierarchyClasses",this.hClass="class";default:this.rClasses="resourceClasses",this.sClasses="statementClasses",this.pClasses="propertyClasses",this.sbjClasses="subjectClasses",this.objClasses="objectClasses",this.rClass="class",this.sClass="class",this.pClass="class",this.rs="resources",this.sts="statements",this.r="resource"}"string"==typeof e&&e.startsWith("0.")?(this.frct="accuracy",this.minI="min",this.maxI="max"):(this.frct="fractionDigits",this.minI="minInclusive",this.maxI="maxInclusive");let t=e.split(".").map((e=>parseInt(e)));t[0]<1||1==t[0]&&t[1]<2?this.nds="hierarchies":this.nds="nodes"}}class CSpecIF{constructor(){this.dataTypes=[],this.propertyClasses=[],this.resourceClasses=[],this.statementClasses=[],this.files=[],this.resources=[],this.statements=[],this.nodes=[];let e=app.standards.makeTemplate();for(let t in e)this[t]=e[t]}isValid(e){return e||(e=this),!(!e.$schema&&!["0.10.2","0.10.3","0.10.4","0.10.5","0.10.6","0.10.8","0.11.2","0.11.8"].includes(e.specifVersion))&&("string"==typeof e.id&&e.id.length>0)}isOntology(e){return e.id.includes("Ontology")&&Array.isArray(e.title)&&e.title[0]&&e.title[0].text&&e.title[0].text.includes("Ontology")}set(e,t){return new Promise(((s,a)=>{let i;this.isValid(e)?(i=this.toInt(e,t),0==i.status?t&&t.noCheck?s(this):this.check(this,t).then((()=>{s(this)}),a):a(i)):(i=new resultMsg({status:999,statusText:"SpecIF input is not valid or version is not supported."}).warn(),a(i))}))}get(e){return this.toExt(e)}check(e,t){return new Promise(((s,a)=>{let i;if(this.isValid(e)){if(!e.$schema||e.$schema.includes("v1.0"))throw"Programming Error: Inexpected check of SpecIF data set < v1.1";import((LIB.useRemotePath()?CONFIG.remotePath:CONFIG.localPath)+"CCheck.mjs").then((e=>{LIB.httpGet({url:(LIB.useRemotePath()?CONFIG.remotePath:CONFIG.localPath)+"schema",responseType:"arraybuffer",withCredentials:!1,done:r,fail:()=>{a(new resultMsg({status:903,statusText:"Schema not found"}))}}),i=new e.CCheck})).catch((e=>{console.error(e),a(new resultMsg({status:903,statusText:"Schema- and constraint-check nof found."}))}))}else a(new resultMsg({status:999,statusText:"No SpecIF data provided for checking"}));return;function r(r){if("function"!=typeof i.checkSchema||"function"!=typeof i.checkConstraints)throw Error("Standard routines checkSchema and/or checkConstraints are not available.");{let n=JSON.parse(LIB.ab2str(r.response));n.$schema="http://json-schema.org/draft-04/schema#";let l=i.checkSchema(e,{schema:n});if(0==l.status&&(l=i.checkConstraints(e,t),0==l.status))return void s(e);console.info("The invalid SpecIF data set: ",e),a(l)}}}))}toInt(e,t){(this.isOntology(e)||e.id.startsWith("P-DDP-"))&&(t.normalizeTerms=!1);let s=this,a=new CSpecifItemNames(LIB.versionOf(e));console.info("References are imported *without* revision to ascertain that updates of the referenced element do not break the link. (References without revision always relate to the latest revision of the referenced element.)");try{this.dataTypes=LIB.forAll(e.dataTypes,(function(e){var s=i(e);switch(s.title=o("propertyClass",e.title),s.type="xs:enumeration"==e.type?XsDataType.String:e.type,e.type){case XsDataType.Double:s.fractionDigits=e[a.frct],s.minInclusive=e[a.minI],s.maxInclusive=e[a.maxI];break;case XsDataType.Integer:s.minInclusive=e[a.minI],s.maxInclusive=e[a.maxI];break;case"xhtml":case XsDataType.String:"number"==typeof e.maxLength&&(s.maxLength=e.maxLength)}e.enumeration&&(s.enumeration=e.type==XsDataType.String&&t.normalizeTerms?e.enumeration.map(r):e.enumeration);e.values&&(s.enumeration=e.values.map((e=>{let s=Array.isArray(e.value)?e.value:[{text:e.value||e.title||""}];return{id:e.id,value:t.normalizeTerms?s.map(c):s}})));return s;function r(e){return{id:e.id,value:e.value.map(c)}}})),this.propertyClasses=LIB.forAll(e.propertyClasses,r),this.resourceClasses=LIB.forAll(e[a.rClasses],(function(e){var t=n(e);t.title=o("resourceClass",e.title);let s=app.ontology.getIcon("resourceClass",t.title);(s||e.icon)&&(t.icon=s||e.icon);"boolean"==typeof e.isHeading?t.isHeading=e.isHeading:app.ontology.headings.includes(e.title)&&(t.isHeading=!0);t.propertyClasses.length<0&&console.warn('The resourceClass with id="'+e.id+'" does not specify any propertyClasses.');return t})),this.statementClasses=LIB.forAll(e[a.sClasses],(function(e){var t=n(e);t.title=o("statementClass",e.title);let s=app.ontology.getIcon("statementClass",t.title);(s||e.icon)&&(t.icon=s||e.icon);e.isUndirected&&(t.isUndirected=e.isUndirected);e[a.sbjClasses]&&(t.subjectClasses=e[a.sbjClasses].map((e=>LIB.makeKey(e.id||e))));e[a.objClasses]&&(t.objectClasses=e[a.objClasses].map((e=>LIB.makeKey(e.id||e))));return t})),a.hClasses&&(this.resourceClasses=this.resourceClasses.concat(LIB.forAll(e[a.hClasses],(function(e){var t=n(e);return t.title=o("resourceClass",e.title),t.isHeading=!0,t})))),this.files=LIB.forAll(e.files,(function(e){var t=i(e);t.title=(e.title?e.title:e.id).replace(/\\/g,"/"),e.revision&&(t.revision="number"==typeof e.revision?e.revision.toString():e.revision);e.blob?(t.type=e.blob.type||e.type||LIB.attachment2mediaType(t.title),t.blob=e.blob):e.dataURL?(t.type=e.type||LIB.attachment2mediaType(t.title),t.dataURL=e.dataURL):t.type=e.type;return t})),this.resources=LIB.forAll(e[a.rs],(function(e){return l(e)})),this.statements=LIB.forAll(e[a.sts],(function(e){var t=l(e);t.subject=LIB.makeKey(e.subject.id||e.subject),t.object=LIB.makeKey(e.object.id||e.object),e.resourceToLink&&(t.resourceToLink=e.resourceToLink);return t})),this.nodes=LIB.forAll(e[a.nds],(function(t){var r;if(a.hClasses){var n=l(t);n.class=LIB.makeKey(t[a.hClass].id||t[a.hClass]),s.resources.push(n),r={id:CONFIG.prefixN+n.id,resource:LIB.keyOf(n),changedAt:LIB.addTimezoneIfMissing(t.changedAt||e.changedAt)||(new Date).toISOString()},t.revision&&(r.revision="number"==typeof t.revision?t.revision.toString():t.revision),t.changedBy&&(r.changedBy=t.changedBy)}else(r=i(t)).resource=LIB.makeKey(t.resource.id||t.resource),t.predecessor&&(r.predecessor=LIB.makeKey(t.predecessor.id||t.predecessor));return r.nodes=LIB.forAll(t.nodes,o),r;function o(t){var s={id:t.id,resource:LIB.makeKey(t[a.r].id||t[a.r]),changedAt:LIB.addTimezoneIfMissing(t.changedAt||e.changedAt)||(new Date).toISOString()};return t.revision&&(s.revision="number"==typeof t.revision?t.revision.toString():t.revision),t.changedBy&&(s.changedBy=t.changedBy),t.nodes&&(s.nodes=LIB.forAll(t.nodes,o)),s}})),this.dataTypes=LIB.forAll(this.dataTypes,(e=>{switch(e.type){case"xs:enumeration":case"xhtml":e.type=XsDataType.String}return e}))}catch(t){let s="Error when importing the project '"+LIB.displayValueOf(e.title,{targetLanguage:e.language||browser.language})+"': "+t;return console.error("Rejected input: ",e),new resultMsg({status:904,statusText:s})}return e.rights&&(this.rights={title:e.rights.title,url:e.rights.url}),e.generator&&(this.generator=e.generator),e.generatorVersion&&(this.generatorVersion=e.generatorVersion),e.createdBy&&(this.createdBy=e.createdBy,e.createdBy.email&&e.createdBy.email.value&&(this.createdBy.email=e.createdBy.email.value)),e.createdAt&&(this.createdAt=LIB.addTimezoneIfMissing(e.createdAt)),e.description&&(this.description=p(e.description)),e.title&&(this.title=p(e.title)),this.id=e.id,new resultMsg({status:0,statusText:"SpecIF data has been successfully transformed!"});function i(e){var t={id:e.id?e.id.toSpecifId():void 0,changedAt:LIB.addTimezoneIfMissing(e.changedAt||"1970-01-01T00:00:00Z")};return e.description&&(t.description=p(e.description)),e.revision&&(t.revision="number"==typeof e.revision?e.revision.toString():e.revision),e.replaces&&(t.replaces=e.replaces),e.changedBy&&(t.changedBy=e.changedBy),t}function r(t){var a=i(t);a.title=o("propertyClass",t.title),a.dataType=LIB.makeKey(t.dataType.id||t.dataType);let r=LIB.itemByKey(e.dataTypes,a.dataType);if(!r)throw"The dataType "+a.dataType.id+" for propertyClass "+a.id+" has not been found.";if("boolean"==typeof t.multiple?a.multiple=t.multiple:r.multiple&&(a.multiple=!0),t.required&&(a.required=!0),"boolean"!=typeof t.multiLanguage||t.multiLanguage||(a.singleLanguage=!0),t.singleLanguage&&(a.singleLanguage=!0),r=LIB.itemByKey(s.dataTypes,a.dataType),t.value||t.values){let e=u(t,r);e.length>0&&(a.values=e)}return r.type==XsDataType.String&&(app.ontology.propertyClassIsFormatted(a.title)?a.format=SpecifTextFormat.Xhtml:a.format="string"==typeof t.format&&t.format==SpecifTextFormat.Xhtml?SpecifTextFormat.Xhtml:SpecifTextFormat.Plain),t.unit&&(a.unit=t.unit),a}function n(e){var t=i(e);if(e.extends&&(t.extends=e.extends.id?e.extends:LIB.makeKey(e.extends)),e.creation&&(t.instantiation=e.creation),e.instantiation&&(t.instantiation=e.instantiation),t.instantiation){let e=t.instantiation.indexOf("manual");e>-1&&t.instantiation.splice(e,1,"user")}return Array.isArray(e[a.pClasses])&&e[a.pClasses].length>0?"object"==typeof e[a.pClasses][0]&&null==e[a.pClasses][0].dataType?t.propertyClasses=e.propertyClasses.map((e=>LIB.makeKey(e.id))):"string"==typeof e[a.pClasses][0]?t.propertyClasses=e[a.pClasses].map((e=>LIB.makeKey(e.id||e))):(t.propertyClasses=[],e[a.pClasses].forEach((e=>{let a=r(e);s.propertyClasses.push(a),t.propertyClasses.push(LIB.makeKey(a.id))}))):t.propertyClasses=[],t}function l(e){let t=e.subject?LIB.makeKey(e[a.sClass].id||e[a.sClass]):e.nodes?LIB.makeKey(e[a.hClass].id||e[a.hClass]):LIB.makeKey(e[a.rClass].id||e[a.rClass]);var i={id:e.id,class:t,changedAt:LIB.addTimezoneIfMissing(e.changedAt)};return e.alternativeIds&&(i.alternativeIds=e.alternativeIds.map((e=>LIB.makeKey(e)))),e.changedBy&&(i.changedBy=e.changedBy),e.revision&&(i.revision="number"==typeof e.revision?e.revision.toString():e.revision),e.replaces&&(i.replaces=e.replaces),e.properties&&e.properties.length>0&&(i.properties=LIB.forAll(e.properties,(e=>function(e){if(Array.isArray(e.values)&&e.values.length>0||e.value){var t={class:LIB.makeKey(e[a.pClass].id||e[a.pClass])},i=LIB.dataTypeOf(t.class,s);if(t.values=u(e,i),t.values.length>0)return t}}(e)))),[{name:"description",nativePrp:e.description,tiL:CONFIG.descProperties,cl:CONFIG.propClassDesc},{name:"title",nativePrp:e.title,tiL:CONFIG.titleProperties,cl:CONFIG.propClassTitle}].forEach((e=>{e.nativePrp&&function(e,t){if(Array.isArray(t.properties))for(var a of t.properties)if(e.includes(LIB.classTitleOf(a.class,s.propertyClasses)))return!1;return!0}(e.tiL,i)&&(LIB.addProperty(i,{class:{id:r(e,t)},values:[p(e.nativePrp)]}),console.info("Added a "+e.name+" property to element with id '"+i.id+"'"))})),i;function r(t,a){let i=LIB.itemByKey(e.subject?s.statementClasses:s.resourceClasses,a);for(var r of i.propertyClasses){let e=LIB.itemByKey(s.propertyClasses,r);if(e&&t.tiL.includes(e.title))return e.id}for(var n of t.tiL){let e=LIB.itemBy(s.propertyClasses,"title",n);if(e)return LIB.addPCReference(i,{id:e.id}),e.id}let l=LIB.addClassesTo(t.cl,s).id;return LIB.addPCReference(i,{id:l}),l}}function o(e,s){let a=LIB.cleanValue("string"==typeof s?s:s[0].text);return t.normalizeTerms?app.ontology.normalize(e,a):a}function c(e){let t={text:app.ontology.normalize("all",e.text)};return e.language&&(t.language=e.language),t}function u(e,t){if(Array.isArray(e.values)){return e.values.map(i).filter((e=>!!e));function i(a){if(a){if(t.enumeration){if("string"==typeof a.id)return a;if("string"==typeof a)return{id:a};throw new Error("Property value with an enumerated data type must reference a valid value id.")}switch(t.type){case XsDataType.String:if("string"==typeof a){if(a.length<1)return;console.warn("With SpecIF v1.1 and later, a property of type '"+XsDataType.String+"' should be a multi-language text."),a=LIB.makeMultiLanguageValue(LIB.uriBack2slash(LIB.cleanValue(a)))}return LIB.multiLanguageValueHasContent(a)?a.map((e=>{let t={text:LIB.uriBack2slash(LIB.cleanValue(e.text))};return e.language&&(t.language=e.language),t})).filter((e=>!!e.text)):void 0;case XsDataType.DateTime:if("string"==typeof a)return s(LIB.cleanValue(a));console.warn("Datetime value ",a," of property with class "+e.class.id+" must be a string.");break;case XsDataType.Boolean:switch(typeof a){case"string":if(CONFIG.valuesTrue.includes(a))return"true";if(CONFIG.valuesFalse.includes(a))return"false";break;case"number":if(console.warn("Boolean value ",a," of property with class "+e.class.id+" is not a string, but will be transformed to a string."),0==a)return"false";if(1==a)return"true";break;case"boolean":return console.warn("Boolean value ",a," of property with class "+e.class.id+" is not a string, but will be transformed to a string."),a?"true":"false"}console.warn("Unknown boolean value ",a," of property with class "+e.class.id+" skipped.");break;case XsDataType.Integer:case XsDataType.Double:switch(typeof a){case"string":return LIB.cleanValue(a);case"number":return console.warn("Number value ",a," of property with class "+e.class.id+" is not a string, but will be transformed to a string."),a.toString()}console.warn("Unknown number value ",a," of property with class "+e.class.id+" skipped.");break;case XsDataType.ComplexType:console.warn("Complex types not yet supported;",a,"skipped.");break;default:return LIB.cleanValue(a)}}}}if(!LIB.isString(e.value)&&!LIB.isMultiLanguageValue(e.value))throw"Invalid property with class "+e[a.pClass]+".";switch(t.type){case XsDataType.String:case"xhtml":if(t.enumeration){return LIB.cleanValue(e.value).split(",").map((e=>({id:e.trim()})))}return[p(Array.isArray(e.value)?e.value.map((e=>(e.text=LIB.uriBack2slash(LIB.cleanValue(e.text)),e))):LIB.uriBack2slash(LIB.cleanValue(e.value)))];case XsDataType.DateTime:return[s(LIB.cleanValue(e.value))];case XsDataType.Boolean:return CONFIG.valuesTrue.includes(LIB.cleanValue(e.value))?["true"]:CONFIG.valuesFalse.includes(LIB.cleanValue(e.value))?["false"]:(console.warn("Unknown boolean value "+LIB.cleanValue(e.value)+" skipped."),[]);default:return[LIB.cleanValue(e.value)]}function s(e){return LIB.addTimezoneIfMissing(e.replace(/(\d\+|\d-)(\d\d)(\d\d)$/,((e,t,s,a)=>t+s+":"+a)))}}function p(e){return"string"==typeof e?[{text:LIB.cleanValue(e)}]:LIB.cleanValue(e)}}toExt(e){return new Promise(((t,s)=>{let a=this,i=0,r=Object.assign(app.standards.makeTemplate(),{id:this.id,title:LIB.selectTargetLanguage(this.title,e)});function n(e){let t=LIB.valuesByTitle(e,[CONFIG.propClassType],a);return t.length<1||LIB.languageTextOf(t[0],{targetLanguage:"default"})!=CONFIG.reqifHierarchyRoot}if(e&&e.createHierarchyRootIfMissing)for(var l=this.nodes.length-1;l>-1;l--){if(n(LIB.itemByKey(this.resources,this.nodes[l].resource))){let e=app.ontology.generateSpecifClasses({terms:[CONFIG.resClassFolder],referencesWithoutRevision:!0,referencesWithoutRevision:!0,delta:!0});["dataTypes","propertyClasses","resourceClasses"].forEach((t=>{LIB.cacheL(r[t],e[t])}));break}}for(var o of(LIB.multiLanguageValueHasContent(this.description)&&(r.description=LIB.selectTargetLanguage(this.description,e)),this.language&&(r.language=this.language),this.rights&&this.rights.title&&this.rights.url&&(r.rights=this.rights),app.me&&app.me.email?(r.createdBy={familyName:app.me.lastName,givenName:app.me.firstName,email:app.me.email},app.me.organization&&(r.createdBy.org={organizationName:app.me.organization})):this.createdBy&&this.createdBy.email&&(r.createdBy={familyName:this.createdBy.familyName,givenName:this.createdBy.givenName,email:this.createdBy.email},this.createdBy.org&&this.createdBy.org.organizationName&&(r.createdBy.org=this.createdBy.org)),LIB.cacheL(r.dataTypes,LIB.forAll(this.dataTypes,(function(t){var s=u(t);switch(s.type=t.type,t.type){case XsDataType.Double:t.fractionDigits&&(s.fractionDigits=t.fractionDigits);case XsDataType.Integer:"number"==typeof t.minInclusive&&(s.minInclusive=t.minInclusive),"number"==typeof t.maxInclusive&&(s.maxInclusive=t.maxInclusive);break;case XsDataType.String:t.maxLength&&(s.maxLength=t.maxLength)}t.enumeration&&(t.type==XsDataType.String&&e.targetLanguage?s.enumeration=t.enumeration.map((t=>{let s=LIB.languageTextOf(t.value,e);return e.lookupValues&&(s=app.ontology.localize(s,e)),{id:t.id,value:LIB.makeMultiLanguageValue(s)}})):s.enumeration=t.enumeration);return s}))),LIB.cacheL(r.propertyClasses,LIB.forAll(this.propertyClasses,(function(e){var t=u(e);e.values&&(t.values=e.values);t.dataType=e.dataType,e.required&&(t.required=!0);e.multiple&&(t.multiple=!0);e.singleLanguage&&(t.singleLanguage=!0);e.format&&(t.format=e.format);e.values&&(t.values=e.values);e.unit&&(t.unit=e.unit);return t}))),LIB.cacheL(r.resourceClasses,LIB.forAll(this.resourceClasses,(function(e){var t=p(e);e.isHeading&&(t.isHeading=!0);if(Array.isArray(t.propertyClasses)&&t.propertyClasses.length>0||LIB.isKey(t.extends))return t;console.error('Skipping resourceClass with id="'+e.id+'" on export, because it does not specify any propertyClasses.')}))),LIB.cacheL(r.statementClasses,LIB.forAll(this.statementClasses,(function(e){var t=p(e);e.isUndirected&&(t.isUndirected=e.isUndirected);e.subjectClasses&&e.subjectClasses.length>0&&(t.subjectClasses=e.subjectClasses);e.objectClasses&&e.objectClasses.length>0&&(t.objectClasses=e.objectClasses);return t}))),this.files))o.blob&&(i++,y(o).then((e=>{r.files.push(e),--i<1&&c()}),s));return LIB.cacheL(r.resources,LIB.forAll(this.resources,(function(t){return d(t,Object.assign({},e,{dontLookupHeadings:!0}))}))),LIB.cacheL(r.statements,LIB.forAll(this.statements,(function(t){var s=d(t,e);return s.subject=t.subject,s.object=t.object,s}))),LIB.cacheL(r.nodes,LIB.forAll(this.nodes,(function(t){let s=LIB.itemByKey(a.resources,t.resource);if(e&&e.createHierarchyRootIfMissing&&n(s)){console.info("Adding hierarchy root to hierarchy with id '"+t.id+"'");const e=LIB.replacePrefix(CONFIG.prefixHR,t.id),s=[];return s.push({class:LIB.makeKey("PC-Name"),values:[a.title]}),LIB.multiLanguageValueHasContent(a.description)&&s.push({class:LIB.makeKey("PC-Description"),values:[a.description]}),s.push({class:LIB.makeKey("PC-Type"),values:[[{text:CONFIG.reqifHierarchyRoot}]]}),r.resources.push({id:e,class:LIB.makeKey("RC-Folder"),properties:s,changedAt:(new Date).toISOString()}),{id:CONFIG.prefixN+e,resource:LIB.makeKey(e),nodes:[h(t)],changedAt:(new Date).toISOString()}}return h(t)}))),void(i<1&&c());function c(){t(r)}function u(t){var s={id:t.id,changedAt:t.changedAt};return t.title&&(s.title=LIB.titleOf(t,e)),LIB.multiLanguageValueHasContent(t.description)&&(s.description=LIB.makeMultiLanguageValue(LIB.languageTextOf(t.description,e))),t.revision&&(s.revision=t.revision),t.replaces&&(s.replaces=t.replaces),t.changedBy&&t.changedBy!=CONFIG.userNameAnonymous&&(s.changedBy=t.changedBy),s}function p(e){var t=u(e);return e.icon&&(t.icon=e.icon),e.instantiation&&(t.instantiation=e.instantiation),e.extends&&(t.extends=e.extends),e.propertyClasses&&e.propertyClasses.length>0&&(t.propertyClasses=e.propertyClasses),t}function d(e,t){var s=u(e);s.class=e.class,e.alternativeIds&&(s.alternativeIds=e.alternativeIds);let a=e.properties;return a&&a.length>0&&(s.properties=a.map((e=>function(e,t){if(t.showEmptyProperties||Array.isArray(e.values)&&e.values.length>0){let o=LIB.itemByKey(r.propertyClasses,e.class);if(Array.isArray(t.skipProperties))for(var s of t.skipProperties)if(s.title==o.title&&(null==s.value||s.value==LIB.displayValueOf(e.values[0],t)))return;var a={class:e.class,values:[]};let c=LIB.itemByKey(r.dataTypes,o.dataType);if(c.type==XsDataType.String&&!c.enumeration){if(t.targetLanguage){let s;for(var i of e.values)s=LIB.languageTextOf(i,t),RE.vocabularyTerm.test(s)?!t.lookupValues||t.dontLookupHeadings&&CONFIG.titleProperties.map((e=>app.ontology.localize(e,t))).includes(o.title)||(s=app.ontology.localize(s,t)):o.format==SpecifTextFormat.Plain?s=s.replace(/^\s+/,"").stripHTML():(s=s.makeHTML(t),t.allDiagramsAsImage&&(s=l(s))),a.values.push(LIB.makeMultiLanguageValue(s));return a}if(t.allDiagramsAsImage){let t;for(var i of e.values){for(var n of(t=[],i))t.push(n.language?{text:l(n.text),language:n.language}:{text:l(n.text)});a.values.push(t)}return a}}return a.values=e.values,a}return;function l(e){let t=!1;return e.replace(RE.tagObject,((e,s,a)=>(s&&(s=s.replace(RE.attrType,((e,s)=>["application/bpmn+xml"].includes(s)?(t=!0,'type="image/svg+xml"'):e))),t&&(s=s.replace(RE.attrData,((e,t)=>'data="'+t.fileName()+'.svg"'))),"<object "+s+a)))}}(e,t)))),s}function h(e){let t={id:e.id,resource:{id:e.resource.id},changedAt:e.changedAt};return e.nodes&&e.nodes.length>0&&(t.nodes=LIB.forAll(e.nodes,h)),e.revision&&(t.revision=e.revision),t}function y(t){return new Promise((s=>{if(e&&e.preferPng)switch(t.type){case"image/svg+xml":let i=t.title.fileName()+".png";if(LIB.itemByTitle(a.files,i)){console.info("File '"+t.title+"' has a sibling of type PNG");break}function r(){n.width=o.width,n.height=o.height,l.drawImage(o,0,0),n.toBlob((e=>{s({id:t.id,title:i,type:"image/png",h:o.height,w:o.width,blob:e})}),"image/png")}let n=document.createElement("canvas"),l=n.getContext("2d"),o=new Image;o.addEventListener("load",r,!1);const c=new FileReader;return c.addEventListener("loadend",(e=>{o.src="data:image/svg+xml,"+encodeURIComponent(e.target.result)})),c.readAsText(t.blob),void console.info("File '"+t.title+"' transformed to PNG");default:CONFIG.imgTypes.includes(t.type)||console.warn("Cannot transform file '"+t.title+"' of type '"+t.type+"' to a raster image.")}s(t)}))}}))}async save(){const e=(this.title&&this.title[0]&&this.title[0].text?this.title[0].text:this.id)+".specif",t=new Blob([JSON.stringify(this,null,2)],{type:"application/json"});saveAs(t,e),console.info("SpecIF saved as file:",e)}}