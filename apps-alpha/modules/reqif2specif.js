"use strict";
/*!
    ReqIF to SpecIF v1.1 Transformation
    (C)copyright adesso SE, enso managers gmbh (http://enso-managers.de)
    Author: jasmin.droescher@adesso.de, se@enso-managers.de, Berlin
    License and terms of use: Apache 2.0 (http://www.apache.org/licenses/LICENSE-2.0)
    We appreciate any correction, comment or contribution as Github issue (https://github.com/enso-managers/SpecIF-Tools/issues)

    ToDo:
    - transform RELATION-GROUP-TYPES and RELATION-GROUPS
    - extract default values
*/function reqif2Specif(e,t){const r=/\sxmlns:(.*?)=\".*?\"/,n=Object.assign({propType:CONFIG.propClassType,prefixN:"N-"},t),s=function(e){if("string"!=typeof e)return{ok:!0,status:297,statusText:"",response:e,responseType:"document"};const t=(new DOMParser).parseFromString(e,"application/xml");if(t.getElementsByTagName("parsererror").length>0)return{ok:!1,status:898,statusText:"XML parse error: invalid XML document"};return{ok:!0,status:298,statusText:"",response:t,responseType:"document"}}(e);if(!s.ok)return s;const i=s.response;var a,T,E,l;if(!function(e){return e.getElementsByTagName("REQ-IF-HEADER").length>0&&e.getElementsByTagName("REQ-IF-CONTENT").length>0}(i))return{ok:!1,status:899,statusText:"ReqIF data is invalid"};if((a={ok:!0,status:0,statusText:"ReqIF data is valid",responseType:"json"}).response=function(e){let t=e[0].getAttribute("IDENTIFIER");return{id:t,title:e[0].getElementsByTagName("TITLE")[0]&&e[0].getElementsByTagName("TITLE")[0].innerHTML||t,description:e[0].getElementsByTagName("COMMENT")[0]&&e[0].getElementsByTagName("COMMENT")[0].innerHTML||"",generator:"reqif2specif",$schema:"https://specif.de/v1.0/schema.json",createdAt:e[0].getElementsByTagName("CREATION-TIME")[0].innerHTML}}(i.getElementsByTagName("REQ-IF-HEADER")),a.response.dataTypes=(T=i.getElementsByTagName("DATATYPES")).length<1?[]:Array.from(T[0].children,(function(e){let t={id:e.getAttribute("IDENTIFIER"),type:n(e),title:e.getAttribute("LONG-NAME")||"",description:e.getAttribute("DESC")||"",changedAt:e.getAttribute("LAST-CHANGE")||""};return r("MIN","minInclusive"),r("MAX","maxInclusive"),r("MAX-LENGTH","maxLength"),r("ACCURACY","fractionDigits"),e.childElementCount>0&&(t.values=s(e.children)),t;function r(r,n){let s=e.getAttribute(r);s&&(t[n]=Number(s))}function n(e){return{"DATATYPE-DEFINITION-BOOLEAN":"xs:boolean","DATATYPE-DEFINITION-DATE":"xs:dateTime","DATATYPE-DEFINITION-INTEGER":"xs:integer","DATATYPE-DEFINITION-REAL":"xs:double","DATATYPE-DEFINITION-STRING":"xs:string","DATATYPE-DEFINITION-XHTML":"xhtml","DATATYPE-DEFINITION-ENUMERATION":"xs:enumeration"}[e.nodeName]}function s(e){return Array.from(e[0].children,t);function t(e){return{id:e.getAttribute("IDENTIFIER"),value:e.getAttribute("LONG-NAME")||"&#x00ab;undefined&#x00bb;"}}}})),a.response.propertyClasses=function(e){let t=(r=function(e){return Object.assign({},t(e,"ATTRIBUTE-DEFINITION-STRING"),t(e,"ATTRIBUTE-DEFINITION-XHTML"),t(e,"ATTRIBUTE-DEFINITION-ENUMERATION"),t(e,"ATTRIBUTE-DEFINITION-DATE"),t(e,"ATTRIBUTE-DEFINITION-BOOLEAN"),t(e,"ATTRIBUTE-DEFINITION-INTEGER"),t(e,"ATTRIBUTE-DEFINITION-REAL"));function t(e,t){let r=e.getElementsByTagName(t),n={};return Array.from(r,(e=>{if(n[e.getAttribute("IDENTIFIER")]={title:e.getAttribute("LONG-NAME"),dataType:e.children[0].children[0].innerHTML,changedAt:e.getAttribute("LAST-CHANGE")},"ATTRIBUTE-DEFINITION-ENUMERATION"==t){let t=e.getAttribute("MULTI-VALUED");t&&"true"==t.toLowerCase()&&(n[e.getAttribute("IDENTIFIER")].multiple=!0)}})),n}}(e[0]),Object.entries(r).map((e=>{let t={id:e[0],title:e[1].title,dataType:e[1].dataType,changedAt:e[1].changedAt};return e[1].multiple&&(t.multiple=!0),t})));var r;o(t).length<1&&(a.response.dataTypes.push({id:"DT-ShortString-"+a.response.id,type:"xs:string",title:"String[256]",description:"String with length <=256",maxLength:256,changedAt:(new Date).toISOString()}),t.push({id:"PC-Type-"+a.response.id,dataType:"DT-ShortString-"+a.response.id,title:n.propType,description:"The nature or genre of the resource.",changedAt:(new Date).toISOString()}));return t}(i.getElementsByTagName("SPEC-TYPES")),a.response.resourceClasses=u(i.getElementsByTagName("SPEC-TYPES"),["SPECIFICATION-TYPE","SPEC-OBJECT-TYPE"]),a.response.statementClasses=u(i.getElementsByTagName("SPEC-TYPES"),["SPEC-RELATION-TYPE"]),a.response.resources=g("SPEC-OBJECTS").concat(g("SPECIFICATIONS")),a.response.statements=(E=i.getElementsByTagName("SPEC-RELATIONS")).length<1?[]:Array.from(E[0].children,(function(e){let t={id:e.getAttribute("IDENTIFIER"),subject:e.getElementsByTagName("SOURCE")[0].children[0].innerHTML,object:e.getElementsByTagName("TARGET")[0].children[0].innerHTML,changedAt:e.getAttribute("LAST-CHANGE")};t.class=e.getElementsByTagName("TYPE")[0].children[0].innerHTML;let r=e.getElementsByTagName("VALUES");return t.properties=I(r),t})),a.response.hierarchies=(l=i.getElementsByTagName("SPECIFICATIONS")).length<1?[]:Array.from(l[0].getElementsByTagName("SPECIFICATION"),(function(e){let t=e.getAttribute("IDENTIFIER");return{id:n.prefixHR+t,resource:t,changedAt:e.getAttribute("LAST-CHANGE"),nodes:r(e.children)};function r(e){let t=s(e,"CHILDREN")[0];if(t){let e=[];return Array.from(t.children,(t=>{let n=s(t.children,"OBJECT")[0].getElementsByTagName("SPEC-OBJECT-REF")[0].innerHTML;e.push({id:t.getAttribute("IDENTIFIER"),resource:n,changedAt:t.getAttribute("LAST-CHANGE"),nodes:r(t.children)})})),e}}function s(e,t){return Array.from(e).filter((e=>e.nodeName==t))}})),!a.response.title){let e,t="";a.response.nodes.forEach((r=>{e=A(a.response.resources,r.resource),t+=(t.length>0?", ":"")+e.title})),a.response.title=t,console.info("Project title assembled from ReqIF SPECIFICATION roots")}return console.info("reqif2specif",a),a;function o(e){return e.filter((e=>e.title==n.propType)).map((e=>e.id))}function u(e,t){if(e.length<1)return[];const r=[];return Array.from(e[0].children,(e=>{if(t.includes(e.nodeName)){let t=function(e){const t={id:e.getAttribute("IDENTIFIER"),title:e.getAttribute("LONG-NAME")||e.getAttribute("IDENTIFIER"),changedAt:e.getAttribute("LAST-CHANGE")};e.getAttribute("DESC")&&(t.description=e.getAttribute("DESC"));e.getElementsByTagName("SPEC-ATTRIBUTES")[0]&&(t.propertyClasses=r(e.getElementsByTagName("SPEC-ATTRIBUTES")));return t;function r(e){return Array.from(e[0].children,(e=>e.getAttribute("IDENTIFIER")))}}(e);if("SPECIFICATION-TYPE"==e.nodeName){let e=o(a.response.propertyClasses);e.length>0?Array.isArray(t.propertyClasses)?function(e,t){for(let r of e)if(t.includes(r.id))return;e.push(t[0])}(t.propertyClasses,e):t.propertyClasses=[e[0]]:console.error("There is no propertyClass ")}r.push(t)}})),r}function g(e){let t=i.getElementsByTagName(e);return t.length<1?[]:Array.from(t[0].children,(function(t){let r={id:t.getAttribute("IDENTIFIER"),title:t.getAttribute("LONG-NAME")||"",changedAt:t.getAttribute("LAST-CHANGE")};r.class=t.getElementsByTagName("TYPE")[0].children[0].innerHTML;let n=t.getElementsByTagName("VALUES");r.properties=I(n),!r.title&&r.properties.length<1&&(r.title=r.id);if("SPECIFICATIONS"==e){let e=o(a.response.propertyClasses),t={class:e[0],value:"ReqIF:HierarchyRoot"},n=function(e){for(var t of r.properties)if(e.includes(t.class))return t}(e);n?n.value=t.value:r.properties.push(t)}return r}))}function I(e){if(e.length<1)return[];let t=[];return Array.from(e[0].children,(e=>{let n=function(e){let t,n,s={};s.class=e.getElementsByTagName("DEFINITION")[0].children[0].innerHTML,e.getAttribute("THE-VALUE")?(s.value=e.getAttribute("THE-VALUE"),t=A(a.response.propertyClasses,s.class),n=A(a.response.dataTypes,t.dataType),"number"==typeof n.maxLength&&n.maxLength<s.value.length&&(console.warn("Truncated ReqIF Attribute with value '"+s.value+"' to the specified maxLength of "+n.maxLength+" characters"),s.value=s.value.substring(0,n.maxLength))):e.getElementsByTagName("THE-VALUE")[0]?s.value=function(e){let t=i(r,e),n=e.replace(r,"");const s=new RegExp(t,"g");return n=n.replace(s,""),n;function i(e,t){let r="";return t=t.replace(e,(function(e,t){return r=t+":",""})),r}}(e.getElementsByTagName("THE-VALUE")[0].innerHTML):e.getElementsByTagName("VALUES")[0]&&(s.value="",Array.from(e.getElementsByTagName("VALUES")[0].children,(e=>{s.value+=(s.value.length>0?",":"")+e.innerHTML})));return s}(e);n.value&&t.push(n)})),t}function A(e,t){if(e&&t){t=t.trim();for(var r=e.length-1;r>-1;r--)if(e[r].id==t)return e[r]}}}