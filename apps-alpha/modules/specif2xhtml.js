"use strict";
/*!	Create and save a XHTML document using SpecIF data.

    (C)copyright enso managers gmbh(http://enso-managers.de)
    Author: se@enso-managers.de, Berlin
    License: Apache 2.0 (http://www.apache.org/licenses/)
    Dependencies:
    - jszip ( https://github.com/Stuk/jszip ),
    - fileSaver ( https://github.com/eligrey/FileSaver.js ),
    
    We appreciate any correction, comment or contribution as Github issue(https://github.com/enso-managers/SpecIF-Tools/issues)

    Limitations:
    - Accepts data-sets according to SpecIF v1.1.
    - All values must be strings, the language must be selected before calling this function, i.e.languageValues as permitted by the schema are not supported!
    - There must only be one revision per class, resource or statement

    ToDo:
    - Embed font with sufficient UTF-8 coverage: http://www.dpc-consulting.org/epub-praxis-fonts-einbinden-und-verwenden/
    - Control pagination: http://www.dpc-consulting.org/epub-praxis-seitenumbruche-steuern-und-elemente-zusammenhalten/
*/function specif2xhtml(e,t){let i=Object.assign({metaFontSize:"90%",metaFontColor:"#0071B9",linkFontColor:"#0071B9",linkNotUnderlined:!1,preferPng:!1,imgPath:"Images/",placeholder:"%h0kusPokus%",txtPath:"",txtName:"index.html",headingLevels:2},t);e.files&&e.files.forEach((function(e){e.blob?CONFIG.imgTypes.includes(e.type)||console.warn("Format of file '"+e.title+"' is not supported by XHTML."):console.warn("File '"+e.title+"' content is missing.")}));let l=makeXhtml(e,Object.assign({},i,{imgPath:"./"+i.imgPath}));l.fileName=i.fileName||(e.title?e.title[0].text:"undefined"),l.mimetype="text/html",l.styles="body { margin-top:2%; margin-right:2%; margin-bottom:2%; margin-left:2%; font-family:Arial,sans-serif; font-size:100%; font-weight: normal; } \ndiv.max-width-md { max-width: 768px; margin: auto; } \ndiv.max-width-lg { max-width: 992px; margin: auto; } \ndiv, p { margin: 0.9rem 0em 0em 0em; } \ndiv.title { font-size:200%; margin-top:2.4rem } \nul { padding-left: 1.2rem; } \n.inline-label { font-size: 90%; font-style: italic; margin-top:0.9rem; } \np.metaTitle { color: "+i.metaFontColor+"; font-size: "+1.2*i.metaFontSize.replace("%","")+"%; margin-top:0.9rem; } \na { color: "+i.linkFontColor+"; "+(i.linkNotUnderlined?"text-decoration: none; ":"")+"} \ntable { width:100%; border: 1px solid #DDDDDD; border-collapse:collapse; vertical-align:top; margin: 0; padding: 0; } \ntable th { background-color: #DDDDDD; margin: 0; padding: 0 0.2em 0 0.2em; font-size: 90% } \ntable td { border: 1px solid #DDDDDD; margin: 0; padding: 0 0.2em 0 0.2em; font-size: 90% } \ntable.propertyTable, table.statementTable { color: "+i.metaFontColor+"; width:100%; border-left-style: none; border-right-style: none; border-collapse:collapse; margin: 0.9rem 0em 0em 0em; } \ntable.propertyTable td, table.statementTable td { font-size: "+i.metaFontSize+"; border-left-style: none; border-right-style: none; border-collapse:collapse; } \ntd.propertyTitle, td.statementTitle { font-style: italic; } \nh4 { font-family:Arial,sans-serif; font-size:120%; font-weight: normal; margin: 0.9rem 0em 0em 0em; page-break-after: avoid; } \nh3 { font-family:Arial,sans-serif; font-size:140%; font-weight: normal; margin: 1.2rem 0em 0em 0em; page-break-after: avoid; } \nh2 { font-family:Arial,sans-serif; font-size:160%; font-weight: normal; margin: 1.8rem 0em 0em 0em; page-break-after: avoid; } \nh1 { font-family:Arial,sans-serif; font-size:180%; font-weight: normal; margin: 2.4rem 0em 0em 0em; page-break-after: avoid; } \n",l.toc='<h3 style="margin-top:2.4rem;">Content</h3><ul>';let n=1;function o(e){e.level<i.headingLevels+1&&(l.toc+='<li><a href="#'+e.id+'">'+e.title+"</a></li>")}return l.headings.forEach((e=>{if(e.level>n){for(let t=e.level;t>n;t--)l.toc+="<ul>";o(e),n=e.level}else if(e.level==n)o(e);else{for(let t=n;t>e.level;t--)l.toc+="</ul>";o(e),n=e.level}})),l.toc+="</ul>",void function(t){let l=new JSZip;l.file("Manifest.xml",t.content);let n={title:e.title?e.title[0].text:"undefined",styles:"./Styles/styles.css",toc:t.toc,body:""};t.sections.forEach((e=>{n.body+=e.body})),l.file(i.txtPath+i.txtName,function(e){return'<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous" /><link rel="stylesheet" type="text/css" href="'+e.styles+'" /><title>'+e.title+'</title></head><body><div class="container max-width-lg" ><div class="row" ><div class="col-12" ><div class="title">'+e.title+'</div></div></div><div class="row" ><div class="col-12 col-md-3" >'+e.toc+'</div><div class="col-12 col-md-9" >'+e.body+"</div></div></div></body></html>"}(n)),t.styles&&l.file("Styles/styles.css",t.styles);t.images.forEach((e=>{l.file(i.imgPath+e.id,e.blob)})),l.generateAsync({type:"blob",mimeType:t.mimetype}).then((e=>{saveAs(e,t.fileName),"function"==typeof i.done&&i.done()}),(e=>{"function"==typeof i.fail&&i.fail({status:299,statusText:"Cannot store "+t.fileName})}))}(l)}