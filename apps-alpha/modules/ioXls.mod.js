"use strict";
/*!	iLaH: Excel (XLS) import
    Dependencies: jQuery 3.0+, sheetjs
    (C)copyright enso managers gmbh (http://www.enso-managers.de)
    Author: se@enso-managers.de, Berlin
    License: Apache 2.0 (http://www.apache.org/licenses/LICENSE-2.0)
    We appreciate any correction, comment or contribution as Github issue (https://github.com/enso-managers/SpecIF-Tools/issues)

    Limitation:
    - This code assumes that dataTypes with cetrtain names including DT-Text and DT-ShortString are retrieved from the ontology.
*/moduleManager.construct({name:"ioXls"},(function(e){const t=e.loadAs;var s;return e.init=function(){return!0},e.verify=function(e){return s=e.lastModified?new Date(e.lastModified).toISOString():(new Date).toISOString(),!0},e.toSpecif=function(r){e.abortFlag=!1;var a=$.Deferred();let i=function(e,s,r){class a{constructor(e){let t=e.match(/([A-Z]+)(\d+)/);if(!Array.isArray(t)||!t[1]||!t[2])throw Error("Incomplete input data: Cell without address!");this.col=d(t[1]),this.row=parseInt(t[2])}}class i{constructor(e){if(this.isValid=!1,this.name=e,this.data=y.Sheets[e],this.resClass=c(s+"-"+e),this.hid=CONFIG.prefixH+simpleHash(s+e),this.range=this.data["!ref"],this.range){let e=this.range.split(":");e.length>1&&(this.firstCell=new a(e[0]),this.lastCell=new a(e[1]),this.isValid=!0)}this.col2dT=new Map}}function n(e){return CONFIG.prefixDT+simpleHash(e)}class o{constructor(e,t,s){this.id=l(e),this.title=t,this.dataType=LIB.makeKey(s),this.changedAt=r}}function l(e){return CONFIG.prefixPC+simpleHash(e)}class u{constructor(e,t){this.id=e,this.title=t,this.description=LIB.makeMultiLanguageValue("For resources specified per line of an excel sheet"),this.instantiation=[SpecifInstantiation.User],this.propertyClasses=[],this.changedAt=r}}function c(e){return CONFIG.prefixRC+simpleHash(e)}function f(e){function t(e,s){if(e<1)return s;let r=e%26;return t((e-r)/26,s=String.fromCharCode(r+64)+s)}return t(e,"")}function p(e,t){return f(e)+t}function d(e){let t=0,s=1;for(var r=e.length-1;r>-1;r--)t+=s*(e.charCodeAt(r)-64),s*=26;return t}function h(e){if(e&&e.isValid)if("{Enumerations}"===e.name){let t,s,a,i,o;for(t=e.firstCell.col;t<e.lastCell.col+1;t++)if(a=e.data[p(t,e.firstCell.row)],a&&a.v){for(i={id:n(e.name+t),title:"",type:XsDataType.String,enumeration:[],changedAt:r},o={id:l(e.name+t),title:"",dataType:LIB.keyOf(i),changedAt:r},s=e.firstCell.row;s<e.lastCell.row+1;s++)a=e.data[p(t,s)],s==e.firstCell.row?o.title=i.title=a&&"s"==a.t?a.v:"":a&&"s"==a.t&&a.v&&i.enumeration.push({id:i.id+"-"+s,value:LIB.makeMultiLanguageValue(a.v)});i.title&&i.enumeration.length>0&&(v.dataTypes.push(i),v.propertyClasses.push(o))}}else e.name.startsWith("{")&&e.name.endsWith("}")&&console.warn("Sheet with name "+e.name+" skipped, because it has an unknown keyword in curly brackets")}function m(e){if(e&&e.isValid){if(e.name.startsWith("{")&&e.name.endsWith("}"))return;function a(e){return e&&("d"==e.t||"s"==e.t&&LIB.isIsoDateTime(e.v))}function i(e){return e&&("n"==e.t&&Number.isInteger(e.v)||"s"==e.t&&RE.Integer.test(e.v))}function n(e){return e&&("n"==e.t&&!Number.isInteger(e.v)||"s"==e.t&&RE.Real().test(e.v))}function l(e){return e&&("b"==e.t||"s"==e.t&&(LIB.isTrue(e.v)||LIB.isFalse(e.v)))}function c(e){return e&&"s"==e.t&&e.v.length>0}function f(e){if(e.lastCell.row-e.firstCell.row<1);else{var a={id:CONFIG.prefixR+simpleHash(s+e.name+CONFIG.resClassFolder),class:LIB.makeKey("RC-Folder"),properties:[{class:LIB.makeKey("PC-Name"),values:[LIB.makeMultiLanguageValue(x(e.name))]}],changedAt:r};v.resources.push(a);for(var i={id:e.hid,resource:LIB.keyOf(a),nodes:[],changedAt:r},n=[],o=e.firstCell.row+1,l=e.lastCell.row+1;o<l;o++)u(e,o);v.nodes[0].nodes.push(i)}function u(s,a){function o(e,t){if(t&&t.v&&e&&e.enumeration){for(var s of e.enumeration)if((s.value[0].text||s.value[0])==t.v)return s.id;return""}switch(e.type){case XsDataType.String:let e;switch(t.t){case"d":e=t.v.toISOString();break;case"n":case"b":e=t.v.toString();break;default:e=t.v}return LIB.makeMultiLanguageValue(e);case XsDataType.DateTime:switch(t.t){case"d":return t.v.toISOString();case"s":return LIB.isIsoDateTime(t.v)?t.v:""}case XsDataType.Integer:case XsDataType.Double:switch(t.t){case"n":return t.v.toString();case"s":return t.v}case XsDataType.Boolean:switch(t.t){case"b":return t.v.toString();case"s":return LIB.isTrue(t.v).toString()}}return""}var l={class:LIB.makeKey(s.resClass),properties:[],changedAt:r};let u,c,f,d,h,m,I,y;for(u=s.firstCell.col,c=s.lastCell.col+1;u<c;u++)if(f=s.data[p(u,s.firstCell.row)],y=f&&f.v?f.v.trim():"",y&&(f=s.data[p(u,a)],f&&f.v)){if(CONFIG.nativeProperties.has(y)){h=CONFIG.nativeProperties.get(y),d=o({type:h.type},f),h.check(d)?(l[h.name]=d,console.info(s.name+", row "+a+": '"+y+"' with value '"+d+"' has been mapped to the native property '"+h.name+"'")):console.warn(s.name+", row "+a+": Cell value '"+f.v+"' is invalid for the given native property '"+y+"'");continue}let r=s.col2dT.get(u);r?(h=LIB.itemByKey(v.propertyClasses,r),m=LIB.itemByKey(v.dataTypes,h.dataType),m?(!I&&CONFIG.idProperties.includes(h.title)&&(I=f.v),d=o(m,f),m.maxLength&&m.maxLength<d.length&&(d=d.slice(0,m.maxLength),console.warn("Text of cell "+p(u,a)+" on sheet "+e.name+" has been truncated because it is too long")),d&&l.properties.push({class:LIB.keyOf(h),values:[d]})):console.error(t+": No dataType with id "+h.dataType.id+" found for value "+f.v+" in cell "+p(u,a)+" of worksheet "+s.name)):console.error(t+": Did not find the key of a propertyClass that should have been created earlier")}if(l.properties.length>0){if(I){if(l.id=CONFIG.prefixR+simpleHash(s.name+I),LIB.indexById(v.resources,l.id)>-1){n.push(I);let e={};n.forEach((t=>{e[t]=(e[t]||0)+1})),console.warn("The user-defined identifier",I,"is occurring",e[I]+1,"times."),l.id=CONFIG.prefixR+simpleHash(s.name+I+e[I])}}else l.id=LIB.genID(CONFIG.prefixR);i.nodes.push({id:CONFIG.prefixN+simpleHash(l.id+i.nodes.length),resource:LIB.keyOf(l),changedAt:r}),v.resources.push(l)}}}function d(e){var t,s,r,u,f,d,h=[];for(r=e.firstCell.col,u=e.lastCell.col+1;r<u;r++)if(d=(f=e.data[p(r,e.firstCell.row)])&&f.v?f.v.trim():""){if(CONFIG.nativeProperties.has(d))continue;if((t=LIB.itemByTitle(v.propertyClasses,d))&&t.id&&(s=LIB.itemByKey(v.dataTypes,t.dataType))&&s.enumeration){let s=LIB.keyOf(t);h.push(s),e.col2dT.set(r,s);continue}if(t=m(r)){LIB.cacheE(v.propertyClasses,t);let s=LIB.keyOf(t);h.push(s),e.col2dT.set(r,s)}}return h;function m(t){const s="ShortString";let r,u,f=[];for(r=e.firstCell.row,u=e.lastCell.row+1;r<u;r++)f.push(e.data[p(t,r)]);let d=f[0]?f[0].w||f[0].v:"",h="",m="",I=LIB.itemByTitle(v.propertyClasses,d);if(I)return I;for(var y=f.length-1;y>0;y--)m=g(f[y]),m.length<1||(h?h!=m&&("Real"==h&&"Integer"==m||(h="Integer"!=h||"Real"!=m?s:"Real")):h=m);if(h||(h=s),h==s&&app.ontology.propertyClassIsText(d)&&(h="Text"),h==s){let e=0,t=!1;for(y=f.length-1;y>0;y--)e=Math.max(e,f[y]&&f[y].v?f[y].v.length:0),t=t||f[y]&&"string"==typeof f[y].v&&f[y].v.indexOf("\n")>-1;(e>CONFIG.textThreshold||t)&&(h="Text")}return new o(e.name+t,d,CONFIG.prefixDT+h);function g(e){return l(e)?"Boolean":i(e)?"Integer":n(e)?"Real":a(e)?"DateTime":c(e)?s:""}}}if(e.range){let h=new u(e.resClass,O(e.name)??O(s)??CONFIG.resClassXlsRow);h.propertyClasses=d(e),v.resourceClasses.push(h),f(e)}}}let I=new Uint8Array(e),y=XLSX.read(I,{type:"array",cellDates:!0,cellStyles:!0}),g=y.SheetNames.length;console.info("SheetNames: "+y.SheetNames+" ("+g+")");var C=["xs:string","xs:boolean","xs:integer","xs:double","xs:dateTime","xs:anyURI",CONFIG.propClassId,CONFIG.propClassTitle,CONFIG.propClassDesc,CONFIG.propClassType,CONFIG.resClassFolder],v=app.ontology.generateSpecifClasses({terms:C,referencesWithoutRevision:!0});let L,B=x(s),w=B.toSpecifId();for(v.id=CONFIG.prefixP+w,v.title=LIB.makeMultiLanguageValue(B),v.resources.push({id:CONFIG.prefixR+w,class:LIB.makeKey("RC-Folder"),properties:[{class:LIB.makeKey("PC-Name"),values:[v.title]},{class:LIB.makeKey("PC-Type"),values:[LIB.makeMultiLanguageValue(CONFIG.resClassOutline)]}],changedAt:r}),v.nodes.push({id:CONFIG.prefixH+w,resource:LIB.makeKey(CONFIG.prefixR+w),nodes:[],changedAt:r}),L=0;L<g;L++)h(new i(y.SheetNames[L]));for(L=0;L<g;L++)m(new i(y.SheetNames[L]));return console.debug("from xlsx:",v),v;function x(e){let t=RE.withoutBracketsAtEnd.exec(e);if(Array.isArray(t)&&t.length>1)return t[1]}function O(e){let t=RE.inBracketsAtEnd.exec(e);if(Array.isArray(t)&&t.length>1)return t[1]}}(r,e.parent.projectName,s);return a.resolve(i),a},e.fromSpecif=function(e,t){!function(e,t){console.debug("toXlsx",e,t);const s=XLSX.utils.book_new();let r=app.projects.selected,a=r.cache,i=0,n=[e.propertyClasses.map((e=>e.title))];return void LIB.iterateSpecifNodes(a.get("hierarchy",r.nodes).filter((e=>LIB.typeOf(e.resource,a)!=CONFIG.resClassUnreferencedResources)),(e=>(i++,r.readItems("resource",[e.resource]).then((e=>{if(n.push(o(e[0])),--i<1){const e=XLSX.utils.aoa_to_sheet(n);XLSX.utils.book_append_sheet(s,e,"Sheet1"),XLSX.writeFile(s,t.fileName+".xlsx",{compression:!0}),"function"==typeof t.done&&t.done()}}),LIB.stdError),!0)));function o(t){let s,r=[];for(var a of e.propertyClasses){let n=i(t.properties,a);if(n){n.values.length>1&&console.info("Limitation of XLS export: Only first property value is included.");let t=LIB.itemByKey(e.dataTypes,a.dataType);if(t){if(t.enumeration){let e=LIB.itemById(t.enumeration,n.values[0].id);s=LIB.isMultiLanguageValue(e.value)?e.value[0].text:e.value}else t.type==XsDataType.String?(n.values[0].length>1&&console.info("Limitation of XLS export: Only first language value is included."),s=n.values[0][0].text):s=n.values[0];r.push(s)}}}return r;function i(e,t){for(var s of e)if(LIB.references(s.class,t))return s}}}(e,t)},e.abort=function(){app.projects.abort(),e.abortFlag=!0},e}));