/*!	Create and return an XHTML document using SpecIF data.

	(C)copyright enso managers gmbh (http://enso-managers.de)
	Author: se@enso-managers.de
	License and terms of use: Apache 2.0 (https://apache.org/licenses/LICENSE-2.0)
	We appreciate any correction, comment or contribution as Github issue (https://github.com/enso-managers/SpecIF-Tools/issues)

	Limitations:
	- HTML ids are made from resource ids, so multiple reference of a resource results in mutiple occurrences of the same id.
	- Title links are only correct if they reference objects in the same SpecIF hierarchy (hence, the same xhtml file)
	- Accepts data-sets according to SpecIF v1.1.
	- All values must be strings, the language must be selected before calling this function, i.e. languageValues as permitted by the schema are not supported!
	- There must only be one revision per resource or statement

	ToDo also:
	- move the title linking to the export filter
*/
function makeXhtml(e,t){"use strict";if(!e.$schema||e.$schema.includes("v1.0")){let e="SpecIF Version < v1.1 is not supported.";return void("function"==typeof n.fail?n.fail({status:904,statusText:e}):console.error(e))}let n=Object.assign({showEmptyProperties:!1,addIcon:!0,addOrder:!1,titleProperties:["dcterms:title"],descriptionProperties:["dcterms:description","SpecIF:Diagram","SpecIF:View"],titleLinkBegin:"\\[\\[",titleLinkEnd:"\\]\\]",titleLinkMinLength:3,RE:{AmpersandPlus:new RegExp("&(.{0,8})","g"),XMLEntity:new RegExp("&(amp|gt|lt|apos|quot|#x[da-fA-F]{1,4}|#d{1,5});/","")}},t);n.addTitleLinks=n.titleLinkBegin&&n.titleLinkEnd&&n.titleLinkMinLength>0,n.addTitleLinks&&(n.RE.TitleLink=new RegExp(n.titleLinkBegin+"(.+?)"+n.titleLinkEnd,"g"));const r="&#160;",i=new RegExp("([\\s\\S]*?)(<\\/?)([a-z]{1,10}( [^<>]+)?\\/?>)","g"),s="xs:string",l="<object ([^>]+)(/>|>(.*?)</object>)",o=new RegExp(l,"g"),a=new RegExp("<object([^>]+)>[\\s]*"+l+"([\\s\\S]*?)</object>","g");var u,c={headings:[],sections:[],images:[]},d=E("string"==typeof(u=e.title[0].text)?u:u[0].text);n.titlePage&&c.sections.push({title:d,body:'<div class="title">'+d+"</div>"});const f=c.sections.length;return e.nodes.forEach(((e,t)=>{c.sections.push({title:d,body:b(e,t,1,"")})})),c;function p(t,n,i){let s=function(t){for(var n of i.titleProperties){let r=LIB.valueByTitle(t,n,e);if(r)return r}}(t)??LIB.valueByTitle(t,i.typeProperty,e)??(t.subject?LIB.classTitleOf(t.class,e.statementClasses):"");if(s=E(s),!s)return"";let l=v(t.subject?e.statementClasses:e.resourceClasses,t.class);if(s=(i.addIcon&&l&&l.icon?l.icon+r+r:"")+s,s=(i.addOrder&&n?n.order+r+r:"")+s,!n||"number"!=typeof n.level||n.level<1)return s;l&&l.isHeading&&function(e,t){c.headings.push({id:t.nodeId,title:e,section:c.sections.length,level:t.level})}(s,n);let o=1==n.level?1:l&&l.isHeading?2:3;return"<h"+o+' id="'+n.nodeId+'">'+s+"</h"+o+">"}function g(t,r){let i,s;for(var l=0,o=e.nodes.length;l<o;l++)if(i=(l+r)%o,s=a(e.nodes[i]),s)return s;return;function a(e){if((e.resource.id||e.resource)==t.id)return n.txtPath.replace(n.placeholder,i+f)+"#"+e.id;if(e.nodes){let t;for(var r of e.nodes)if(t=a(r),t)return t}return null}}function h(t,n,r){let i="",l="",u=[],d=[];return t.properties&&t.properties.forEach((e=>{r.descriptionProperties.indexOf(m(e))>-1?u.push(e):r.titleProperties.indexOf(m(e))<0&&d.push(e)})),u.length>0?u.forEach((e=>{i+=b(e,n)})):t.description&&(i+="<p>"+b(t.description,n)+"</p>"),!r.propertiesLabel||d.length<1?i:(d.forEach((function(e){(e.values.length>0||r.showEmptyProperties)&&(l+='<tr><td class="propertyTitle">'+m(e)+"</td><td>"+b(e,n)+"</td></tr>")})),l?i+'<p class="metaTitle">'+r.propertiesLabel+'</p><table class="propertyTable"><tbody>'+l+"</tbody></table>":i);function f(t,n){if(!n)return t;function r(e){var t=/(href|data)="([^"]+)"/.exec(e);if(null!=t)return t[2].replace("\\","/")}function i(e){return(e=e.replace("\\","/")).substring(e.lastIndexOf("/")+1)}function s(e){return(e=e.replace("\\","/")).substring(0,e.lastIndexOf("."))}return null==n.imgExtensions&&(n.imgExtensions=["png","jpg","svg","gif","jpeg"]),null==n.applExtensions&&(n.applExtensions=["bpmn"]),t=(t=t.replace(a,(function(e,t,n,s,o){let a=r(t),u=r(n),c=x(u);return c?l(u,c,E(i(o||a))):e}))).replace(o,(function(t,o,a,u){let c=r(o),d=x(c);if(!d)return t;let f=E(i(u||c));if(d=d.toLowerCase(),n.applExtensions.includes(d)){let t=!0;for(var p=e.files.length-1;t&&p>-1;p--)e.files[p].title.includes(s(c))&&(c=e.files[p].title,d=x(c).toLowerCase(),t=!1);if(t)return"<span>"+f+"</span>"}return l(c,d,f)}));function l(t,r,i){if(n.imgExtensions.includes(r)){t.includes("svg")&&n.preferPng&&(t=s(t)+".png");let r=function(e,t){if(e&&t)for(var n=e.length-1;n>-1;n--)if(e[n].title==t)return e[n]}(e.files,t);if(function(e){if(e&&e.blob){let t="F-"+y(e.title)+"."+x(e.title);return v(c.images,t)||c.images.push({id:t,blob:e.blob,type:e.type}),!0}return!1}(r))return'<img src="'+function(e){return n.imgPath+"F-"+y(e.title)+"."+x(e.title)}(r)+'" style="max-width:100%" alt="'+i+'" />'}return console.warn("No image file found for ",t),"<span>"+i+"</span>"}}function h(t,n,r){return r.addTitleLinks?t=t.replace(r.RE.TitleLink,(function(t,i){let s,l,o=i.toLowerCase();for(var a=e.resources.length-1;a>-1;a--)if(s=e.resources[a],l=p(s,void 0,Object.assign({},r,{addIcon:!1})),l&&!(l.length<r.titleLinkMinLength)&&o==l.toLowerCase())return'<a href="'+g(s,n)+'">'+i+"</a>";return'<span style="color:#D82020">'+i+"</span>"})):t.replace(r.RE.TitleLink,(function(e,t){return t}))}function b(t,n){let i=v(e.propertyClasses,t.class),l=v(e.dataTypes,i.dataType);if(l.enumeration){let e="";for(var o of t.values)if(l.type===s)e+=(0==e.length?"":", ")+v(l.enumeration,o).value[0].text;else e+=(0==e.length?"":", ")+v(l.enumeration,o).value;return E(e)}let a="";if(l.type===s)for(var o of t.values)a+=h(f(L(o[0].text),r),n,r);else for(var o of t.values)a+=(0==a.length?"":", ")+E(o);return a}}function b(t,r,i,s){let l=v(e.resources,t.resource),o={level:i,order:s+(s.length>0?".":"")+(r+1),nodeId:t.id};var a=p(l,o,n)+h(l,r,n)+function(t,n,r){if(!r.statementsLabel)return"";let i,s,l,o,a={},u=!0;if(e.statements.forEach((function(n){i=p(n,void 0,r),l=n.subject.id||n.subject,s=n.object.id||n.object,l!=t.id&&s!=t.id||(a[i]||(a[i]={subjects:[],objects:[]}),l==t.id?(o=v(e.resources,s),o&&(a[i].objects.push(o),u=!1)):(o=v(e.resources,l),o&&(a[i].subjects.push(o),u=!1)))})),u)return"";let c='<p class="metaTitle">'+r.statementsLabel+"</p>";for(i in c+='<table class="statementTable"><tbody>',a)a[i].subjects.length>0&&(c+="<tr><td>",a[i].subjects.forEach((function(e){c+='<a href="'+g(e,n)+'">'+p(e,void 0,r)+"</a><br/>"})),c+='</td><td class="statementTitle">'+i,c+="</td><td>"+p(t,void 0,r),c+="</td></tr>"),a[i].objects.length>0&&(c+="<tr><td>"+p(t,void 0,r),c+='</td><td class="statementTitle">'+i+"</td><td>",a[i].objects.forEach((function(e){c+='<a href="'+g(e,n)+'">'+p(e,void 0,r)+"</a><br/>"})),c+="</td></tr>");return c+"</tbody></table>"}(l,r,n);return t.nodes&&t.nodes.forEach(((e,t)=>{a+=b(e,t,i+1,o.order)})),a}function v(e,t){let n=function(e,t){if(e&&t){let r=t.id||t;for(var n=e.length-1;n>-1;n--)if(e[n].id==r)return n}return-1}(e,t);if(n>-1)return e[n]}function m(t){return t.title||v(e.propertyClasses,t.class).title}function E(e){return e?e.replace(n.RE.AmpersandPlus,(function(e,t){return n.RE.XMLEntity.test(e)?e:"&#38;"+t})).replace(/[<>"']/g,(function(e){return"&#"+{"<":"60",">":"62",'"':"34","'":"39"}[e]+";"})):""}function L(e){var t="";return e=e.replace(i,(function(e,n,r,i){return t+=E(n)+r+i,""})),t+=E(e)}function y(e){for(var t=0,n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t&=t;return t}function x(e){return e.substring(e.lastIndexOf(".")+1)}}