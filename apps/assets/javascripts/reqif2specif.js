/*! 
    ReqIF to SpecIF Transformation
    (C)copyright adesso SE, enso managers gmbh (http://www.enso-managers.de)
    Author: jasmin.droescher@adesso.de, se@enso-managers.de, Berlin
    License and terms of use: Apache 2.0 (http://www.apache.org/licenses/LICENSE-2.0)
    We appreciate any correction, comment or contribution via e-mail to maintenance@specif.de 
    .. or even better as Github issue (https://github.com/GfSE/SpecIF-Viewer/issues)

    ToDo:
    - transform RELATION-GROUP-TYPES and RELATION-GROUPS
    - extract default values
*/
function reqif2Specif(e,t){const r=/\sxmlns:(.*?)=\".*?\"/;"object"!=typeof t&&(t={}),t.propType||(t.propType="ReqIF.Category"),t.prefixN||(t.prefixN="N-");const n=(i=e,(new DOMParser).parseFromString(i,"text/xml"));var i,s,a;if(0==(s=(a=n).getElementsByTagName("REQ-IF-HEADER").length>0&&a.getElementsByTagName("REQ-IF-CONTENT").length>0?{status:0,statusText:"ReqIF data is valid"}:t.errInvalidReqif||{status:899,statusText:"ReqIF data is invalid"}).status&&(s.response=function(e){let t=e[0].getAttribute("IDENTIFIER");return{id:t,title:e[0].getElementsByTagName("TITLE")[0]&&e[0].getElementsByTagName("TITLE")[0].innerHTML||t,description:e[0].getElementsByTagName("COMMENT")[0]&&e[0].getElementsByTagName("COMMENT")[0].innerHTML||"",generator:"reqif2specif",$schema:"https://specif.de/v1.0/schema.json",createdAt:e[0].getElementsByTagName("CREATION-TIME")[0].innerHTML}}(n.getElementsByTagName("REQ-IF-HEADER")),s.response.dataTypes=function(e){return e.length<1?[]:Array.from(e[0].children,t);function t(e){let t={id:e.getAttribute("IDENTIFIER"),type:n(e),title:e.getAttribute("LONG-NAME")||"",description:e.getAttribute("DESC")||"",changedAt:e.getAttribute("LAST-CHANGE")||""};return r("MIN","minInclusive"),r("MAX","maxInclusive"),r("MAX-LENGTH","maxLength"),r("ACCURACY","fractionDigits"),e.childElementCount>0&&(t.values=i(e.children)),t;function r(r,n){let i=e.getAttribute(r);i&&(t[n]=Number(i))}function n(e){return{"DATATYPE-DEFINITION-BOOLEAN":"xs:boolean","DATATYPE-DEFINITION-DATE":"xs:dateTime","DATATYPE-DEFINITION-INTEGER":"xs:integer","DATATYPE-DEFINITION-REAL":"xs:double","DATATYPE-DEFINITION-STRING":"xs:string","DATATYPE-DEFINITION-XHTML":"xhtml","DATATYPE-DEFINITION-ENUMERATION":"xs:enumeration"}[e.nodeName]}function i(e){return Array.from(e[0].children,t);function t(e){return{id:e.getAttribute("IDENTIFIER"),value:e.getAttribute("LONG-NAME")||"&#x00ab;undefined&#x00bb;"}}}}}(n.getElementsByTagName("DATATYPES")),s.response.propertyClasses=function(e){let r=n(i(e[0]));T(r).length<1&&(s.response.dataTypes.push({id:"DT-ShortString-"+s.response.id,type:"xs:string",title:"String[256]",description:"String with length <=256",maxLength:256,changedAt:(new Date).toISOString()}),r.push({id:"PC-Type-"+s.response.id,dataType:"DT-ShortString-"+s.response.id,title:t.propType,description:"The nature or genre of the resource.",changedAt:(new Date).toISOString()}));return r;function n(e){return Object.entries(e).map((e=>{let t={id:e[0],title:e[1].title,dataType:e[1].dataType,changedAt:e[1].changedAt};return e[1].multiple&&(t.multiple=!0),t}))}function i(e){return Object.assign({},t(e,"ATTRIBUTE-DEFINITION-STRING"),t(e,"ATTRIBUTE-DEFINITION-XHTML"),t(e,"ATTRIBUTE-DEFINITION-ENUMERATION"),t(e,"ATTRIBUTE-DEFINITION-DATE"),t(e,"ATTRIBUTE-DEFINITION-BOOLEAN"),t(e,"ATTRIBUTE-DEFINITION-INTEGER"),t(e,"ATTRIBUTE-DEFINITION-REAL"));function t(e,t){let r=e.getElementsByTagName(t),n={};return Array.from(r).forEach((e=>{if(n[e.getAttribute("IDENTIFIER")]={title:e.getAttribute("LONG-NAME"),dataType:e.children[0].children[0].innerHTML,changedAt:e.getAttribute("LAST-CHANGE")},"ATTRIBUTE-DEFINITION-ENUMERATION"==t){let t=e.getAttribute("MULTI-VALUED");t&&"true"==t.toLowerCase()&&(n[e.getAttribute("IDENTIFIER")].multiple=!0)}})),n}}}(n.getElementsByTagName("SPEC-TYPES")),s.response.resourceClasses=E(n.getElementsByTagName("SPEC-TYPES"),["SPECIFICATION-TYPE","SPEC-OBJECT-TYPE"]),s.response.statementClasses=E(n.getElementsByTagName("SPEC-TYPES"),["SPEC-RELATION-TYPE"]),s.response.resources=l("SPEC-OBJECTS").concat(l("SPECIFICATIONS")),s.response.statements=function(e){return e.length<1?[]:Array.from(e[0].children,t);function t(e){let t={id:e.getAttribute("IDENTIFIER"),subject:e.getElementsByTagName("SOURCE")[0].children[0].innerHTML,object:e.getElementsByTagName("TARGET")[0].children[0].innerHTML,changedAt:e.getAttribute("LAST-CHANGE")};t.class=e.getElementsByTagName("TYPE")[0].children[0].innerHTML;let r=e.getElementsByTagName("VALUES");return t.properties=o(r),t}}(n.getElementsByTagName("SPEC-RELATIONS")),s.response.hierarchies=function(e){return e.length<1?[]:Array.from(e[0].getElementsByTagName("SPECIFICATION"),r);function r(e){let r=e.getAttribute("IDENTIFIER");return{id:t.prefixN+r,resource:r,changedAt:e.getAttribute("LAST-CHANGE"),nodes:n(e)};function n(e){let t=[];const r=i(e,"CHILDREN")[0];return null!=r&&(t=Array.from(r.children,s)),t;function i(e,t){return Array.from(e.children).filter((e=>e.nodeName==t))}function s(e){let t={id:e.getAttribute("IDENTIFIER"),resource:e.getElementsByTagName("OBJECT")[0].firstElementChild.innerHTML,changedAt:e.getAttribute("LAST-CHANGE")},r=n(e);return r.length>0&&(t.nodes=r),t}}}}(n.getElementsByTagName("SPECIFICATIONS"))),!s.response.title){let e,t="";s.response.hierarchies.forEach((r=>{e=u(s.response.resources,r.resource),t+=(t.length>0?", ":"")+e.title})),s.response.title=t,console.info("Project title assembled from ReqIF SPECIFICATION roots")}return s;function T(e){return e.filter((e=>e.title==t.propType)).map((e=>e.id))}function E(e,t){if(e.length<1)return[];const r=[];return Array.from(e[0].children,(e=>{if(t.includes(e.nodeName)){let t=function(e){const t={id:e.getAttribute("IDENTIFIER"),title:e.getAttribute("LONG-NAME")||e.getAttribute("IDENTIFIER"),changedAt:e.getAttribute("LAST-CHANGE")};e.getAttribute("DESC")&&(t.description=e.getAttribute("DESC"));e.getElementsByTagName("SPEC-ATTRIBUTES")[0]&&(t.propertyClasses=r(e.getElementsByTagName("SPEC-ATTRIBUTES")));return t;function r(e){return Array.from(e[0].children,(e=>e.getAttribute("IDENTIFIER")))}}(e);if("SPECIFICATION-TYPE"==e.nodeName){let e=T(s.response.propertyClasses);e.length>0?Array.isArray(t.propertyClasses)?function(e,t){for(pC of e)if(t.includes(pC.id))return;e.push(t[0])}(t.propertyClasses,e):t.propertyClasses=[e[0]]:console.error("There is no propertyClass ")}r.push(t)}})),r}function l(e){let t=n.getElementsByTagName(e);return t.length<1?[]:Array.from(t[0].children,(function(t){let r={id:t.getAttribute("IDENTIFIER"),title:t.getAttribute("LONG-NAME")||"",changedAt:t.getAttribute("LAST-CHANGE")};r.class=t.getElementsByTagName("TYPE")[0].children[0].innerHTML;let n=t.getElementsByTagName("VALUES");r.properties=o(n),!r.title&&r.properties.length<1&&(r.title=r.id);if("SPECIFICATIONS"==e){let e=T(s.response.propertyClasses),t={class:e[0],value:"ReqIF:HierarchyRoot"},n=function(e){for(var t of r.properties)if(e.includes(t.class))return t}(e);n?n.value=t.value:r.properties.push(t)}return r}))}function o(e){if(e.length<1)return[];let t=[];return Array.from(e[0].children,(e=>{let n=function(e){let t,n,i={};i.class=e.getElementsByTagName("DEFINITION")[0].children[0].innerHTML,e.getAttribute("THE-VALUE")?(i.value=e.getAttribute("THE-VALUE"),t=u(s.response.propertyClasses,i.class),n=u(s.response.dataTypes,t.dataType),"number"==typeof n.maxLength&&n.maxLength<i.value.length&&(console.warn("Truncated ReqIF Attribute with value '"+i.value+"' to the specified maxLength of "+n.maxLength+" characters"),i.value=i.value.substring(0,n.maxLength))):e.getElementsByTagName("THE-VALUE")[0]?i.value=function(e){let t=s(r,e),n=e.replace(r,"");const i=new RegExp(t,"g");return n=n.replace(i,""),n;function s(e,t){let r="";return t=t.replace(e,(function(e,t){return r=t+":",""})),r}}(e.getElementsByTagName("THE-VALUE")[0].innerHTML):e.getElementsByTagName("VALUES")[0]&&(i.value="",Array.from(e.getElementsByTagName("VALUES")[0].children,(e=>{i.value+=(i.value.length>0?",":"")+e.innerHTML})));return i}(e);n.value&&t.push(n)})),t}function u(e,t){if(e&&t){t=t.trim();for(var r=e.length-1;r>-1;r--)if(e[r].id==t)return e[r]}}}