"use strict";
/*!    SpecIF: Generate Specif classes from the Ontology.
    Dependencies: -
    (C)copyright enso managers gmbh (http://www.enso-managers.de)
    License and terms of use: Apache 2.0 (http://www.apache.org/licenses/LICENSE-2.0)
    Author: se@enso-managers.de, Berlin
    We appreciate any correction, comment or contribution via e-mail to maintenance@specif.de
    .. or even better as Github issue (https://github.com/GfSE/SpecIF-Viewer/issues)
*/class COntology{constructor(e){this.headings=[],this.modelElementClasses=[],this.termPrincipalClasses=new Map([["SpecIF:TermResourceClass","R-FolderTermsResourceClass"],["SpecIF:TermStatementClass","R-FolderTermsStatementClass"],["SpecIF:TermPropertyClass","R-FolderTermsPropertyClass"],["SpecIF:TermPropertyValue","R-FolderTermsPropertyValue"]]),this.termClasses=["SpecIF:TermResourceClass","SpecIF:TermStatementClass","SpecIF:TermPropertyClassString","SpecIF:TermPropertyClassBoolean","SpecIF:TermPropertyClassInteger","SpecIF:TermPropertyClassReal","SpecIF:TermPropertyClassTimestamp","SpecIF:TermPropertyClassDuration","SpecIF:TermPropertyClassURI","SpecIF:TermPropertyValue"],this.primitiveDataTypes=new Map([["RC-SpecifTermpropertyclassstring",XsDataType.String],["RC-SpecifTermpropertyclassboolean",XsDataType.Boolean],["RC-SpecifTermpropertyclassinteger",XsDataType.Integer],["RC-SpecifTermpropertyclassreal",XsDataType.Double],["RC-SpecifTermpropertyclasstimestamp",XsDataType.DateTime],["RC-SpecifTermpropertyclassduration",XsDataType.Duration],["RC-SpecifTermpropertyclassuri",XsDataType.AnyURI]]),this.termDefaultValues=["SpecIF:DefaultValueString","SpecIF:DefaultValueBoolean","SpecIF:DefaultValueInteger","SpecIF:DefaultValueReal","SpecIF:DefaultValueTimestamp","SpecIF:DefaultValueDuration","SpecIF:DefaultValueAnyURI"],this.synonymStatements=new Map([["resourceClass","SpecIF:isSynonymOfResource"],["statementClass","SpecIF:isSynonymOfStatement"],["propertyClass","SpecIF:isSynonymOfProperty"],["propertyValue","SpecIF:isSynonymOfValue"]]),this.eligibleLifecycleStatus=["SpecIF:LifecycleStatusReleased","SpecIF:LifecycleStatusEquivalent","SpecIF:LifecycleStatusSubmitted","SpecIF:LifecycleStatusExperimental"],this.data=e,e.hierarchies=e.hierarchies.filter((t=>{let s=LIB.itemByKey(e.resources,t.resource);return"W3C:Ontology"==this.valueByTitle(s,CONFIG.propClassType)})),e.hierarchies.length<1?message.show("No ontology found.",{severity:"warning"}):this.checkConstraintsOntology()?(this.namespaces=this.getNamespaces(),this.headings=this.getHeadings(),this.modelElementClasses=this.getModelElementClasses(),this.makeStatementsIsNamespace(),this.options={}):message.show("The Ontology violates one or more constraints, so no classes will be generated. Please see the browser log for details.",{severity:"error"})}getTermResources(e,t){return e=e.toLowerCase(),this.data.resources.filter((s=>{let a=LIB.valuesByTitle(s,[CONFIG.propClassTerm],this.data);return a.length>0&&LIB.languageTextOf(a[0],{targetLanguage:"default"})==t&&("all"==e||LIB.classTitleOf(s.class,this.data.resourceClasses).toLowerCase().includes(e))}))}getTerms(e){let t=["resourceClass","statementClass","propertyClass","propertyValue"];if(t.includes(e))return e=e.toLowerCase(),this.data.resources.filter((t=>LIB.classTitleOf(t.class,this.data.resourceClasses).toLowerCase().includes(e))).map((e=>this.valueByTitle(e,CONFIG.propClassTerm)));throw Error("Programming Error: Category must be one of "+t.toString())}localize(e,t){if(RE.vocabularyTerm.test(e)){let s=this.getTermResources("all",e);if(s.length>0){let e=[];if(t.plural){if(e=LIB.valuesByTitle(s[0],["SpecIF:LocalTermPlural"],this.data),e.length<1){let t=this.statementsByTitle(s[0],["SpecIF:isPluralOfResource"],{asSubject:!1,asObject:!0});if(t.length>0){let s=LIB.itemByKey(this.data.resources,t[0].subject);e=LIB.valuesByTitle(s,["SpecIF:LocalTerm"],this.data)}}}else e=LIB.valuesByTitle(s[0],["SpecIF:LocalTerm"],this.data);if(e.length>0){return LIB.languageTextOf(e[0],t)}}}return e}globalize(e,t){if(RE.vocabularyTerm.test(t))return t;let s,a=this.data.resources.filter((a=>{if(s=LIB.itemByKey(this.data.resourceClasses,a.class),this.termClasses.includes(LIB.titleOf(s))&&(LIB.titleOf(s).toLowerCase().includes(e.toLowerCase())||["all","any"].includes(e))){let e=LIB.valuesByTitle(a,["SpecIF:LocalTerm","SpecIF:LocalTermPlural"],this.data);for(let s of e)for(var i of s)if(i.text.toLowerCase()==t.toLowerCase())return!0}return!1}));if(a.length>0)for(let e of this.eligibleLifecycleStatus)for(let s of a)if(this.valueByTitle(s,"SpecIF:TermStatus")==e){let e=this.valueByTitle(s,CONFIG.propClassTerm);return console.info("Global term assigned: "+t+" → "+e),e}return t}getPreferredTerm(e,t){if(t.startsWith("dcterms:"))return t;let s=this.getTermResources(e,t);if(s.length>0){let a=s[0];if("SpecIF:LifecycleStatusReleased"==this.valueByTitle(a,"SpecIF:TermStatus"))return t;let i=this.statementsByTitle(a,[this.synonymStatements.get(e)],{asSubject:!0,asObject:!0}).map((e=>LIB.itemById(this.data.resources,e.object.id==a.id?e.subject.id:e.object.id))).filter((e=>"SpecIF:LifecycleStatusReleased"==this.valueByTitle(e,"SpecIF:TermStatus")));if(i.length<1)return t;i.length>1&&console.warn("Multiple equivalent terms are released: ",i.map((e=>e.id)).toString());let r=this.valueByTitle(i[0],CONFIG.propClassTerm);return console.info("Preferred term assigned: "+t+" → "+r),r}return t}normalize(e,t){let s=this.globalize(e,t);return s=this.getPreferredTerm(e,s),s}getTermValue(e,t,s){let a=this.getTermResources(e,t);if(a.length>0)return this.valueByTitle(a[0],s)}propertyClassIsText(e){let t=this.getTermValue("propertyClass",e,"SpecIF:StringMaxLength");return null==t||"number"==typeof t&&t>CONFIG.textThreshold}propertyClassIsFormatted(e){return this.getTermValue("propertyClass",e,"SpecIF:TextFormat")==SpecifTextFormat.Xhtml}getIcon(e,t){return this.getTermValue(e,t,"SpecIF:Icon")}changeNamespace(e,t){let s=this;if(!t.targetNamespaces||t.targetNamespaces.length<1)return e;for(var a of t.targetNamespaces)if(e.startsWith(a))return e;let i=this.getTermResources("all",e);if(i.length>1&&console.warn("Multiple definitions of the term found: ",i.map((e=>e.id)).toString()),i.length>0){let a=i[0],r=function(e){let t=LIB.itemByKey(s.data.resourceClasses,e);for(let[e,a]of s.synonymStatements)if(t.title.toLowerCase().includes(e.toLowerCase()))return a;throw new Error("No synonymStatement found for '"+e.id+"'.")}(a.class),l=function(e,t){let a=[];for(var i of t)if(a=e.filter((e=>s.valueByTitle(e,CONFIG.propClassTerm).startsWith(i)&&["SpecIF:LifecycleStatusReleased","SpecIF:LifecycleStatusEquivalent"].includes(s.valueByTitle(e,"SpecIF:TermStatus")))),a.length>0)return a;return[]}(this.statementsByTitle(a,[r],{asSubject:!0,asObject:!0}).map((e=>LIB.itemById(this.data.resources,e.object.id==a.id?e.subject.id:e.object.id))),t.targetNamespaces);if(l.length<1)return e;l.length>1&&console.warn("Multiple equivalent terms have the desired namespace: ",l.map((e=>e.id)).toString());let n=this.valueByTitle(l[0],CONFIG.propClassTerm);return console.info("Term with desired namespace assigned: "+e+" → "+n),n}return e}makeTemplate(){return{"@Context":"http://purl.org/dc/terms/",id:"",$schema:"https://specif.de/v1.1/schema.json",title:[],generator:app.title,generatorVersion:CONFIG.appVersion,createdAt:(new Date).toISOString(),rights:{title:"Creative Commons 4.0 CC BY-SA",url:"https://creativecommons.org/licenses/by-sa/4.0/"},dataTypes:[],propertyClasses:[],resourceClasses:[],statementClasses:[],resources:[],statements:[],files:[],hierarchies:[]}}generateSpecifClasses(e){if(Array.isArray(e.domains)&&e.domains.length>0||Array.isArray(e.terms)&&e.terms.length>0){this.options=e;let t="P-SpecifClasses",s=(new Date).toISOString();for(Array.isArray(e.domains)&&e.domains.forEach((e=>{t+="-"+e.toCamelCase()})),this.required={sTL:[]},this.generated={dTL:[],pCL:[],rCL:[],sCL:[],rL:[],hL:[]},[{resultL:this.generated.pCL,classes:Array.from(this.primitiveDataTypes.keys()),fn:this.makePC.bind(this)},{resultL:this.generated.rCL,classes:["RC-SpecifTermresourceclass"],fn:this.makeRC.bind(this)},{resultL:this.generated.sCL,classes:["RC-SpecifTermstatementclass"],fn:this.makeSC.bind(this)}].forEach((e=>{LIB.cacheL(e.resultL,this.makeClasses(e.classes,e.fn))}));this.required.sTL.length>0;){let e=[].concat(this.required.sTL);this.required.sTL.length=0,LIB.cacheL(this.generated.sCL,e.map(this.makeSC.bind(this)))}if(this.options.domains&&this.options.domains.includes("SpecIF:DomainOntology")){let e="R-FolderOntology";this.generated.rL.push(LIB.itemByKey(this.data.resources,{id:e}));let t={id:LIB.replacePrefix(CONFIG.prefixN,e),resource:{id:e},nodes:[],changedAt:s};Array.from(this.termPrincipalClasses.values(),(e=>{this.generated.rL.push(LIB.itemByKey(this.data.resources,{id:e})),t.nodes.push({id:LIB.replacePrefix(CONFIG.prefixN,e),resource:{id:e},nodes:[],changedAt:s})})),this.generated.hL.push(t)}return Object.assign(e.delta?{}:this.makeTemplate(),{id:t,title:[{text:"SpecIF Classes"+(e.domains?" for "+e.domains.toString().replace(/:/g," "):""),format:SpecifTextFormat.Plain,language:"en"}],description:[{text:"A set of SpecIF Classes derived from a SpecIF Ontology"+(e.domains?" for the domain"+(e.domains.length<2?" ":"s ")+e.domains.toString().replace(/,/g,", ")+".":""),format:SpecifTextFormat.Plain,language:"en"}],dataTypes:this.generated.dTL,propertyClasses:this.generated.pCL,resourceClasses:this.generated.rCL,statementClasses:this.generated.sCL,resources:this.generated.rL,hierarchies:this.generated.hL})}return message.show("No domain or term specified, so no classes will be generated.",{severity:"warning"}),this.makeTemplate()}makeClasses(e,t){let s=this,a=[],i=LIB.referencedResourcesByClass(this.data.resources,this.data.hierarchies,e);if(i.length>0){let e=i.filter((function(e){let t=Object.assign({SpecIF_LifecycleStatusReleased:!0},s.options);return r(e)&&(a(e)||i(e));function a(e){if(Array.isArray(s.options.domains)){let t=LIB.valuesByTitle(e,[CONFIG.propClassDomain],s.data);for(let e of t)if(s.options.domains.includes(LIB.displayValueOf(e,{targetLanguage:"default"})))return!0}return!1}function i(e){if(Array.isArray(s.options.terms)){let t=LIB.valuesByTitle(e,[CONFIG.propClassTerm],s.data);if(t.length>0&&s.options.terms.includes(LIB.displayValueOf(t[0],{targetLanguage:"default"})))return!0}return!1}function r(e){let a=LIB.valuesByTitle(e,["SpecIF:TermStatus"],s.data);for(let e of a)if(t[LIB.displayValueOf(e,{targetLanguage:"default"}).toJsId()])return!0;return!1}}));a=LIB.forAll(e,t)}return a}makeDT(e){let t=this,s=this.primitiveDataTypes.get(e.class.id),a=this.makeIdAndTitle(e,CONFIG.prefixPC),i=LIB.replacePrefix(CONFIG.prefixDT,a.id),r=LIB.replacePrefix(CONFIG.prefixV,a.id),l=this.statementsByTitle(e,["SpecIF:hasEnumValue"],{asSubject:!0}).map((e=>LIB.itemById(this.data.resources,e.object.id))),n=LIB.forAll(l,((e,t)=>{let s=LIB.valuesByTitle(e,[CONFIG.propClassTerm],this.data);if(s.length>0)return{id:this.valueByTitle(e,CONFIG.propClassId)||r+"-"+t.toString(),value:s[0]};console.warn("Property value term '"+e.id+"' is undefined")})),o={};switch(s){case XsDataType.String:let t=this.valueByTitle(e,"SpecIF:StringMaxLength");o={id:"DT-String"+(t?"-LE"+t:""),title:"String"+(t?" <="+t:""),description:[{text:"Text string"+(n.length>0?" with enumerated values for "+a.title:t?" with maximum length "+t:"")}],maxLength:t?parseInt(t):void 0};break;case XsDataType.Boolean:o={id:"DT-Boolean",title:"Boolean Value",description:[{text:"A Boolean value."}]};break;case XsDataType.Integer:let s=this.valueByTitle(e,"SpecIF:IntegerMaxInclusive"),i=this.valueByTitle(e,"SpecIF:IntegerMinInclusive");o={id:"DT-Integer"+(i?"-GE"+i:"")+(s?"-LE"+s:""),title:"Integer Value"+(i?" >="+i:"")+(s?" <="+s:""),description:[{text:"A numerical integer value"+(i&&s?" with minimum value "+i+" and maximum value "+s:i?" with minimum value "+i:s?" with maximum value "+s:"")+"."}],minInclusive:i?parseInt(i):void 0,maxInclusive:s?parseInt(s):void 0};break;case XsDataType.Double:let r=this.valueByTitle(e,"SpecIF:RealFractionDigits"),l=this.valueByTitle(e,"SpecIF:RealMaxInclusive"),c=this.valueByTitle(e,"SpecIF:RealMinInclusive");o={id:"DT-Real"+(c?"-GE"+c:"")+(l?"-LE"+l:"")+(r?"-FD"+r:""),title:"Real Value"+(c?" >="+c:"")+(l?" <="+l:"")+(r?" "+r+"digits":""),description:[{text:"A numerical floating point number (double precision)"+(c&&l?" with minimum value "+c+" and maximum value "+l:c?" with minimum value "+c:l?" with maximum value "+l:"")+(r?" having no more than "+r+" digits":"")+"."}],minInclusive:c?parseFloat(c):void 0,maxInclusive:l?parseFloat(l):void 0,fractionDigits:r?parseInt(r):void 0};break;case XsDataType.DateTime:o={id:"DT-DateTime",title:"Date/Time",description:[{text:"Date or timestamp in ISO-8601 format."}]};break;case XsDataType.Duration:o={id:"DT-Duration",title:"Duration",description:[{text:"A duration as defined by the ISO 8601 ABNF for 'duration'."}]};break;case XsDataType.AnyURI:o={id:"DT-AnyURI",title:"Universal Resource Identifier (URI)",description:[{text:"A universal resource identifier (URI), according to RFC3986."}]}}return o.type=s,n.length>0&&(o.id=i,o.title=a.title,o.enumeration=n),o.revision=this.valueByTitle(e,"SpecIF:Revision")||e.revision,o.changedAt=e.changedAt,this.options.adoptOntologyDataTypes&&(o=function(e){for(let s of t.data.dataTypes)if(LIB.equalDT(e,s))return s}(o)||o),LIB.cacheE(this.generated.dTL,o),o}makePC(e){let t=this.makeDT(e),s=LIB.valuesByTitle(e,this.termDefaultValues,this.data);return Object.assign(this.makeItem(e,CONFIG.prefixPC),{dataType:this.options.referencesWithoutRevision?LIB.makeKey(t.id):LIB.makeKey(t),format:this.valueByTitle(e,"SpecIF:TextFormat"),multiple:!!LIB.isTrue(this.valueByTitle(e,"SpecIF:multiple"))||void 0,values:s.length>0&&(t.type!=XsDataType.Boolean||"true"==s[0])?s:void 0})}propertyClassesOf(e){let t=[],s=this.statementsByTitle(e,["SpecIF:hasProperty"],{asSubject:!0});for(let e of s){let s=LIB.itemByKey(this.data.resources,e.object),a=this.makeIdAndTitle(s,CONFIG.prefixPC);LIB.cacheE(t,{id:a.id}),LIB.cacheE(this.generated.pCL,this.makePC(s))}return t}makeRC(e){let t=LIB.valuesByTitle(e,["SpecIF:Instantiation"],this.data),s=this.propertyClassesOf(e);return Object.assign(this.makeItem(e,CONFIG.prefixRC),{extends:this.extendingClassOf(e,CONFIG.prefixRC),instantiation:t.map((e=>LIB.displayValueOf(e,{targetLanguage:"default"}))),isHeading:!!LIB.isTrue(this.valueByTitle(e,"SpecIF:isHeading"))||void 0,icon:this.valueByTitle(e,"SpecIF:Icon"),propertyClasses:s.length>0?s:void 0})}eligibleClassesOf(e,t){let s=[],a=this.statementsByTitle(e,t,{asObject:!0});for(let e of a){let t=LIB.itemByKey(this.data.resources,e.subject),a=this.makeIdAndTitle(t,"RC-SpecifTermresourceclass"==t.class.id?CONFIG.prefixRC:CONFIG.prefixSC);LIB.cacheE(s,{id:a.id}),this.options.excludeEligibleSubjectClassesAndObjectClasses||("RC-SpecifTermresourceclass"==t.class.id?LIB.indexById(this.generated.rCL,a.id)<0&&LIB.cacheE(this.generated.rCL,this.makeRC(t)):LIB.indexById(this.generated.sCL,a.id)<0&&LIB.cacheE(this.required.sTL,t))}return s}makeSC(e){let t=LIB.valuesByTitle(e,["SpecIF:Instantiation"],this.data),s=this.propertyClassesOf(e),a=this.eligibleClassesOf(e,["SpecIF:isEligibleAsSubject"]),i=this.eligibleClassesOf(e,["SpecIF:isEligibleAsObject"]);return Object.assign(this.makeItem(e,CONFIG.prefixSC),{extends:this.extendingClassOf(e,CONFIG.prefixSC),instantiation:t.map((e=>LIB.displayValueOf(e,{targetLanguage:"default"}))),isUndirected:!!LIB.isTrue(this.valueByTitle(e,"SpecIF:isUndirected"))||void 0,icon:this.valueByTitle(e,"SpecIF:Icon"),subjectClasses:a.length>0?a:void 0,objectClasses:i.length>0?i:void 0,propertyClasses:s.length>0?s:void 0})}extendingClassOf(e,t){if([CONFIG.prefixRC,CONFIG.prefixSC].includes(t)){let s=this.statementsByTitle(e,t==CONFIG.prefixRC?["SpecIF:isSpecializationOfResource"]:["SpecIF:isSpecializationOfStatement"],{asSubject:!0});if(s.length>1&&(console.warn("Term "+e.id+" has more than one extended class; the first found prevails."),s.length=1),s.length>0){let e=LIB.itemByKey(this.data.resources,s[0].object),a=this.makeIdAndTitle(e,t);switch(t){case CONFIG.prefixRC:LIB.cacheE(this.generated.rCL,this.makeRC(e));break;case CONFIG.prefixSC:LIB.cacheE(this.generated.sCL,this.makeSC(e))}return LIB.makeKey(a.id)}}}makeItem(e,t){let s,a=this.makeIdAndTitle(e,t),i=LIB.valuesByTitle(e,[CONFIG.propClassDesc],this.data);return i.length>1&&console.info("Only the fist value of the description property will be used for the class generated from "+e.id+" with title "+a.title+"."),i.length>0&&(s=i[0],s.format=LIB.isHTML(s.text)?SpecifTextFormat.Xhtml:SpecifTextFormat.Plain),{id:a.id,revision:this.valueByTitle(e,"SpecIF:Revision")||e.revision,title:a.title,description:s,changedAt:e.changedAt}}checkConstraintsOntology(){return!0}statementsByTitle(e,t,s){return this.data.statements.filter((a=>t.includes(LIB.classTitleOf(a.class,this.data.statementClasses))&&(s.asSubject&&a.subject.id==e.id||s.asObject&&a.object.id==e.id)))}valueByTitle(e,t){return LIB.valueByTitle(e,t,this.data)}distinctiveCoreOf(e){return e.toCamelCase()}makeIdAndTitle(e,t){const s="PC-SpecifTerm";let a=LIB.valuesByTitle(e,["dcterms:identifier"],this.data),i=LIB.itemBy(e.properties,"class",{id:s});if(i&&i.values.length>0){let e=LIB.languageTextOf(i.values[0],{targetLanguage:"default"});return{id:a&&a.length>0?LIB.languageTextOf(a[0],{targetLanguage:"default"}).toSpecifId():t+this.distinctiveCoreOf(e),title:e}}console.error("No item with id '"+s+"' found in the Ontology or it has no value")}getModelElementClasses(){let e=this.getTermResources("resourceClass","SpecIF:ModelElement"),t=[];return e.length>0&&(t=this.statementsByTitle(e[0],["SpecIF:isSpecializationOfResource"],{asObject:!0}).map((e=>{let t=LIB.itemByKey(this.data.resources,e.subject);return this.valueByTitle(t,CONFIG.propClassTerm)}))),["SpecIF:ModelElement"].concat(t)}getHeadings(){return this.data.resources.filter((e=>"SpecIF:TermResourceClass"==LIB.classTitleOf(e.class,this.data.resourceClasses)&&LIB.isTrue(this.valueByTitle(e,"SpecIF:isHeading")))).map((e=>this.valueByTitle(e,CONFIG.propClassTerm)))}getNamespaces(){let e=new Map;return this.data.resources.filter((e=>"SpecIF:Namespace"==LIB.classTitleOf(e.class,this.data.resourceClasses))).forEach((t=>{e.set(this.valueByTitle(t,CONFIG.propClassTerm),{id:t.id,url:this.valueByTitle(t,"SpecIF:Origin")})})),e}makeStatementsIsNamespace(){let e=LIB.itemBy(this.data.statementClasses,"title","SpecIF:isNamespace");if(e){for(var t=this.data.statements.length-1;t>-1;t--)"SpecIF:isNamespace"==LIB.classTitleOf(this.data.statements[t].class,this.data.statementClasses)&&this.data.statements.splice(t,1);let a=(new Date).toISOString();for(var s of this.data.resources)if(this.termClasses.includes(LIB.classTitleOf(s.class,this.data.resourceClasses))){let t=this.valueByTitle(s,CONFIG.propClassTerm),i=RE.splitVocabularyTerm.exec(t);if(Array.isArray(i)&&i[1]){let t=LIB.makeKey(e),r=!0;for(let[e,l]of this.namespaces)if(i[1]==e){this.data.statements.push({id:LIB.genID(CONFIG.prefixS),changedAt:a,class:t,subject:LIB.makeKey(l.id),object:LIB.makeKey(s)}),r=!1;break}r&&console.warn("No namespace found for "+s.id)}else console.warn("No namespace given for "+s.id)}}else console.warn("No statementClass 'SpecIF:isNamespace' defined")}}